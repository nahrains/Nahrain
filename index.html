<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اعدادية النهرين المهنية - المستقبل يبدأ هنا</title>

    <!-- Mobile Web App Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="اعدادية النهرين">

    <!-- Open Graph / Social Sharing (WhatsApp, Telegram, Facebook) -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://al-nahrain-school.web.app/">
    <meta property="og:title" content="اعدادية النهرين المهنية للبنين">
    <meta property="og:description"
        content="اقسامنا: الأمن السيبراني (علوم) | تكرير النفط | الأجهزة الطبية. المستقبل يبدأ هنا.">
    <meta property="og:image" content="https://al-nahrain-school.web.app/logo.jpg">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="اعدادية النهرين المهنية">
    <meta name="twitter:description" content="منصة التعليم الإلكتروني وسجل الدرجات.">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FIREBASE SDKs (Cloud & Auth) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FIREBASE CONFIGURATION (REQUIRED FOR CLOUD FEATURES) -->
    <!-- FIREBASE CONFIGURATION -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBWtURZAw5Kja8S6bHuQyimuhMMX4fZOco",
            authDomain: "al-nahrain-school-1d9f6.firebaseapp.com",
            projectId: "al-nahrain-school-1d9f6",
            storageBucket: "al-nahrain-school-1d9f6.firebasestorage.app",
            messagingSenderId: "119716570818",
            appId: "1:119716570818:web:aa200d98166a5a964f3d5b",
            measurementId: "G-7S4P4T68K5",
            databaseURL: "https://al-nahrain-school-1d9f6-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log("✅ Firebase Initialized (Live)");
        }
    </script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f2ff">
    <link rel="apple-touch-icon" href="logo.jpg">
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #271242;
            --dark-bg: #050505;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-strong: rgba(20, 20, 30, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-glow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        /* FORCE HIDE LEGACY STAFF UI */
        #btn-mode-staff,
        #btn-mode-student,
        #reg-staff-opts,
        .reg-role-toggle {
            display: none !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) var(--dark-bg);
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--dark-bg);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- PRELOADER (BOOT SEQUENCE) --- */
        #boot-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: monospace;
            color: var(--primary);
            direction: ltr;
        }

        .boot-log {
            font-size: 1rem;
            margin-bottom: 5px;
            opacity: 0;
        }

        .boot-progress {
            width: 300px;
            height: 4px;
            background: #333;
            margin-top: 20px;
            border-radius: 2px;
            overflow: hidden;
        }

        .boot-bar {
            width: 0%;
            height: 100%;
            background: var(--primary);
            transition: width 0.2s;
            box-shadow: 0 0 10px var(--primary);
        }

        /* --- Dynamic Background & UI --- */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at center, #0a0a20 0%, #000000 100%);
        }

        .cursor-glow {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(0, 242, 255, 0.15) 0%, transparent 70%);
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            mix-blend-mode: screen;
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* --- News Ticker --- */
        .news-ticker {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid var(--primary);
            padding: 10px 0;
            z-index: 9998;
            display: flex;
            align-items: center;
        }

        .ticker-label {
            background: var(--primary);
            color: #000;
            padding: 5px 15px;
            font-weight: bold;
            margin: 0 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px var(--primary);
            white-space: nowrap;
        }

        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }

        .ticker-content {
            display: inline-block;
            animation: ticker 30s linear infinite;
            color: #ddd;
        }

        .ticker-item {
            margin-left: 50px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .ticker-item i {
            color: var(--secondary);
        }

        @keyframes ticker {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* --- Typography & Titles --- */
        h1,
        h2,
        h3,
        h4 {
            color: #fff;
        }

        .section-title {
            text-align: center;
            margin: 80px 0 50px;
            position: relative;
        }

        .section-title h2 {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, #fff 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .section-title p {
            color: #aaa;
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* --- Glitch Text --- */
        .glitch-text {
            position: relative;
        }

        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
        }

        .glitch-text::before {
            left: 2px;
            text-shadow: -1px 0 var(--secondary);
            clip: rect(24px, 550px, 90px, 0);
            animation: glitch-anim-2 3s infinite linear alternate-reverse;
        }

        .glitch-text::after {
            left: -2px;
            text-shadow: -1px 0 var(--primary);
            clip: rect(85px, 550px, 140px, 0);
            animation: glitch-anim 2.5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% {
                clip: rect(10px, 9999px, 31px, 0);
            }

            100% {
                clip: rect(30px, 9999px, 80px, 0);
            }
        }

        @keyframes glitch-anim-2 {
            0% {
                clip: rect(95px, 9999px, 10px, 0);
            }

            100% {
                clip: rect(40px, 9999px, 90px, 0);
            }
        }

        /* --- Navigation --- */
        nav {
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 1400px;
            z-index: 1000;
            background: var(--glass-strong);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            backdrop-filter: blur(20px);
        }

        .logo img {
            height: 50px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-items {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            color: #ccc;
            text-decoration: none;
            font-weight: 600;
            transition: 0.3s;
            font-size: 1rem;
        }

        .nav-link:hover {
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary);
        }

        .btn-glow {
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            color: #fff;
            padding: 10px 25px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(112, 0, 255, 0.4);
            transition: 0.3s;
            border: none;
            cursor: pointer;
            display: inline-block;
        }

        .btn-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.6);
        }

        /* --- Sections --- */
        .hero {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            padding-top: 80px;
        }

        .hero-content h1 {
            font-size: 4.5rem;
            line-height: 1.2;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .hero-content p {
            font-size: 1.5rem;
            color: #ddd;
            margin-bottom: 40px;
            font-weight: 300;
        }

        .floating-badge {
            display: inline-block;
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid var(--primary);
            padding: 8px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: -50px;
            position: relative;
            z-index: 10;
        }

        .stat-card {
            background: var(--glass-strong);
            padding: 30px;
            text-align: center;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            transition: 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-10px);
            border-color: var(--primary);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary);
            display: block;
        }

        .vision-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .vision-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 40px;
            border-radius: 20px;
            border-right: 3px solid var(--secondary);
            transition: 0.3s;
        }

        .vision-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary);
        }

        .card-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .cards-grid-small {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .spec-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid var(--glass-border);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: 0.4s;
            cursor: pointer;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .spec-card:hover {
            border-color: var(--secondary);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .spec-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: inline-block;
            animation: float-icon 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.3));
            transition: transform 0.3s;
        }

        @keyframes float-icon {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .spec-card:hover .spec-icon {
            transform: scale(1.3) translateZ(20px);
            filter: drop-shadow(0 0 20px var(--primary));
        }

        .spec-card h4 {
            font-size: 1.2rem;
            margin-top: 10px;
            transform: translateZ(10px);
        }

        #portals {
            padding: 100px 0;
            background: linear-gradient(to bottom, transparent, rgba(0, 242, 255, 0.05), transparent);
        }

        .portal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 50px;
        }

        .portal-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .portal-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.15);
        }

        .portal-card h3 {
            font-size: 1.5rem;
            margin: 15px 0;
        }

        /* --- Dashboard & Login Overlays --- */
        .dashboard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            padding: 50px 20px 150px 20px;
            overflow-y: auto;
            display: none;
            backdrop-filter: blur(10px);
        }

        .dashboard-overlay.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .close-dash {
            position: absolute;
            top: 30px;
            left: 30px;
            font-size: 2rem;
            color: #fff;
            cursor: pointer;
            transition: 0.3s;
        }

        .close-dash:hover {
            color: var(--primary);
            transform: rotate(90deg);
        }

        /* Login Screen Styles */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .auth-box {
            background: var(--glass-strong);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--primary);
            width: 400px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.2);
        }

        .auth-box h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .auth-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary);
            color: #fff;
            border-radius: 5px;
            outline: none;
            font-family: 'Cairo';
            text-align: center;
            font-size: 1.2rem;
        }

        /* --- CUSTOM MODERN ALERTS --- */
        /* --- PREMIUM CYBER POPUP SYSTEM --- */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            z-index: 1000000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .custom-modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .custom-modal-box {
            background: linear-gradient(145deg, rgba(30, 30, 45, 0.9), rgba(10, 10, 15, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 229, 255, 0.1);
            padding: 35px;
            border-radius: 24px;
            text-align: center;
            width: 90%;
            max-width: 420px;
            transform: scale(0.9) translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            font-family: 'Tajawal', 'Cairo', sans-serif;
        }

        .custom-modal-overlay.active .custom-modal-box {
            transform: scale(1) translateY(0);
        }

        .modal-icon-container {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.05);
        }

        .modal-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 12px;
            color: #fff;
            letter-spacing: -0.5px;
        }

        .modal-msg {
            color: #aaa;
            margin-bottom: 25px;
            line-height: 1.7;
            font-size: 1rem;
        }

        .modal-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 20px;
            color: #fff;
            margin-bottom: 25px;
            outline: none;
            transition: 0.3s;
            text-align: center;
            font-size: 1.1rem;
            font-family: inherit;
        }

        .modal-input:focus {
            border-color: #00e5ff;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .modal-btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .m-btn {
            flex: 1;
            padding: 12px 25px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .m-btn-primary {
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
        }

        .m-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 210, 255, 0.4);
        }

        .m-btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .m-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .auth-box button {
            width: 100%;
        }

        /* --- Tables & Inputs --- */
        .cyber-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            margin-top: 20px;
        }

        .cyber-table th {
            text-align: right;
            padding: 15px;
            color: #888;
        }

        .cyber-table td {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Gradebook Styles */
        .gradebook-table th,
        .gradebook-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            font-size: 0.9rem;
            color: #000;
        }

        .gradebook-table th {
            background: #d0e0e3;
            font-weight: bold;
        }

        .gradebook-table input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-family: 'Cairo';
            color: #000;
        }

        .gradebook-table input:focus {
            background: #ffffcc;
            outline: none;
        }

        .cyber-table td:first-child {
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0 10px 10px 0;
        }

        .cyber-table td:last-child {
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px 0 0 10px;
        }

        .grade-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .grade-good {
            color: #0f0;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #0f0;
        }

        .cyber-input {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(145deg, rgba(20, 20, 35, 0.8), rgba(35, 35, 50, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 14px;
            margin-bottom: 20px;
            font-family: 'Tajawal', 'Cairo', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-size: 1rem;
        }

        .cyber-input:focus,
        .cyber-input:hover {
            border-color: #00e5ff;
            background: rgba(40, 40, 60, 0.9);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.15);
            transform: translateY(-1px);
        }

        /* PREMIUM SELECT STYLING */
        select.cyber-input {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2300e5ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: 18px;
            padding-left: 45px;
        }

        select.cyber-input option {
            background: #1a1a2e;
            color: #fff;
            padding: 15px;
            font-family: inherit;
        }

        ::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        textarea.cyber-input {
            min-height: 120px;
            resize: vertical;
        }

        input[type="date"].cyber-input {
            position: relative;
        }

        input[type="date"].cyber-input::-webkit-calendar-picker-indicator {
            filter: invert(0.8) sepia(100%) saturate(500%) hue-rotate(150deg);
            opacity: 0.7;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }


        .ai-msg {
            background: rgba(0, 242, 255, 0.1);
            padding: 12px;
            border-radius: 15px 15px 2px 15px;
            align-self: flex-end;
            color: #fff;
            border: 1px solid rgba(0, 242, 255, 0.2);
            max-width: 90%;
            font-size: 0.9rem;
            direction: rtl;
        }

        .user-msg {
            background: rgba(112, 0, 255, 0.2);
            border-radius: 15px 15px 15px 2px;
            align-self: flex-start;
            border: 1px solid rgba(112, 0, 255, 0.3);
        }

        .ai-suggestions {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }

        .ai-suggestions button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--primary);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.8rem;
        }

        .ai-suggestions button:hover {
            background: var(--primary);
            color: #000;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                text-shadow: 0 0 10px var(--secondary);
            }

            50% {
                transform: scale(1.1);
                text-shadow: 0 0 20px var(--secondary);
            }

            100% {
                transform: scale(1);
                text-shadow: 0 0 10px var(--secondary);
            }
        }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }

            .hero {
                flex-direction: column;
                height: auto;
                padding-top: 140px;
                padding-bottom: 50px;
                text-align: center;
            }

            nav {
                padding: 10px 15px !important;
                top: 10px !important;
                width: 98% !important;
            }

            .nav-items {
                display: none !important;
            }

            #apply-fab {
                position: fixed !important;
                bottom: 20px !important;
                left: 20px !important;
                top: auto !important;
                z-index: 9999 !important;
                transform: scale(0.9);
            }

            .hero-content {
                width: 100%;
                padding: 0 20px;
                margin-bottom: 40px;
            }

            .hero-content h1 {
                font-size: 2.5rem;
                line-height: 1.2;
            }

            .login-sidebar {
                width: 90%;
                max-width: 400px;
            }

            /* Stack All Grids */
            .vision-grid,
            .portal-grid,
            .container[style*="grid"] {
                grid-template-columns: 1fr !important;
                gap: 20px;
                padding: 0 20px;
            }

            /* Adjust Spacing */
            section {
                padding-top: 60px !important;
                padding-bottom: 60px !important;
                margin-top: 50px !important;
            }


            /* Fix Tables Overflow */
            div[class*="glass-panel"] {
                overflow-x: hidden;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #student-dash,
            #student-dash * {
                visibility: visible;
            }

            #student-dash {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white !important;
                color: black !important;
            }

            .close-dash,
            .action-btn,
            .btn-glow {
                display: none !important;
            }

            .dashboard-overlay {
                background: white !important;
                z-index: 99999;
            }

            .glass-panel {
                border: 1px solid black;
                box-shadow: none;
                background: white;
                color: black;
            }

            h1,
            h2,
            h3,
            h4,
            p,
            span,
            td,
            th {
                color: black !important;
                text-shadow: none !important;
            }
        }


        /* === MOBILE RESPONSIVENESS FIXES (OVERRIDE) === */

        /* 1. Enable Vertical Scroll for Modals (Fix Keyboard Overlay) */
        .dashboard-overlay {
            align-items: flex-start !important;
            /* Allow top scrolling */
            padding-top: 20px;
            padding-bottom: 50px;
        }

        /* 2. Enable Horizontal Scroll for Tables (Fix Table Cutoff) */
        .table-wrapper,
        .glass-panel>div[style*="overflow-x"] {
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            display: block;
        }

        /* 3. Mobile Specific Adjustments */
        @media (max-width: 768px) {
            .container {
                width: 95% !important;
                padding: 10px;
            }

            .glass-panel {
                padding: 15px !important;
            }

            /* Input Fields: Prevent Zoom & improve touch area */
            .cyber-input {
                font-size: 16px !important;
                /* Prevents iOS Zoom */
                padding: 12px !important;
                margin-bottom: 10px !important;
            }

            /* Buttons */
            .btn-glow {
                padding: 12px 20px !important;
                font-size: 1rem !important;
                width: 100%;
                /* Full width buttons on mobile */
                margin-bottom: 10px;
            }

            /* Tabs stacking */
            .tabs {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }

            .tabs button {
                width: 48% !important;
                /* 2 cols */
                font-size: 0.8rem !important;
            }

            /* Table Fonts */
            th,
            td {
                padding: 8px 5px !important;
                font-size: 0.85rem !important;
                white-space: nowrap;
                /* Keep rows single line, scroll horizontal */
            }
        }


        /* CINEMATIC BOOT SCREEN STYLES */
        .cyber-grid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background-image:
                linear-gradient(rgba(0, 242, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg) translateY(0);
            animation: grid-move 20s linear infinite;
            opacity: 0.3;
        }

        /* RESTORED TYPOGRAPHY & LAYOUT */
        .boot-title {
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-weight: 900;
            font-size: 2.2rem;
            margin-bottom: 5px;
            letter-spacing: 0;
            text-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
        }

        .boot-subtitle {
            color: var(--primary);
            font-size: 0.9rem;
            letter-spacing: 5px;
            margin-bottom: 30px;
            font-weight: 300;
            opacity: 0.8;
        }

        .loader-line-container {
            width: 250px;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0 auto;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .loader-line-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            box-shadow: 0 0 10px var(--primary);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* RESTORED ANIMATION CLASSES */
        .doors-open-left {
            transform: translateX(-100%);
        }

        .doors-open-right {
            transform: translateX(100%);
        }

        @keyframes pulse-glow {
            0% {
                opacity: 0.3;
                transform: translateX(-50%) scale(1);
            }

            100% {
                opacity: 0.7;
                transform: translateX(-50%) scale(1.2);
            }
        }
    </style>
</head>

<body>
    <!-- Boot Screen -->
    <!-- ANTIGRAVITY-INSPIRED BOOT SCREEN -->
    <div id="boot-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:#050505; z-index:100000; overflow:hidden; display:flex; flex-direction:column; justify-content:center; align-items:center;">

        <!-- Interactive Particle Background -->
        <canvas id="particle-canvas"
            style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:0;"></canvas>

        <div class="tech-container"
            style="position:relative; z-index:10; text-align:center; width: 100%; max-width: 500px;">

            <!-- Logo REMOVED -->

            <!-- New Cinematic Slogan -->
            <div style="height: 60px; display: flex; align-items: center; justify-content: center; margin-top: 0;">
                <h1 id="slogan-text"
                    style="color:#fff; font-family:'Cairo', sans-serif; font-weight:800; font-size:2.5rem; text-shadow: 0 0 30px rgba(0,242,255,0.8); direction: rtl;">
                </h1>
                <span class="cursor-blink"
                    style="display:inline-block; width:5px; height:40px; background:var(--primary); margin-right:15px;"></span>
            </div>

        </div>
    </div>
    <!-- ROBUST INLINE BOOT SCRIPT (Executes Immediately) -->
    <script>
        (function () {
            var s = document.getElementById('slogan-text');
            var b = document.getElementById('boot-screen');
            if (s && b) {
                // Determine text (fallback if encoding fails)
                var t = "هنا النهرين ... هنا المستقبل";
                var i = 0;
                s.innerHTML = ""; // Ensure empty start

                // Backup Failsafe: If typing doesn't start or finish, show content anyway after 2s
                var failsafe = setTimeout(function () {
                    if (s.innerHTML.length < 5) s.innerHTML = t;
                    finishBoot();
                }, 4000); // 4s absolute max

                function finishBoot() {
                    clearTimeout(failsafe);
                    b.style.transition = "opacity 0.8s ease, transform 0.8s ease";
                    b.style.opacity = "0";
                    b.style.transform = "scale(1.1)";
                    setTimeout(function () { b.style.display = "none"; }, 800);
                }

                function type() {
                    if (i < t.length) {
                        s.innerHTML += t.charAt(i);
                        i++;
                        setTimeout(type, 40); // Fast typing
                    } else {
                        setTimeout(finishBoot, 1000); // Wait 1s then close
                    }
                }

                // Start almost immediately
                setTimeout(type, 100);
            }
        })();
    </script>



    <!-- Canvas BG -->
    <div id="canvas-container"><canvas id="bgCanvas"></canvas></div>
    <!-- Cursor Glow -->
    <div class="cursor-glow" id="cursorGlow"></div>

    <!-- ISOLATED APPLY BUTTON -->
    <!-- ISOLATED APPLY BUTTON -->
    <a id="apply-fab" href="#admission-section"
        style="position: absolute; top: 110px; left: 20px; z-index: 900; cursor: pointer; text-decoration: none;">
        <div class="glass-panel"
            style="padding: 10px 20px; border: 1px solid var(--secondary); display: flex; align-items: center; gap: 10px; transition: 0.3s; background: rgba(0,0,0,0.95); box-shadow: 0 0 15px rgba(0,242,255,0.3); border-radius: 12px;">
            <i class="fa-solid fa-file-signature"
                style="color: var(--secondary); font-size: 1.8rem; animation: pulse 2s infinite;"></i>
            <div style="text-align: right;">
                <span style="display: block; color: #fff; font-weight: bold; font-size: 0.9rem;">تقديم طلب انتساب</span>
                <span style="display: block; color: #aaa; font-size: 0.7rem;">للعام الدراسي الجديد</span>
            </div>
        </div>
    </a>

    <!-- Navigation -->
    <nav>
        <div class="logo">
            <img src="logo.jpg" alt="شعار المدرسة">
        </div>
        <div class="nav-items">
            <a href="#hero" class="nav-link">الرئيسية</a>
            <a href="#about" class="nav-link">عن المدرسة</a>
            <a href="#specs" class="nav-link">التخصصات</a>
            <a href="#facilities" class="nav-link">المرافق</a>
            <a href="#contact" class="nav-link">تواصل معنا</a>
        </div>
        <a href="#portals" class="btn-glow">تسجيل الدخول للنظام</a>
    </nav>

    <!-- Hero Section -->
    <section class="hero" id="hero" style="position: relative;">
        <div class="container"
            style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; height: 100%; gap: 100px;">

            <!-- Content (Right) -->
            <div class="hero-content" style="text-align: right; max-width: 600px; padding-top: 50px;">
                <div class="floating-badge">🎓 عام دراسي 2025-2026</div>
                <h1 class="glitch-text" style="font-size: 3.5rem;" data-text="اعدادية النهرين المهنية">اعدادية النهرين
                    المهنية<br><span style="color: var(--primary);">حيث يُصنع المستقبل</span></h1>
                <p style="font-size: 1.2rem;">11 تخصصاً مهنياً متطوراً يجمع بين العلم والتطبيق لبناء جيل من القادة
                    المهنيين</p>
                <div style="display: flex; gap: 20px; justify-content: flex-start;">
                    <a href="#specs" class="btn-glow"
                        style="background: transparent; border: 1px solid var(--primary);">استكشف التخصصات</a>
                </div>
            </div>

            <!-- Login Side (Left) -->
            <div class="auth-box"
                style="margin-top: 50px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); width: 350px;">
                <h2 style="font-size: 1.5rem;"><i class="fa-solid fa-laptop-code"></i> المنصة الإلكترونية</h2>
                <p style="color:#ccc; margin-bottom: 20px; font-size: 0.9rem;">سجّل دخولك للوصول للخدمات</p>

                <div class="auth-card" style="text-align: center;">
                    <i class="fa-solid fa-school-flag"
                        style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                    <h3 style="margin-bottom: 20px;">بوابة المدرسة الذكية</h3>
                    <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">سجل دخولك أو أنشئ حساباً جديداً للوصول
                        للخدمات</p>

                    <button class="btn-glow" onclick="requestLogin('student')" style="width: 100%;">تسجيل الدخول / إنشاء
                        حساب</button>
                </div>

            </div>

        </div>
    </section>

    <!-- Stats Section -->
    <section class="container" style="margin-bottom: 80px;">
        <div class="stats-grid">
            <div class="stat-card"><span class="stat-number" data-target="2025">0</span><span>سنة التأسيس</span></div>
            <div class="stat-card"><span class="stat-number" data-target="650" data-prefix="+">0</span><span>طالب
                    وطالبة</span></div>
            <div class="stat-card"><span class="stat-number" data-target="11">0</span><span>تخصص مهني</span></div>
            <div class="stat-card"><span class="stat-number" data-target="30" data-prefix="+">0</span><span>كادر
                    تدريسي</span></div>
        </div>
    </section>

    <!-- Vision Section -->
    <section class="container" id="about">
        <div class="section-title">
            <h2>رؤيتنا ورسالتنا</h2>
            <p>نسعى لتقديم تعليم مهني استثنائي يواكب التطور العالمي</p>
        </div>
        <div class="vision-grid">
            <div class="vision-card">
                <i class="fa-solid fa-eye card-icon"></i>
                <h3>رؤيتنا</h3>
                <p style="color: #ccc; line-height: 1.8; margin-top: 15px;">أن نكون المؤسسة التعليمية المهنية الرائدة،
                    ونموذجاً يحتذى به في التعليم المهني المتميز الذي يواكب أحدث المعايير العالمية ويلبي متطلبات سوق
                    العمل.</p>
            </div>
            <div class="vision-card">
                <i class="fa-solid fa-bullseye card-icon"></i>
                <h3>رسالتنا</h3>
                <p style="color: #ccc; line-height: 1.8; margin-top: 15px;">تقديم تعليم مهني شامل ومتطور يجمع بين
                    المعرفة النظرية الرصينة والمهارات العملية المتقدمة لإعداد كوادر متميزة قادرة على الإبداع.</p>
            </div>
        </div>
    </section>

    <!-- Specializations -->
    <section class="container" id="specs">
        <div class="section-title">
            <h2>التخصصات المتاحة</h2>
            <p>اختر التخصص الذي يناسب شغفك ويحقق طموحاتك</p>
        </div>
        <div class="cards-grid-small">
            <div class="spec-card">
                <div class="spec-icon">🤖</div>
                <h4>الذكاء الاصطناعي</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">🔒</div>
                <h4>الأمن السيبراني</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">🏥</div>
                <h4>الأجهزة الطبية</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">⛽</div>
                <h4>تكرير النفط والغاز</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">🏗️</div>
                <h4>البناء والإنشاءات</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">💼</div>
                <h4>المحاسبة</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">🏦</div>
                <h4>العلوم المصرفية</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">📊</div>
                <h4>الإدارة</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">🎨</div>
                <h4>الفنون التطبيقية</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">💻</div>
                <h4>صيانة الحاسبات</h4>
            </div>
            <div class="spec-card">
                <div class="spec-icon">⚽</div>
                <h4>الرياضة</h4>
            </div>
        </div>
    </section>

    <!-- Facilities -->
    <section class="container" id="facilities">
        <div class="section-title">
            <h2>مرافقنا المتطورة</h2>
        </div>
        <div class="vision-grid">
            <div class="vision-card" style="border-right-color: var(--primary);">
                <i class="fa-solid fa-flask card-icon"></i>
                <h3>مختبرات علمية</h3>
                <p>مجهزة بأحدث الأجهزة والمعدات العلمية للتجارب العملية المتقدمة.</p>
            </div>
            <div class="vision-card" style="border-right-color: var(--primary);">
                <i class="fa-solid fa-server card-icon"></i>
                <h3>قاعات حاسوب</h3>
                <p>مزودة بإنترنت عالي السرعة وبرامج المحاكاة الحديثة.</p>
            </div>
            <div class="vision-card" style="border-right-color: var(--primary);">
                <i class="fa-solid fa-book card-icon"></i>
                <h3>مكتبة شاملة</h3>
                <p>تضم آلاف المراجع العلمية والكتب التخصصية الورقية والإلكترونية.</p>
            </div>
            <div class="vision-card" style="border-right-color: var(--primary);">
                <i class="fa-solid fa-futbol card-icon"></i>
                <h3>ملاعب رياضية</h3>
                <p>ساحات وملاعب مجهزة لممارسة مختلف الأنشطة الرياضية والبطولات.</p>
            </div>
        </div>
    </section>

    <!-- GALLERY SECTION -->
    <section id="gallery" style="padding: 100px 20px; background: #000; text-align: center;">
        <h2 class="section-title"><i class="fa-solid fa-images"></i> معرض الصور</h2>
        <p style="color:#aaa; max-width:600px; margin:0 auto 40px auto;">جانب من مرافقنا التعليمية المتطورة ونشاطات
            طلبتنا المتميزين.</p>
        <div class="container"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
            <!-- Image 1 -->
            <div class="glass-panel"
                style="padding: 10px; background: #050505; transition: transform 0.3s; cursor:pointer;"
                onclick="viewGalleryImage(1)">
                <div style="height: 250px; background: #111; overflow: hidden; border-radius: 5px;">
                    <img id="gallery-img-1" src="g1.jpg"
                        style="width:100%; height:100%; object-fit:cover; transition: transform 0.5s;"
                        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                </div>
                <h4 id="gallery-title-1" style="margin-top: 15px; color: var(--primary);">ساحة التجمع الصباحي</h4>
            </div>
            <!-- Image 2 -->
            <div class="glass-panel"
                style="padding: 10px; background: #050505; transition: transform 0.3s; cursor:pointer;"
                onclick="viewGalleryImage(2)">
                <div style="height: 250px; background: #111; overflow: hidden; border-radius: 5px;">
                    <img id="gallery-img-2" src="g2.jpg"
                        style="width:100%; height:100%; object-fit:cover; transition: transform 0.5s;"
                        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                </div>
                <h4 id="gallery-title-2" style="margin-top: 15px; color: var(--primary);">القاعات الدراسية الذكية</h4>
            </div>
            <!-- Image 3 -->
            <div class="glass-panel"
                style="padding: 10px; background: #050505; transition: transform 0.3s; cursor:pointer;"
                onclick="viewGalleryImage(3)">
                <div style="height: 250px; background: #111; overflow: hidden; border-radius: 5px;">
                    <img id="gallery-img-3" src="g3.jpg"
                        style="width:100%; height:100%; object-fit:cover; transition: transform 0.5s;"
                        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                </div>
                <h4 id="gallery-title-3" style="margin-top: 15px; color: var(--primary);">الأنشطة المدرسية</h4>
            </div>
        </div>
    </section>

    <!-- PARTNERSHIP SECTION (Strategic Placement: Below Gallery) -->
    <section id="partnership"
        style="padding: 60px 20px; position: relative; z-index: 2; background: linear-gradient(180deg, #000 0%, #050505 100%);">
        <div class="container">
            <div class="glass-panel"
                style="display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 40px; padding: 50px; border: 1px solid rgba(255, 255, 255, 0.1); background: linear-gradient(145deg, rgba(20, 20, 30, 0.8) 0%, rgba(0,0,0,0.9) 100%); box-shadow: 0 0 40px rgba(0, 242, 255, 0.05);">

                <!-- Text Content -->
                <div style="flex: 1; min-width: 300px; text-align: right;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <span style="font-size: 2.5rem; text-shadow: 0 0 10px gold;">🤝</span>
                        <h2 class="section-title" style="margin: 0; font-size: 2rem; text-align: right;">شركاء مسيرة
                            النجاح</h2>
                    </div>
                    <h3 style="color: #fff; font-size: 1.5rem; margin-bottom: 20px; line-height: 1.6;">
                        إعدادية النهرين المهنية <span
                            style="color: var(--primary); font-size:2rem; vertical-align:middle;">×</span> الشركة
                        اللبنانية الدولية
                    </h3>
                    <p style="color: #ccc; font-size: 1.1rem; line-height: 1.9; margin-bottom: 30px;">
                        مشروع تعليمي رائد انبثق من رؤية مشتركة تجمع بين <strong style="color: #fff;">الأصالة
                            العراقية</strong> و <strong style="color: #fff;">الخبرة الدولية</strong>.
                        تعاوننا مع الشركة اللبنانية الدولية للإدارة والتطوير يهدف لبناء جيل مهني مسلح بأحدث المهارات
                        العالمية.
                    </p>
                    <div style="display: flex; gap: 15px; flex-wrap:wrap;">
                        <div
                            style="background: rgba(206, 17, 38, 0.15); border: 1px solid #ce1126; padding: 8px 20px; border-radius: 30px; color: #fff; font-size: 1rem; display:flex; align-items:center; gap:8px;">
                            <img src="https://flagcdn.com/w40/lb.png" style="width:20px;"> خبرة دولية عريقة
                        </div>
                        <div
                            style="background: rgba(0, 255, 0, 0.1); border: 1px solid #00ce29; padding: 8px 20px; border-radius: 30px; color: #fff; font-size: 1rem; display:flex; align-items:center; gap:8px;">
                            <img src="https://flagcdn.com/w40/iq.png" style="width:20px;"> صرح علمي وطني
                        </div>
                    </div>
                </div>

                <!-- Image/Banner -->
                <div style="flex: 1; min-width: 300px; display: flex; justify-content: center;">
                    <div class="hover-glow"
                        style="position: relative; overflow: hidden; border-radius: 20px; border: 2px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.6); transform: perspective(1000px) rotateY(-5deg); transition: transform 0.5s;">
                        <img src="partner.jpg" alt="Partnership Logo"
                            style="width: 100%; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                        <div
                            style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); pointer-events: none;">
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- Portals Section -->
    <!-- Portals Section -->
    <section id="portals"
        style="margin-top: 150px; padding: 100px 0; background: linear-gradient(to bottom, transparent, #050505);">
        <div class="container">
            <div class="section-title">
                <h2>النظام الإلكتروني</h2>
                <p>بوابات الدخول للطلاب والكوادر التدريسية</p>
            </div>
            <div class="portal-grid">
                <div class="portal-card" onclick="requestLogin('student')">
                    <i class="fa-solid fa-graduation-cap"
                        style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                    <h3>بوابة الطالب</h3>
                    <p style="color: #aaa;">عرض الدرجات والجدول</p>
                </div>
                <div class="portal-card" onclick="requestLogin('teacher')">
                    <i class="fa-solid fa-chalkboard-user"
                        style="font-size: 3rem; color: var(--secondary); margin-bottom: 15px;"></i>
                    <h3>بوابة التدريسيين</h3>
                    <p style="color: #aaa;">إدارة الدرجات والحضور</p>
                </div>
                <!-- ADDED: Gallery Management -->
                <!-- Moved to Admin Dashboard -->
                <div class="portal-card" onclick="requestLogin('admin')">
                    <i class="fa-solid fa-user-tie" style="font-size: 3rem; color: #fff; margin-bottom: 15px;"></i>
                    <h3>الإدارة المدرسية</h3>
                    <p style="color: #aaa;">شؤون الطلبة والموظفين</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact -->
    <section class="container" id="contact" style="padding-bottom: 100px;">
        <div class="section-title">
            <h2>تواصل معنا</h2>
        </div>
        <div class="vision-grid">
            <div class="vision-card" style="text-align: center;">
                <i class="fa-solid fa-location-dot card-icon"></i>
                <h3>العنوان</h3>
                <p>المثنى - السماوة - شارع المحافظة</p>
            </div>
            <div class="vision-card" style="text-align: center;">
                <i class="fa-solid fa-phone card-icon"></i>
                <h3>الهاتف</h3>
                <p style="font-size: 1.5rem; color: var(--primary); direction: ltr;">0787 077 7892</p>
            </div>
            <div class="vision-card" style="text-align: center;">
                <i class="fa-solid fa-clock card-icon"></i>
                <h3>أوقات الدوام</h3>
                <p>الأحد - الخميس: 2:15 م - 6:15 م</p>
            </div>
        </div>
    </section>

    <!-- TOP STUDENTS SECTION -->
    <section id="top-students" style="padding: 80px 20px; background: #050505; text-align: center;">
        <h2 class="section-title" style="margin-bottom: 50px;"><i class="fa-solid fa-medal"></i> لوحة الشرف - أوائل
            الطلبة</h2>
        <div class="container"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 40px;">
            <!-- Student 1 -->
            <div class="glass-panel"
                style="padding: 30px; border-top: 3px solid gold; transition: transform 0.3s; box-shadow: 0 0 20px rgba(255, 215, 0, 0.1);">
                <div style="font-size: 3rem; color: gold; margin-bottom: 20px;"><i class="fa-solid fa-crown"></i></div>
                <h3 id="h1-name" style="color: #fff; font-size: 1.5rem; margin-bottom: 10px;">أحمد مهند</h3>
                <p id="h1-major" style="color: var(--primary); font-size: 1.1rem;">الأول - الأمن السيبراني</p>
                <p id="h1-grade" style="color: #aaa; font-size: 0.9rem;">المعدل: 98.5%</p>
            </div>
            <!-- Student 2 -->
            <div class="glass-panel"
                style="padding: 30px; border-top: 3px solid silver; transition: transform 0.3s; box-shadow: 0 0 20px rgba(192, 192, 192, 0.1);">
                <div style="font-size: 3rem; color: silver; margin-bottom: 20px;"><i class="fa-solid fa-award"></i>
                </div>
                <h3 id="h2-name" style="color: #fff; font-size: 1.5rem; margin-bottom: 10px;">سارة علي</h3>
                <p id="h2-major" style="color: var(--primary); font-size: 1.1rem;">الأولى - الأجهزة الطبية</p>
                <p id="h2-grade" style="color: #aaa; font-size: 0.9rem;">المعدل: 97.2%</p>
            </div>
            <!-- Student 3 -->
            <div class="glass-panel"
                style="padding: 30px; border-top: 3px solid #cd7f32; transition: transform 0.3s; box-shadow: 0 0 20px rgba(205, 127, 50, 0.1);">
                <div style="font-size: 3rem; color: #cd7f32; margin-bottom: 20px;"><i class="fa-solid fa-star"></i>
                </div>
                <h3 id="h3-name" style="color: #fff; font-size: 1.5rem; margin-bottom: 10px;">محمد قاسم</h3>
                <p id="h3-major" style="color: var(--primary); font-size: 1.1rem;">الأول - تكرير النفط</p>
                <p id="h3-grade" style="color: #aaa; font-size: 0.9rem;">المعدل: 96.8%</p>
            </div>
        </div>
    </section>



    <!-- ADMISSION SECTION -->
    <section id="admission-section"
        style="padding: 80px 20px; background: linear-gradient(to top, #000, #0a0a0a); position: relative; z-index: 10; scroll-margin-top: 50px;">
        <div class="container" style="max-width: 800px; margin: 0 auto;">
            <div class="glass-panel"
                style="padding: 50px; border: 1px solid var(--primary); box-shadow: 0 0 40px rgba(0,255,255,0.05);">
                <h1 style="color: var(--primary); margin-bottom: 10px; font-size: 2.2rem; text-align: center;"><i
                        class="fa-solid fa-file-contract"></i> استمارة القبول الإلكتروني</h1>
                <p style="color:#aaa; text-align: center; margin-bottom: 50px; font-size: 1.1rem;">سجل بياناتك الآن
                    للانضمام إلى نخبة المستقبل للعام الدراسي القادم</p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; text-align: right;">
                    <div><label style="color: var(--secondary); display:block; margin-bottom:8px;">الاسم
                            الكامل</label><input type="text" id="app-name" class="cyber-input"
                            placeholder="الاسم الرباعي واللقب" style="width:100%"></div>
                    <div><label style="color: var(--secondary); display:block; margin-bottom:8px;">المدرسة
                            السابقة</label><input type="text" id="app-school" class="cyber-input"
                            placeholder="اسم المدرسة" style="width:100%"></div>
                </div>
                <div style="margin-top: 25px; text-align: right;">
                    <label style="color: var(--secondary); display:block; margin-bottom:8px;">القسم المطلوب</label>
                    <select id="app-major" class="cyber-input">
                        <option value="">-- اختر القسم الراغب به --</option>
                        <option value="الأمن السيبراني">الأمن السيبراني</option>
                        <option value="تكرير النفط والغاز">تكرير النفط والغاز</option>
                        <option value="الأجهزة الطبية">الأجهزة الطبية</option>
                        <option value="تكنولوجيا الطيـران">تكنولوجيا الطيران</option>
                        <option value="الإلكترونيك والسيطرة">الإلكترونيك والسيطرة</option>
                        <option value="أخرى">تخصص آخر</option>
                    </select>
                </div>
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 25px; text-align: right;">
                    <div><label style="color: var(--secondary); display:block; margin-bottom:8px;">المعدل /
                            المجموع</label><input type="number" id="app-avg" class="cyber-input" placeholder="00.0"
                            style="width:100%"></div>
                    <div><label style="color: var(--secondary); display:block; margin-bottom:8px;">رقم
                            الهاتف</label><input type="tel" id="app-phone" class="cyber-input" placeholder="07xxxxxxxxx"
                            style="width:100%"></div>
                </div>
                <button class="btn-glow" onclick="submitApplication()"
                    style="width:100%; margin-top:40px; font-size:1.2rem; padding: 15px;">إرسال الطلب نهائياً
                    🚀</button>
            </div>
        </div>
    </section>

    <footer
        style="text-align: center; padding: 40px; background: rgba(0,0,0,0.9); color: #888; border-top: 1px solid #333;">
        <div style="margin-bottom: 20px; display: flex; justify-content: center; gap: 20px;">
            <a href="#" style="color: #1877F2; font-size: 1.5rem;"><i class="fa-brands fa-facebook"></i></a>
            <a href="#" style="color: #0088cc; font-size: 1.5rem;"><i class="fa-brands fa-telegram"></i></a>
            <a href="#" style="color: #25D366; font-size: 1.5rem;"><i class="fa-brands fa-whatsapp"></i></a>
            <a href="#" style="color: #FF0000; font-size: 1.5rem;"><i class="fa-brands fa-youtube"></i></a>
        </div>
        <p>&copy; 2025 اعدادية النهرين المهنية - جميع الحقوق محفوظة</p>
        <p style="font-size: 0.8rem; margin-top: 10px; color: #555;">مدعوم بنظام الإدارة الذكي (Nahr-AI)</p>
    </footer>

    <!-- News Ticker -->
    <div class="news-ticker">
        <div class="ticker-label">عاجل</div>
        <div class="ticker-wrap">
            <div class="ticker-content" id="dynamic-ticker-content">
                <div class="ticker-item"><i class="fa-solid fa-bullhorn"></i> أهلاً بكم في المنصة الإلكترونية الرسمية
                    لإعدادية النهرين المهنية للبنين - نرحب بطلبتنا الأعزاء</div>
            </div>
        </div>
    </div>




    <!-- Registration Overlay (Existing) -->
    <!-- Auth Overlay (Login) -->
    <div id="auth-overlay" class="dashboard-overlay"
        style="z-index: 3000; display:none; align-items:center; justify-content:center;">
        <div class="auth-box">
            <h2 style="color: var(--primary); margin-bottom: 5px;">تسجيل الدخول</h2>
            <p style="color:#aaa; font-size:0.85rem; margin-bottom:20px;">الوصول الآمن للنظام الإلكتروني</p>

            <p id="modal-error"
                style="color: #ff4444; display: none; margin-bottom: 15px; background:rgba(255,0,0,0.1); padding:10px; border-radius:8px; font-size:0.9rem;">
            </p>

            <!-- Standard Login Mode -->
            <div id="login-standard-fields">
                <div class="input-group" style="margin-bottom:15px;">
                    <i class="fa-solid fa-user" style="position:absolute; margin:15px; color:var(--primary);"></i>
                    <input type="text" id="modal-email" class="cyber-input" placeholder="اسم المستخدم أو البريد"
                        style="padding-right:45px;">
                </div>
                <div class="input-group" style="margin-bottom:20px;">
                    <input type="password" id="modal-pass" class="cyber-input" placeholder="كلمة المرور"
                        style="padding-right:45px;">
                </div>
                <div style="text-align: left; margin-top: -10px; margin-bottom: 20px;">
                    <span style="color: var(--primary); font-size: 0.8rem; cursor: pointer;"
                        onclick="resetPassword()">نسيت كلمة المرور؟</span>
                </div>
                <button class="btn-glow" id="login-btn" style="width:100%; padding:15px; font-size:1.1rem;"
                    onclick="validateLogin()">دخول آمن 🚀</button>
            </div>

            <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <p style="color: #888; font-size: 0.85rem;">ليس لديك حساب؟</p>
                <button class="btn-glow"
                    style="background: transparent; border: 1px solid var(--secondary); color: var(--secondary); margin-top: 10px; font-size: 0.85rem; width:100%;"
                    onclick="document.getElementById('auth-overlay').style.display='none'; showRegistration();">
                    إنشاء حساب طالب جديد
                </button>
            </div>

            <p style="margin-top: 20px; cursor: pointer; color: #555; font-size:0.9rem;"
                onclick="document.getElementById('auth-overlay').style.display='none'">إلغاء الرجوع للخلف</p>
        </div>
    </div>
    <!-- ADD STAFF MODAL (Admin Only) -->
    <div id="add-staff-modal" class="dashboard-overlay"
        style="z-index: 100000; align-items:center; justify-content:center; display:none;">
        <div class="auth-box" style="max-width:450px;">
            <h2 style="color:var(--primary); margin-bottom:15px;">إضافة كادر جديد 👤</h2>
            <p style="color:#aaa; font-size:0.85rem; margin-bottom:20px;">قم بتعيين حساب خاص للأستاذ أو الموظف</p>

            <input type="text" id="new-staff-name" class="cyber-input" placeholder="اسم الأستاذ الكامل">
            <input type="text" id="new-staff-email" class="cyber-input" placeholder="اسم المستخدم (Username) أو بريد">
            <input type="text" id="new-staff-pass" class="cyber-input" placeholder="كلمة المرور">

            <select id="new-staff-role" class="cyber-input">
                <option value="teacher" selected>أستاذ (Teacher)</option>
                <option value="admin">مدير نظام (Admin)</option>
            </select>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-glow" style="flex:1; background:var(--primary); color:#000;"
                    onclick="saveNewStaff()">إنشاء الحساب ✅</button>
                <button class="btn-glow" style="flex:1; background:#222;"
                    onclick="document.getElementById('add-staff-modal').style.display='none'">إلغاء</button>
            </div>
        </div>
    </div>
    <div id="reg-overlay" class="dashboard-overlay" style="z-index: 20000; text-align: center; display: none;">
        <div class="auth-box"
            style="margin: 2% auto; width: 500px; position: relative; max-height: 90vh; overflow-y: auto;">
            <i class="fa-solid fa-xmark" onclick="closeReg()"
                style="position: absolute; top: 15px; left: 15px; font-size: 1.5rem; cursor: pointer; color: #fff;"></i>

            <!-- Registration Header (Simplified) -->
            <div style="text-align:center; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:15px;">
                <h2 style="color: var(--primary);">📝 إنشاء حساب طالب جديد</h2>
                <p style="color:#aaa; font-size:0.9rem;">يرجى ملء البيانات أدناه لإنشاء قيد إلكتروني في المدرسة</p>
                <p style="color:#aaa; font-size:0.9rem;">يرجى ملء البيانات أدناه لإنشاء قيد إلكتروني في المدرسة</p>
            </div>

            <!-- Common Fields -->
            <input type="text" id="reg-name" class="cyber-input" placeholder="الاسم الرباعي واللقب" required>
            <input type="tel" id="reg-phone" class="cyber-input" placeholder="رقم الهاتف (للتواصل واتساب)">
            <input type="email" id="reg-email" class="cyber-input" placeholder="البريد الإلكتروني (Email)">
            <input type="password" id="reg-pass" class="cyber-input" placeholder="كلمة المرور (لاتقل عن 6 رموز)">

            <!-- Student Options (Always Visible) -->
            <div id="reg-student-opts" style="display:block;">
                <label style="display:block; text-align:right; margin-bottom:5px; color:#aaa;">التخصص / الشعبة:</label>
                <select id="reg-class" class="cyber-input">
                    <option value="">جاري تحميل الأقسام...</option>
                </select>
            </div>

            <!-- Staff Options REMOVED for Security -->

            <button class="btn-glow" onclick="processRegistration()">إنشاء الحساب 🚀</button>
            <p id="reg-status" style="margin-top:10px; color:#aaa; font-size:0.9rem;"></p>

            <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
                <p style="color: #aaa; cursor: pointer; font-size: 0.9rem;"
                    onclick="closeReg(); document.getElementById('auth-overlay').style.display='flex';">
                    لديك حساب بالفعل؟ <span style="color: var(--primary); font-weight: bold;">تسجيل الدخول</span>
                </p>
                <p style="color:red; margin-top:10px; cursor:pointer;" onclick="closeReg()">إغلاق النافذة</p>
            </div>
        </div>
    </div>

    <!-- ================== DASH BOARDS ================== -->
    <!-- Student Dashboard (Consolidated) -->
    <div id="student-dash" class="dashboard-overlay">
        <i class="fa-solid fa-xmark close-dash" onclick="closeDashboards()"></i>
        <div class="container" style="max-width: 900px; margin-top: 50px;">

            <!-- Welcome Header -->
            <div class="glass-panel" style="text-align: center; margin-bottom: 20px; position: relative;">
                <div id="student-qr-container"
                    style="position: absolute; top: 15px; left: 15px; background: #fff; padding: 5px; border-radius: 5px; width: 80px; height: 80px; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
                    <div id="student-qr"></div>
                </div>
                <i class="fa-solid fa-graduation-cap"
                    style="font-size: 3.5rem; color: var(--primary); margin-bottom:15px;"></i>
                <h2 id="std-welcome-name" style="color:#fff;">أهلاً بك</h2>
                <div id="std-welcome-major" class="floating-badge" style="display:inline-block; margin-top:10px;">الطالب
                    المثابر</div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #aaa;">رمز الهوية الرقمي QR</div>
            </div>

            <!-- STUDENT QUICK SERVICES (MATCHING USER IMAGE) -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                <div class="glass-panel"
                    onclick="document.getElementById('std-results-links').scrollIntoView({behavior:'smooth'})"
                    style="cursor:pointer; padding:15px; text-align:center; border:1px solid rgba(0,242,255,0.2); background: rgba(0,0,0,0.4); transition:0.3s;"
                    onmouseover="this.style.boxShadow='0 0 20px rgba(0,242,255,0.2)'"
                    onmouseout="this.style.boxShadow='none'">
                    <div
                        style="background: linear-gradient(135deg, var(--primary), var(--secondary)); width:100%; border-radius:12px; height:85px; display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:10px;">
                        <i class="fa-solid fa-file-pdf" style="font-size:2rem; color:#000;"></i>
                        <div style="font-weight:bold; color:#000; margin-top:3px; font-size:0.8rem;">النتائج</div>
                    </div>
                    <div style="font-weight:bold; color:#fff; font-size:0.9rem;">النتائج الرسمية</div>
                    <div style="font-size:0.7rem; color:#aaa;">مركز التحميل الموحد</div>
                </div>

                <div class="glass-panel"
                    onclick="document.getElementById('std-grades-body').scrollIntoView({behavior:'smooth'})"
                    style="cursor:pointer; padding:15px; text-align:center; border:1px solid rgba(112,0,255,0.2); background: rgba(0,0,0,0.4); transition:0.3s;"
                    onmouseover="this.style.boxShadow='0 0 20px rgba(112,0,255,0.2)'"
                    onmouseout="this.style.boxShadow='none'">
                    <div
                        style="background: linear-gradient(135deg, #7000ff, #ff0055); width:100%; border-radius:12px; height:85px; display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:10px;">
                        <i class="fa-solid fa-star" style="font-size:2rem; color:#fff;"></i>
                        <div style="font-weight:bold; color:#fff; margin-top:3px; font-size:0.8rem;">الدرجات</div>
                    </div>
                    <div style="font-weight:bold; color:#fff; font-size:0.9rem;">السجل الدراسي</div>
                    <div style="font-size:0.7rem; color:#aaa;">كشوفات ذكية فورية</div>
                </div>
            </div>

            <!-- 1. TUITION FEES (From Legacy) -->
            <div class="glass-panel"
                style="background: rgba(255,50,50,0.05); border: 1px solid rgba(255,0,0,0.3); margin-bottom: 20px;">
                <h3 style="color: #ff5555; margin-bottom: 15px;"><i class="fa-solid fa-money-bill-wave"></i> الأقساط
                    الدراسية</h3>
                <table class="cyber-table">
                    <thead>
                        <tr>
                            <th>القسط (الشهر)</th>
                            <th>المبلغ</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody id="student-installments-body">
                        <tr>
                            <td colspan="3" style="color:#777;">لا توجد بيانات مالية</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 2. LIVE GRADES (Cloud Sync) -->
            <div class="glass-panel" style="margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3><i class="fa-solid fa-star"></i> سجل الدرجات كشوفات ذكية</h3>
                    <button class="btn-glow" onclick="printStudentCertificate()"
                        style="padding:5px 15px; font-size:0.85rem;">
                        <i class="fa-solid fa-print"></i> طباعة الوثيقة الرسمية
                    </button>
                </div>
                <table class="cyber-table">
                    <thead>
                        <tr>
                            <th>المادة</th>
                            <th>الدرجة</th>
                            <th>التقدير</th>
                        </tr>
                    </thead>
                    <tbody id="std-grades-body">
                        <tr>
                            <td colspan="3" style="color:#aaa;">جاري جلب البيانات...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 3. OFFICIAL DOWNLOAD CENTER (Schedules, Results, etc) -->
            <div class="glass-panel"
                style="margin-bottom: 20px; border:1px solid #ffcc00; background:rgba(255,204,0,0.02);">
                <h3 style="color:#ffcc00;"><i class="fa-solid fa-file-pdf"></i> مركز التحميل (جداول، نتائج، كشوفات)</h3>
                <p style="color:#aaa; font-size:0.85rem; margin-bottom:15px;">يمكنك تحميل الجداول الأسبوعية وكشوفات
                    الدرجات والملفات الرسمية المرفوعة من قبل الإدارة:</p>
                <div id="std-results-links" style="display:flex; flex-direction:column; gap:10px;">
                    <div style="color:#777; text-align:center; padding:10px;">لا توجد ملفات مرفوعة حالياً</div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                <button class="btn-glow" style="background:rgba(255,166,0,0.2); border-color:orange;"
                    onclick="changeStudentPassword()">🔑 تغيير كلمة المرور</button>
                <button class="btn-glow" style="background:rgba(255,0,0,0.2); border-color:red;"
                    onclick="closeDashboards();">تسجيل الخروج</button>
            </div>
        </div>
    </div>


    <!-- Teacher Dashboard (FULL VERSION) -->
    <div id="teacher-dash" class="dashboard-overlay">
        <i class="fa-solid fa-xmark close-dash" onclick="closeDashboards()"></i>
        <div class="container"
            style="max-width: 900px; margin-top: 50px; max-height: 90vh; overflow-y: auto; padding-bottom: 50px;">

            <div class="glass-panel" style="text-align: center; margin-bottom: 25px;">
                <i class="fa-solid fa-chalkboard-user"
                    style="font-size: 3rem; color: var(--secondary); margin-bottom: 15px;"></i>
                <h2 id="teacher-welcome" style="color: #fff;">أهلاً بك في بوابة التدريسيين</h2>
                <p style="color: #aaa;">إدارة الدرجات وسجلات الحضور بسهولة</p>
            </div>

            <!-- CONTROLS CONTAINER -->
            <div class="glass-panel">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label style="color:#aaa; display:block; margin-bottom:5px;">📂 الشعبة / المرحلة</label>
                        <select id="teacher-class-select" class="cyber-input">
                            <option value="">(جاري تحميل الشعب...)</option>
                        </select>
                    </div>
                    <div>
                        <label style="color:#aaa; display:block; margin-bottom:5px;">📘 المادة الدراسية</label>
                        <select id="teacher-subject-select" class="cyber-input">
                            <option value="">(اختر الشعبة أولاً)</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn-glow"
                        style="background: linear-gradient(45deg, #00d2ff, #3a7bd5); padding:15px; font-size:1.1rem;"
                        onclick="openGradebook()">
                        <i class="fa-solid fa-table"></i> فتح سجل الدرجات
                    </button>

                    <button class="btn-glow"
                        style="background: linear-gradient(45deg, #ff0099, #493240); padding:15px; font-size:1.1rem;"
                        onclick="openAttendanceModal()">
                        <i class="fa-solid fa-clipboard-user"></i> سجل الحضور اليومي
                    </button>
                </div>
            </div>

            <!-- UPLOAD CENTER -->
            <div class="glass-panel" style="margin-top: 20px; border: 1px solid rgba(0, 255, 255, 0.2);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="color:#fff; margin:0;">
                        <i class="fa-solid fa-cloud-arrow-up" style="color:var(--primary);"></i> مركز رفع الملفات
                        والمناهج
                    </h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-glow" style="padding:5px 10px; font-size:0.8rem; background:#2196F3;"
                            onclick="toggleBulkUploadMode()">
                            <i class="fa-solid fa-layer-group"></i> وضع الإضافة الجماعية
                        </button>
                    </div>
                </div>

                <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">
                    هنا يمكنك رفع روابط الجداول الأسبوعية، كشوفات النتائج، أو أي تعميمات رسمية. ستظهر هذه الملفات لجميع
                    الطلاب فوراً.
                </p>

                <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; border:1px dashed #555;">
                    <h4 style="color:var(--secondary); margin-bottom:10px;">➕ إضافة ملف جديد (نتيجة / جدول / ملف)</h4>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div>
                            <label style="color:#ccc; font-size:0.85rem;">عنوان الملف (مثال: الجدول الأسبوعي - مرحلة
                                1)</label>
                            <input type="text" id="upload-title" class="cyber-input" placeholder="اكتب العنوان هنا...">
                        </div>
                        <div>
                            <label style="color:#ccc; font-size:0.85rem;">الرابط (PDF / Drive)</label>
                            <input type="text" id="upload-link" class="cyber-input" placeholder="https://..."
                                style="direction:ltr;">
                        </div>
                    </div>

                    <div style="text-align:left;">
                        <button class="btn-glow"
                            style="background: linear-gradient(90deg, #00C9FF 0%, #92FE9D 100%); padding:8px 25px; border-radius:30px; font-weight:bold; color:#000;"
                            onclick="saveTeacherUpload()">
                            <i class="fa-solid fa-rocket"></i> نشر
                        </button>
                    </div>
                </div>

                <!-- RECENT UPLOADS PREVIEW -->
                <div style="margin-top:15px;">
                    <h5 style="color:#fff; border-bottom:1px solid #333; padding-bottom:5px;">📂 آخر الملفات المرفوعة
                    </h5>
                    <ul id="teacher-recent-uploads"
                        style="list-style:none; padding:0; margin-top:10px; font-size:0.9rem; color:#ddd; max-height:100px; overflow-y:auto;">
                        <li style="color:#777; font-style:italic;">جاري التحميل...</li>
                    </ul>
                </div>
            </div>


            <!-- LOGOUT FOR TEACHER -->
            <div style="margin-top:20px; text-align:center;">
                <button class="btn-glow"
                    style="background:rgba(255,0,0,0.2); border-color:#ff4444; color:#ff4444; width:100%; padding:12px;"
                    onclick="logoutUser()">
                    <i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج من حساب التدريسي
                </button>
            </div>
        </div>
    </div>


    <!-- Admin (NFC) -->
    <div id="admin-dash" class="dashboard-overlay">
        <i class="fa-solid fa-xmark close-dash" onclick="closeDashboards()"></i>
        <div class="container" style="max-width: 1000px; margin-top: 50px;">
            <!-- Admin Header (Clean & Centered) -->
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="font-size: 2.5rem; margin-bottom: 10px;"><i class="fa-solid fa-user-shield"></i> لوحة الإدارة
                    المتقدمة</h1>
                <p style="color: #aaa; margin-bottom: 20px;">نظام إدارة شامل للمدرسة والطلاب والموظفين</p>

                <!-- ADMIN QUICK TOOLS -->
                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                    <button class="btn-glow"
                        style="background:#ff9800; border-color:#e68a00; font-size:0.85rem; padding:8px 15px;"
                        onclick="openFixerTool()">🛠️ صيانة البيانات</button>
                    <button class="btn-glow"
                        style="background:#673ab7; border-color:#5e35b1; font-size:0.85rem; padding:8px 15px;"
                        onclick="adminChangePassword()">🔑 تغيير كلمة السر</button>

                    <button class="btn-glow"
                        style="background:#f44336; border-color:#b71c1c; font-size:0.85rem; padding:8px 15px;"
                        onclick="logoutUser()">🚪 تسجيل الخروج</button>
                    <button class="btn-glow"
                        style="background:#444; border-color:#666; font-size:0.85rem; padding:8px 15px;"
                        onclick="location.reload()">🔄 تحديث</button>

                </div>
            </div>

            <!-- Modern Nav Container (Full Width Grid) -->
            <div class="tabs modern-nav">
                <button class="nav-item active" onclick="showAdminTab('stats', this)">
                    <i class="fa-solid fa-chart-pie"></i> الإحصائيات
                </button>
                <button class="nav-item" onclick="showAdminTab('staff', this)">
                    <i class="fa-solid fa-chalkboard-user"></i> الكادر
                </button>
                <button class="nav-item" onclick="showAdminTab('students', this)">
                    <i class="fa-solid fa-user-graduate"></i> الطلاب
                </button>
                <button class="nav-item" onclick="showAdminTab('apps', this)">
                    <i class="fa-solid fa-file-signature"></i> الطلبات
                </button>
                <button class="nav-item" onclick="showAdminTab('gallery-admin', this)">
                    <i class="fa-solid fa-images"></i> المعرض
                </button>
                <button class="nav-item" onclick="showAdminTab('honor-admin', this)">
                    <i class="fa-solid fa-medal"></i> الأوائل
                </button>
                <button class="nav-item" onclick="showAdminTab('finance', this)">
                    <i class="fa-solid fa-sack-dollar"></i> الحسابات
                </button>
                <button class="nav-item" onclick="showAdminTab('nfc', this)">
                    <i class="fa-solid fa-id-card-clip"></i> NFC
                </button>
                <button class="nav-item" onclick="showAdminTab('results', this)">
                    <i class="fa-solid fa-file-pdf"></i> النتائج
                </button>
                <button class="nav-item" onclick="showAdminTab('site-settings', this)">
                    <i class="fa-solid fa-gears"></i> الإعدادات
                </button>
            </div>

            <style>
                /* Luxury Royal Cyber Nav */
                .modern-nav {
                    display: flex;
                    flex-wrap: wrap;
                    /* Allow items to wrap to next line */
                    justify-content: center;
                    /* Center items */
                    gap: 15px;
                    /* Spacing between buttons */
                    padding: 20px;
                    background: rgba(0, 0, 0, 0.3);
                    /* Dark crystal container */
                    border-radius: 20px;
                    border: 1px solid rgba(255, 255, 255, 0.08);
                    margin-bottom: 30px;
                    backdrop-filter: blur(10px);
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                }

                .nav-item {
                    flex: 1 1 auto;
                    /* Responsive width */
                    min-width: 110px;
                    /* Minimum width for readability */
                    max-width: 160px;
                    /* Max width to keep it neat */

                    background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.01));
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    color: #bbb;

                    padding: 15px 10px;
                    border-radius: 15px;
                    cursor: pointer;

                    font-family: 'Cairo', sans-serif;
                    font-weight: 600;
                    font-size: 0.95rem;

                    display: flex;
                    flex-direction: column;
                    /* Icon above text */
                    align-items: center;
                    gap: 8px;

                    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    /* Bouncy effect */
                    position: relative;
                    overflow: hidden;
                }

                /* Shiny effect overlay */
                .nav-item::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                    transition: 0.5s;
                }

                .nav-item:hover::before {
                    left: 100%;
                }

                .nav-item i {
                    font-size: 1.4em;
                    margin-bottom: 2px;
                    color: rgba(255, 255, 255, 0.5);
                    transition: 0.3s;
                }

                .nav-item:hover {
                    background: rgba(255, 255, 255, 0.1);
                    color: #fff;
                    transform: translateY(-5px);
                    border-color: rgba(255, 255, 255, 0.3);
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                }

                .nav-item:hover i {
                    color: #fff;
                    transform: scale(1.2);
                }

                /* ACTIVE STATE: Luxury Neon */
                .nav-item.active {
                    background: linear-gradient(135deg, var(--primary), var(--secondary));
                    color: #000;
                    border: 1px solid rgba(255, 255, 255, 0.5);
                    box-shadow: 0 0 25px rgba(0, 243, 255, 0.4);
                    transform: scale(1.05);
                    z-index: 1;
                }

                .nav-item.active i {
                    color: #000;
                }
            </style>
        </div>


        <!-- TAB: STAFF Content moved to consolidated tab below -->

        <!-- Staff Editor Modal -->
        <div id="subject-edit-modal"
            style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#111; padding:25px; border:1px solid var(--primary); border-radius:15px; z-index:10000; width:450px; max-height:85vh; overflow-y:auto; box-shadow: 0 0 50px rgba(0,0,0,0.8);">
            <h3 style="color:var(--primary); margin-bottom:20px; text-align:center;"><i
                    class="fa-solid fa-user-gear"></i> تعديل بيانات الحساب</h3>

            <div style="margin-bottom:18px;">
                <label style="color:#aaa; font-size:0.85rem; display:block; margin-bottom:5px;">اسم الأستاذ /
                    الموظف:</label>
                <input id="edit-staff-name-input" class="cyber-input"
                    style="width:100%; border-radius:8px; padding:10px;">
            </div>

            <div style="margin-bottom:18px;">
                <label style="color:#aaa; font-size:0.85rem; display:block; margin-bottom:5px;">كود الدخول (الولوج
                    السريع):</label>
                <input id="edit-staff-code-input" class="cyber-input"
                    style="width:100%; border-radius:8px; padding:10px;" placeholder="مثال: 2025">
                <p style="color:#666; font-size:0.75rem; margin-top:5px; line-height:1.4;">* هذا الكود يسمح للمعلم
                    بالدخول المباشر دون الحاجة لبريد إلكتروني عبر بوابة الموظفين.</p>
            </div>

            <div style="margin-bottom:18px;">
                <label style="color:#aaa; font-size:0.85rem; display:block; margin-bottom:5px;">الصلاحية /
                    الدور:</label>
                <select id="edit-staff-role-select" class="cyber-input"
                    style="width:100%; border-radius:8px; padding:10px;">
                    <option value="teacher">أستاذ (Teacher)</option>
                    <option value="admin">مدير (Admin)</option>
                </select>
            </div>

            <div style="margin-bottom:18px;">
                <label style="color:#aaa; font-size:0.85rem; display:block; margin-bottom:5px;">كلمة المرور (دخول
                    يدوي):</label>
                <input id="edit-staff-pass-input" type="text" class="cyber-input"
                    style="width:100%; border-radius:8px; padding:10px;" placeholder="كلمة السر الخاصة بالموظف">
            </div>

            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:20px 0;">

            <h4 style="color:var(--secondary); margin-bottom:12px;"><i class="fa-solid fa-book-open"></i> المواد
                الدراسية المخصصة</h4>
            <div id="subject-checklist" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; text-align:right;">
                <!-- Checkboxes injected by JS -->
            </div>

            <div style="margin-top:30px; display:flex; gap:10px;">
                <button class="btn-glow" style="flex:1; padding:12px;" onclick="saveTeacherSubjects()">💾 حفظ
                    التغييرات</button>
                <button class="btn-glow" style="flex:1; background:#444; border-color:#555; padding:12px;"
                    onclick="document.getElementById('subject-edit-modal').style.display='none'">إلغاء</button>
            </div>
        </div>

        <!-- TAB: FINANCE (AUTOMATED TUITION SYSTEM) -->
        <div id="tab-finance" class="admin-tab" style="display:none;">
            <div class="glass-panel">
                <h3>💰 نظام الأقساط المدرسية</h3>
                <div
                    style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:20px; margin-bottom:20px;">
                    <div>
                        <p style="color:#aaa;">إدارة الرسوم الدراسية لجميع الطلاب المسجلين.</p>
                        <ul style="font-size:0.9rem; color:#888; list-style:none; margin-top:5px;">
                            <li>💵 القسط الشهري: <span style="color:#0f0">250,000 د.ع</span></li>
                            <li>💰 المبلغ الكلي: <span style="color:gold">1,250,000 د.ع</span></li>
                        </ul>
                    </div>
                    <div>
                        <button class="btn-glow" onclick="renderFinanceDashboard()">🔄 تحديث القائمة</button>
                        <button class="btn-glow" style="background:#2ecc71; border-color:#27ae60;"
                            onclick="exportTableToExcel('finance-table-tag', 'Financial_Report')">
                            <i class="fa-solid fa-file-excel"></i> تصدير إكسل
                        </button>
                    </div>
                </div>

                <!-- FINANCE CONTROLS -->
                <div
                    style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin-bottom:15px; display:flex; gap:15px; align-items:center; flex-wrap:wrap;">

                    <!-- Class Filter -->
                    <div style="color:#fff;">📂 الشعبة:</div>
                    <select id="finance-class-filter" class="cyber-input" style="width:auto; min-width:150px;"
                        onchange="renderFinanceDashboard()">
                        <option value="all">-- كل المدرسة --</option>
                        <!-- Options injected by JS -->
                    </select>

                    <div style="width:1px; height:30px; background:#555; margin:0 10px;"></div>

                    <div style="color:#fff;">📅 القسط المستحق حالياً:</div>
                    <select id="finance-due-select" class="cyber-input" style="width:auto;"
                        onchange="renderFinanceDashboard()">
                        <option value="0">--- لا يوجد استحقاق حالياً ---</option>
                        <option value="1">القسط الأول (250,000)</option>
                        <option value="2">القسط الثاني (500,000)</option>
                        <option value="3">القسط الثالث (750,000)</option>
                        <option value="4">القسط الرابع (1,000,000)</option>
                        <option value="5">القسط الخامس (الكامل 1,250,000)</option>
                    </select>
                    <button class="btn-glow" style="background:#ff4444; border-color:red;"
                        onclick="printFinanceDefaulters()">📄 كشف المتلكئين</button>
                    <button class="btn-glow" style="background:#00e676; border-color:#00b09b; color:#000;"
                        onclick="printFinanceCompleted()">📄 المستوفين (الكامل)</button>
                </div>

                <!-- Tuition Table -->
                <div class="cyber-card" style="overflow-x:auto;">
                    <table class="cyber-table" id="finance-table-tag" style="width:100%; min-width:800px;">
                        <thead>
                            <tr>
                                <th style="width:25%;">الطالب / الشعبة</th>
                                <th style="width:15%;">رقم الهاتف</th>
                                <th style="width:15%;">المبلغ المدفوع</th>
                                <th style="width:15%;">المتبقي</th>
                                <th style="width:20%;">الأقساط (250 ألف/قسط)</th>
                                <th style="width:10%;">الحالة</th>
                                <th style="width:10%;">تحكم</th>
                            </tr>
                        </thead>
                        <tbody id="finance-table-body">
                            <!-- JS Will Render Here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // Finance Logic
            function getFinanceDB() { return JSON.parse(localStorage.getItem('school_finance_db')) || []; }
            function saveFinanceDB(data) { localStorage.setItem('school_finance_db', JSON.stringify(data)); }

            function addFinanceRecord() {
                const name = document.getElementById('fin-name').value;
                const phone = document.getElementById('fin-phone').value;
                const amount = document.getElementById('fin-amount').value;
                const date = document.getElementById('fin-date').value;

                if (!name || !amount || !date) return alert("يرجى إدخال كافة التفاصيل");

                const db = getFinanceDB();
                db.push({ id: Date.now(), name, phone, amount, date, status: 'pending' });
                saveFinanceDB(db);

                alert("تمت إضافة القسط بنجاح");
                renderFinanceTable();
                // Clear inputs
                document.getElementById('fin-name').value = '';
                document.getElementById('fin-amount').value = '';
            }

            function renderFinanceTable(filter = 'all') {
                const db = getFinanceDB();
                const tbody = document.getElementById('finance-table-body');
                if (!tbody) return;

                let html = '';
                db.forEach((item, index) => {
                    // Check Late Status
                    const isLate = new Date(item.date) < new Date() && item.status !== 'paid';
                    if (filter === 'late' && !isLate) return;

                    const statusBadge = item.status === 'paid'
                        ? '<span class="grade-badge grade-good">تم الدفع</span>'
                        : (isLate ? '<span class="grade-badge" style="background:red;">متأخر</span>' : '<span class="grade-badge" style="background:#555;">انتظار</span>');

                    html += `
                        <tr>
                            <td>${item.name} <div style="font-size:0.8rem; color:#aaa;">${item.phone || 'لا يوجد رقم'}</div></td>
                            <td>${item.amount}</td>
                            <td>${item.date}</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${item.status !== 'paid' ?
                            `<button class="btn-glow" style="padding:5px 10px; font-size:0.8rem; margin-left:5px;" onclick="markPaid(${index})">✅ دفع</button>` : ''}
                                
                                ${item.phone && item.status !== 'paid' ?
                            `<button class="btn-glow" style="padding:5px 10px; font-size:0.8rem; background:#25D366; border-color:#25D366; color:#fff;" onclick="sendWhatsApp('${item.phone}', '${item.name}', '${item.amount}')"><i class="fa-brands fa-whatsapp"></i> تذكير</button>` : ''}
                                
                                <button onclick="deleteFinance(${index})" style="background:none; border:none; color:red; cursor:pointer;">❌</button>
                            </td>
                        </tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">لا توجد بيانات</td></tr>';
            }

            function markPaid(index) {
                const db = getFinanceDB();
                db[index].status = 'paid';
                saveFinanceDB(db);
                renderFinanceTable();
            }

            function renderFinanceDashboard() {
                const tbody = document.getElementById('finance-table-body');
                if (!tbody) return;
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;">جاري معالجة البيانات المالية... <i class="fa-solid fa-spinner fa-spin"></i></td></tr>';

                firebase.database().ref('users').once('value').then(snap => {
                    const users = snap.val() || {};
                    const filterClass = document.getElementById('finance-class-filter').value;
                    let html = '';
                    let count = 0;

                    Object.keys(users).forEach(uid => {
                        const u = users[uid];
                        if (u.role !== 'student') return;
                        if (filterClass !== 'all' && u.classId !== filterClass) return;

                        const paid = parseInt(u.totalPaid || 0);
                        const remaining = 1250000 - paid;
                        const installments = Math.floor(paid / 250000);
                        const status = paid >= 1250000 ? '<span class="grade-badge grade-good">مستوفي</span>' : '<span class="grade-badge" style="background:#555;">قيد السداد</span>';

                        html += `
                        <tr>
                            <td style="font-weight:bold;">${u.name} <div style="font-size:0.75rem; color:var(--primary);">${u.classId || 'غير محدد'}</div></td>
                            <td>${u.phone || `<button class="btn-glow" style="padding:2px 8px; font-size:0.7rem; background:var(--secondary);" onclick="addStudentPhone('${uid}', '${u.name}')">📱 إضافة</button>`}</td>
                            <td style="color:#00e676; font-weight:bold;">${paid.toLocaleString()} د.ع</td>
                            <td style="color:#ff5252;">${remaining.toLocaleString()} د.ع</td>
                            <td>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <span style="font-size:0.8rem; color:#aaa;">${installments}/5</span>
                                    <div style="flex:1; height:8px; background:#222; border-radius:4px; overflow:hidden;">
                                        <div style="width:${(paid / 1250000) * 100}%; height:100%; background:var(--primary); transition:0.3s;"></div>
                                    </div>
                                </td>
                            <td>${status}</td>
                            <td>
                                <button class="btn-glow" style="padding:2px 8px; font-size:0.75rem;" onclick="addPaymentModal('${uid}', '${u.name}')">➕ دفعة</button>
                                <button class="btn-glow" style="padding:2px 8px; font-size:0.75rem; background:#ffc107; color:#000;" onclick="markFullyPaid('${uid}')">✅ تصفية</button>
                                <button class="btn-glow" style="padding:2px 8px; font-size:0.75rem; background:#ff4444; border-color:#ff4444;" onclick="deleteStudent('${uid}', 'finance')">🗑️</button>
                            </td>
                        </tr>`;
                        count++;
                    });

                    tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center; padding:20px;">لا يوجد طلاب في هذه الشعبة</td></tr>';
                });
            }

            async function addStudentPhone(uid, name) {
                const phone = await prompt(`إدخال رقم الهاتف للطالب: ${name}`);
                if (!phone) return;
                firebase.database().ref(`users/${uid}/phone`).set(phone).then(() => {
                    alert("✅ تم حفظ رقم الهاتف");
                    renderFinanceDashboard();
                });
            }

            async function addPaymentModal(uid, name) {
                const amount = await prompt(`إدخال مبلغ القسط الجديد للطالب: ${name}\nالمبلغ المقترح: 250,000`, "250000");
                if (!amount || isNaN(amount)) return;

                firebase.database().ref(`users/${uid}/totalPaid`).once('value').then(snap => {
                    const current = parseInt(snap.val() || 0);
                    const newVal = current + parseInt(amount);
                    firebase.database().ref(`users/${uid}/totalPaid`).set(newVal).then(() => {
                        alert("✅ تم تسجيل الدفعة بنجاح");
                        renderFinanceDashboard();
                    });
                });
            }

            async function markFullyPaid(uid) {
                if (await confirm("هل أنت متأكد من تصفية حساب الطالب بالكامل (1,250,000 د.ع)؟")) {
                    firebase.database().ref(`users/${uid}/totalPaid`).set(1250000).then(() => {
                        alert("✅ تم تصفية الحساب بنجاح");
                        renderFinanceDashboard();
                    });
                }
            }

            async function adminChangePassword() {
                const current = firebase.auth().currentUser;
                if (!current) return alert("خطأ: لم يتم التعرف على الجلسة.");
                const newPass = await prompt("أدخل كلمة السر الجديدة للإدارة (يجب أن تكون قوية):");
                if (!newPass || newPass.length < 8) return alert("يجب أن تكون كلمة السر 8 رموز على الأقل.");

                current.updatePassword(newPass).then(() => {
                    alert("✅ تم تغيير كلمة السر بنجاح. يرجى تذكرها جيداً!");
                }).catch(err => alert("فشل التغيير: " + err.message));
            }

            async function openFixerTool() {
                if (!await confirm("أداة صيانة البيانات ستقوم بفحص جميع الحسابات وإصلاح المسميات والأدوار التالفة. هل تريد الاستمرار؟")) return;

                const status = showCustomAlert("جاري الصيانة", "يرجى الانتظار، يتم فحص قاعدة البيانات...", "info");

                firebase.database().ref('users').once('value').then(snap => {
                    const users = snap.val();
                    if (!users) return;
                    const updates = {};
                    let fixCount = 0;

                    Object.keys(users).forEach(uid => {
                        const u = users[uid];
                        // Auto-fill student role if missing but email is student-like
                        if (!u.role) {
                            updates[`users/${uid}/role`] = 'student';
                            fixCount++;
                        }
                        // Sync classId and major
                        if (u.role === 'student' && !u.classId && u.major) {
                            updates[`users/${uid}/classId`] = u.major;
                            fixCount++;
                        }
                    });

                    if (Object.keys(updates).length > 0) {
                        firebase.database().ref().update(updates).then(() => {
                            alert(`✅ اكتملت الصيانة. تم إصلاح ${fixCount} سجل بنجاح.`);
                            location.reload();
                        });
                    } else {
                        alert("✅ قاعدة البيانات سليمة، لا توجد أخطاء لإصلاحها.");
                    }
                });
            }

            // --- REPORT PRINTING FUNCTIONS ---
            function printFinanceDefaulters() {
                const dueIdx = parseInt(document.getElementById('finance-due-select').value);
                if (dueIdx === 0) return alert("يرجى اختيار القسط المستحق أولاً");

                const dueAmount = dueIdx * 250000;
                const filterClass = document.getElementById('finance-class-filter').value;

                firebase.database().ref('users').once('value').then(snap => {
                    const users = snap.val() || {};
                    const defaulters = [];
                    Object.keys(users).forEach(uid => {
                        const u = users[uid];
                        if (u.role !== 'student') return;
                        if (filterClass !== 'all' && u.classId !== filterClass) return;

                        const paid = parseInt(u.totalPaid || 0);
                        if (paid < dueAmount) {
                            defaulters.push({ name: u.name, class: u.classId || 'غير محدد', paid: paid, remaining: dueAmount - paid });
                        }
                    });

                    if (defaulters.length === 0) return alert("✅ لا يوجد متلكئون لهذه الفترة");

                    generatePrintReport("كشف المتلكئين في سداد الأقساط", filterClass, dueAmount, defaulters, "متلكئ");
                });
            }

            function printFinanceCompleted() {
                const filterClass = document.getElementById('finance-class-filter').value;
                firebase.database().ref('users').once('value').then(snap => {
                    const users = snap.val() || {};
                    const completed = [];
                    Object.keys(users).forEach(uid => {
                        const u = users[uid];
                        if (u.role !== 'student') return;
                        if (filterClass !== 'all' && u.classId !== filterClass) return;

                        const paid = parseInt(u.totalPaid || 0);
                        if (paid >= 1250000) {
                            completed.push({ name: u.name, class: u.classId || 'غير محدد', paid: paid });
                        }
                    });

                    if (completed.length === 0) return alert("لا يوجد طلاب سددوا المبلغ بالكامل حتى الآن");

                    generatePrintReport("كشف الطلاب المستوفين للأجور بالكامل", filterClass, 1250000, completed, "مستوفي");
                });
            }

            function generatePrintReport(title, className, expected, list, type) {
                const win = window.open('', '_blank');
                let html = `<html><head><title>${title}</title>
                <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Cairo', sans-serif; direction: rtl; padding: 40px; }
                    .header { text-align: center; border-bottom: 2px solid #333; margin-bottom: 30px; padding-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #777; padding: 12px; text-align: right; }
                    th { background: #f2f2f2; font-weight: bold; }
                    .footer { margin-top: 50px; display: flex; justify-content: space-between; }
                    @media print { .no-print { display: none; } }
                </style></head><body>`;

                html += `<div class="header">
                    <h1>مدرسة النهرين الأهلية المختلطة</h1>
                    <h2>${title}</h2>
                    <p>الشعبة: ${className === 'all' ? 'الكل' : className} | التاريخ: ${new Date().toLocaleDateString('ar-IQ')}</p>
                </div>`;

                html += `<table><thead><tr>
                    <th>ت</th>
                    <th>اسم الطالب</th>
                    <th>الشعبة</th>
                    <th>المبلغ المسدد</th>
                    ${type === 'متلكئ' ? '<th>المبلغ المتبقي</th>' : ''}
                </tr></thead><tbody>`;

                list.forEach((s, i) => {
                    html += `<tr>
                        <td>${i + 1}</td>
                        <td>${s.name}</td>
                        <td>${s.class}</td>
                        <td>${s.paid.toLocaleString()} د.ع</td>
                        ${type === 'متلكئ' ? `<td>${s.remaining.toLocaleString()} د.ع</td>` : ''}
                    </tr>`;
                });

                html += `</tbody></table>`;
                html += `<div class="footer">
                    <div>توقيع المحاسب: .....................</div>
                    <div>ختم الإدارة: .....................</div>
                </div>`;
                html += `<div class="no-print" style="margin-top:20px; text-align:center;">
                    <button onclick="window.print()" style="padding:10px 30px; cursor:pointer;">طباعة التقرير</button>
                </div>`;
                html += `</body></html>`;

                win.document.write(html);
                win.document.close();
            }
        </script>


        <!-- TAB: STATS -->
        <div id="tab-stats" class="admin-tab" style="display:block;">
            <!-- QUICK STATS CARDS -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div class="glass-panel"
                    style="text-align:center; padding: 20px; border-bottom: 3px solid var(--primary);">
                    <i class="fa-solid fa-user-graduate"
                        style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                    <h2 id="stat-total-students">0</h2>
                    <p style="color: #aaa;">إجمالي الطلاب</p>
                </div>
                <div class="glass-panel"
                    style="text-align:center; padding: 20px; border-bottom: 3px solid var(--secondary);">
                    <i class="fa-solid fa-chalkboard-user"
                        style="font-size: 2rem; color: var(--secondary); margin-bottom: 10px;"></i>
                    <h2 id="stat-total-staff">0</h2>
                    <p style="color: #aaa;">إجمالي الكادر</p>
                </div>
                <div class="glass-panel" style="text-align:center; padding: 20px; border-bottom: 3px solid #00d26a;">
                    <i class="fa-solid fa-sack-dollar"
                        style="font-size: 2rem; color: #00d26a; margin-bottom: 10px;"></i>
                    <h2 id="stat-total-revenue">0</h2>
                    <p style="color: #aaa;">التحصيل المالي (د.ع)</p>
                </div>
                <div class="glass-panel" style="text-align:center; padding: 20px; border-bottom: 3px solid #ff4444;">
                    <i class="fa-solid fa-user-clock" style="font-size: 2rem; color: #ff4444; margin-bottom: 10px;"></i>
                    <h2 id="stat-pending-fees">0</h2>
                    <p style="color: #aaa;">طلاب بذمتهم مبالغ</p>
                </div>
            </div>

            <div class="glass-panel" style="margin-bottom:20px;">
                <h3><i class="fa-solid fa-chart-line"></i> التحليلات البيانية</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div style="height:300px;"><canvas id="enrollmentChart"></canvas></div>
                    <div style="height:300px;"><canvas id="attendanceChart"></canvas></div>
                </div>
            </div>

            <!-- NEWS EDITOR -->
            <div class="glass-panel" style="margin-bottom:20px; border: 1px solid var(--primary);">
                <div style="display:flex; justify-content:space-between;">
                    <h3>📰 شريط الأخبار العاجلة</h3>
                    <button class="btn-glow" onclick="saveNewsTicker()">نشر الخبر</button>
                </div>
                <p style="color:#aaa; font-size:0.9rem;">اكتب النص هنا وسيظهر أسفل الشاشة لجميع الزوار فوراً</p>
                <input id="news-input" class="cyber-input" placeholder="اكتب الخبر العاجل هنا..."
                    style="margin-top:10px;">
            </div>

        </div>

        <!-- TAB: STAFF (Consolidated) -->
        <div id="tab-staff" class="admin-tab" style="display:none;">
            <div class="glass-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div>
                        <h3>👨‍🏫 إدارة الكادر والتدريسيين</h3>
                        <p style="color:#aaa; font-size:0.9rem;">إدارة بيانات المعلمين، تخصيص المواد، وتعيين أكواد
                            الدخول السريع.</p>
                    </div>
                    <button class="btn-glow" onclick="adminAddUserUI()"><i class="fa-solid fa-user-plus"></i> إضافة
                        مستخدم جديد</button>
                </div>

                <div id="admin-staff-list" style="margin-top:20px;">
                    <div style="text-align:center; padding:40px; color:#555;">
                        <i class="fa-solid fa-spinner fa-spin fa-2x" style="margin-bottom:15px;"></i>
                        <p>جاري تحميل قائمة الكادر التدريسي...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: STUDENTS -->
        <!-- TAB: STUDENTS (Consolidated & Fixed) -->
        <div id="tab-students" class="admin-tab" style="display:none;">

            <!-- 1. BULK IMPORT SECTION -->
            <div
                style="background: rgba(0,0,0,0.4); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px dashed #555;">
                <h4 style="color: var(--primary); margin-bottom:10px; font-size:1.1rem;">
                    <i class="fa-solid fa-file-import"></i> رفع الأسماء دفعة واحدة (Bulk Import)
                </h4>
                <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">
                    انسخ الأسماء من ملف الإكسل والصقها هنا، ثم اختر الشعبة المناسبة.
                </p>

                <div style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
                    <select id="import-class-select" class="cyber-input" style="flex:1; min-width:200px;">
                        <option value="">(جاري تحميل الشعب...)</option>
                    </select>
                    <button class="btn-glow" onclick="processBulkImport()" style="padding:0 20px;">
                        بدء الاستيراد 🚀
                    </button>
                </div>

                <textarea id="import-names-area" class="cyber-input"
                    style="height:80px; width:100%; font-family:inherit; padding:10px;"
                    placeholder="مثال:&#10;علي محمد ياسين&#10;حسين كريم رحيم"></textarea>
            </div>

            <!-- 2. SEARCH & CONTROLS -->
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:15px;">
                    <h3 style="margin:0; color:#fff;">قائمة الطلاب المسجلين</h3>

                    <!-- Action Buttons -->
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <button class="btn-glow" onclick="showRegistration()" style="font-size:0.8rem;">+ تسجيل
                            طالب</button>
                        <button class="btn-glow" style="background:#2ecc71; border-color:#27ae60; font-size:0.8rem;"
                            onclick="exportTableToExcel('admin-students-table', 'Students_List')">
                            <i class="fa-solid fa-file-excel"></i> تصدير إكسل
                        </button>
                        <button class="btn-glow" style="background:#444; border-color:#888; font-size:0.8rem;"
                            onclick="openStructureManager()">⚙️ الهيكلية</button>
                        <button class="btn-glow" style="background:#ff4444; border-color:#ff4444; font-size:0.8rem;"
                            onclick="deleteAllStudents()">🗑️ حذف الكل</button>
                    </div>
                </div>

                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:200px;">
                        <input type="text" id="admin-student-search" class="cyber-input" style="width:100%;"
                            placeholder="🔍 بحث عن طالب..." oninput="renderAdminLists()">
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <select id="admin-student-filter" class="cyber-input" style="width:100%;"
                            onchange="renderAdminLists()">
                            <option value="all">عرض الجميع</option>
                            <option disabled>جاري التحميل...</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:5px; text-align:left;">
                    <span id="filter-count-badge" class="grade-badge" style="background:var(--primary); color:#000;">0
                        طالب</span>
                </div>
            </div>

            <!-- 3. TABLE -->
            <div style="overflow-x:auto;">
                <table class="cyber-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>الرمز</th>
                            <th>الاسم</th>
                            <th>الشعبة</th>
                            <th>الحالة</th>
                            <th>اتصال</th>
                            <th>تحكم</th>
                        </tr>
                    </thead>
                    <tbody id="admin-students-table">
                        <tr>
                            <td colspan="6" style="text-align:center; padding:20px; color:#aaa;">جاري تحميل البيانات...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- STRUCTURE MANAGER MODAL (Preserved) -->
            <div id="structure-modal" class="dashboard-overlay"
                style="display:none; z-index:10000; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(5px); justify-content:center; align-items:center;">
                <div class="glass-panel"
                    style="width:80%; max-width:800px; max-height:90vh; display:flex; flex-direction:column; position:relative; box-shadow: 0 0 50px rgba(0,242,255,0.2);">
                    <button onclick="document.getElementById('structure-modal').style.display='none'"
                        style="position:absolute; top:20px; left:20px; background:none; border:none; color:#ff4444; font-size:2rem; cursor:pointer; z-index:10;">✕</button>

                    <h2
                        style="color:var(--primary); border-bottom:2px solid #333; padding-bottom:15px; margin-bottom:25px; text-align:center;">
                        ⚙️ إدارة هيكلية المدرسة (الأقسام والشعب)
                    </h2>

                    <div style="display:flex; gap:10px; margin-bottom:25px;">
                        <input id="new-dept-name" class="cyber-input" style="font-size:1.1rem; padding:10px;"
                            placeholder="اسم القسم الجديد (مثال: الذكاء الاصطناعي)">
                        <button class="btn-glow" style="font-size:1.1rem; padding:10px 20px;" onclick="addNewDept()">+
                            إضافة قسم جديد</button>
                    </div>

                    <div id="structure-list"
                        style="flex:1; overflow-y:auto; padding-right:10px; border:1px solid #333; border-radius:10px; padding:15px; background:rgba(0,0,0,0.4);">
                        <!-- Dynamic Content Here -->
                    </div>

                    <div style="margin-top:20px; text-align:center; padding-top:15px; border-top:1px solid #333;">
                        <button class="btn-glow" style="width:100%; font-size:1.2rem; padding:10px;"
                            onclick="saveStructureConfig()">💾
                            حفظ التغييرات واعتماد الهيكلية</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: SITE SETTINGS -->
        <div id="tab-site-settings" class="admin-tab" style="display:none;">
            <div class="glass-panel">
                <h2 style="color:var(--primary); margin-bottom:20px;"><i class="fa-solid fa-sliders"></i> إعدادات الهوية
                    البصرية والمحتوى</h2>

                <!-- Hero Section Editor -->
                <div
                    style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; border:1px solid #333; margin-bottom:20px;">
                    <h3 style="color:var(--secondary); margin-bottom:15px;"><i class="fa-solid fa-image"></i> واجهة
                        الاستقبال (Hero Section)</h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div>
                            <label style="color:#aaa; display:block; margin-bottom:8px;">عنوان الواجهة الرئيسي:</label>
                            <input id="setting-hero-title" class="cyber-input" value="اعدادية النهرين المهنية">
                        </div>
                        <div>
                            <label style="color:#aaa; display:block; margin-bottom:8px;">النص الفرعي (Slogan):</label>
                            <input id="setting-hero-slogan" class="cyber-input" value="حيث يُصنع المستقبل">
                        </div>
                    </div>
                    <div style="margin-top:15px;">
                        <label style="color:#aaa; display:block; margin-bottom:8px;">وصف المؤسسة:</label>
                        <textarea id="setting-hero-desc" class="cyber-input"
                            style="height:80px;">11 تخصصاً مهنياً متطوراً يجمع بين العلم والتطبيق لبناء جيل من القادة المهنيين</textarea>
                    </div>
                </div>

                <!-- Branding & Links -->
                <div
                    style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; border:1px solid #333; margin-bottom:20px;">
                    <h3 style="color:var(--secondary); margin-bottom:15px;"><i class="fa-solid fa-fingerprint"></i>
                        العلامة التجارية والتواصل</h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:15px;">
                        <div>
                            <label style="color:#aaa; display:block; margin-bottom:8px;">رابط شعار المدرسة (Logo
                                URL):</label>
                            <input id="setting-school-logo" class="cyber-input" value="logo.jpg">
                        </div>
                        <div>
                            <label style="color:#aaa; display:block; margin-bottom:8px;">رقم هاتف التواصل:</label>
                            <input id="setting-school-phone" class="cyber-input" value="0787 077 7892">
                        </div>
                    </div>

                    <!-- SOCIAL MEDIA FIELDS -->
                    <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                        <label style="color:#fff; display:block; margin-bottom:10px;">🔗 روابط التواصل
                            الاجتماعي:</label>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                            <div>
                                <label style="color:#aaa; display:block; margin-bottom:8px; font-size:0.85rem;"><i
                                        class="fa-brands fa-facebook" style="color:#1877F2;"></i> فيسبوك:</label>
                                <input id="setting-social-fb" class="cyber-input" placeholder="https://facebook.com/..."
                                    style="font-size:0.9rem;">
                            </div>
                            <div>
                                <label style="color:#aaa; display:block; margin-bottom:8px; font-size:0.85rem;"><i
                                        class="fa-brands fa-telegram" style="color:#0088cc;"></i> تيليجرام:</label>
                                <input id="setting-social-tg" class="cyber-input" placeholder="https://t.me/..."
                                    style="font-size:0.9rem;">
                            </div>
                            <div>
                                <label style="color:#aaa; display:block; margin-bottom:8px; font-size:0.85rem;"><i
                                        class="fa-brands fa-whatsapp" style="color:#25D366;"></i> واتساب:</label>
                                <input id="setting-social-wa" class="cyber-input" placeholder="https://wa.me/..."
                                    style="font-size:0.9rem;">
                            </div>
                            <div>
                                <label style="color:#aaa; display:block; margin-bottom:8px; font-size:0.85rem;"><i
                                        class="fa-brands fa-youtube" style="color:#FF0000;"></i> يوتيوب:</label>
                                <input id="setting-social-yt" class="cyber-input" placeholder="https://youtube.com/..."
                                    style="font-size:0.9rem;">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align:center;">
                    <button class="btn-glow"
                        style="width:300px; background:var(--primary); color:#000; font-weight:bold; font-size:1.2rem;"
                        onclick="saveSiteSettings()">
                        <i class="fa-solid fa-floppy-disk"></i> حفظ كافة الإعدادات
                    </button>
                    <p style="color:#666; font-size:0.8rem; margin-top:10px;">* سيتم حفظ هذه الإعدادات في السحابة
                        وتحديثها لجميع الزوار فوراً.</p>
                </div>
            </div>
        </div>

        <script>
            // === SCHOOL STRUCTURE MANAGER (GLOBAL SCOPE FIX) ===

            // define global variable explicitely
            window.schoolStructure = [];

            // 1. Initial Load
            // Load listener moved to end of script to ensure functions are defined


            // 2. Open Modal
            window.openStructureManager = function () {
                const modal = document.getElementById('structure-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    renderStructureEditor();
                }
            };

            // 3. Render Editor List
            window.renderStructureEditor = function () {
                const container = document.getElementById('structure-list');
                if (!container) return;

                if (!window.schoolStructure || window.schoolStructure.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:40px; color:#aaa;">القائمة فارغة تماماً.</div>`;
                    return;
                }

                let html = '';
                window.schoolStructure.forEach((dept, dIdx) => {
                    // Migrate if old format
                    if (!dept.stages) {
                        dept.stages = [
                            { name: "المرحلة الأولى", sections: dept.sections || [] },
                            { name: "المرحلة الثانية", sections: [] },
                            { name: "المرحلة الثالثة", sections: [] }
                        ];
                        delete dept.sections;
                    }

                    let stagesHtml = '';
                    dept.stages.forEach((stage, stIdx) => {
                        let sectionsHtml = (stage.sections || []).map((s, sIdx) => `
                                    <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2); padding:5px 10px; margin-bottom:3px; border-radius:4px; font-size:0.9rem;">
                                        <span>🔹 ${s.name}</span>
                                        <button onclick="removeSection(${dIdx}, ${stIdx}, ${sIdx})" style="color:#777; background:none; border:none; cursor:pointer;">✖</button>
                                    </div>
                                `).join('');

                        stagesHtml += `
                                <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:5px; margin-bottom:10px; border:1px solid #333;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                        <h5 style="margin:0; color:var(--primary);">${stage.name}</h5>
                                        <div style="display:flex; gap:5px;">
                                            <input id="sect-input-${dIdx}-${stIdx}" class="cyber-input" style="padding:2px 5px; font-size:0.8rem; width:100px;" placeholder="شعبة..">
                                            <button class="btn-glow" style="padding:2px 10px; font-size:0.8rem;" onclick="addSection(${dIdx}, ${stIdx})">➕</button>
                                        </div>
                                    </div>
                                    ${sectionsHtml || '<div style="color:#555; font-size:0.7rem;">لا توجد شعب</div>'}
                                </div>`;
                    });

                    let subsHtml = (dept.subjects || []).map((sub, bIdx) => `
                                <div style="display:inline-flex; align-items:center; background:rgba(0,242,255,0.1); padding:4px 10px; margin:2px; border-radius:15px; border:1px solid var(--primary); font-size:0.8rem;">
                                    <span>${sub}</span>
                                    <button onclick="removeSubject(${dIdx}, ${bIdx})" style="color:#aaa; background:none; border:none; cursor:pointer; margin-right:5px;">×</button>
                                </div>
                            `).join('');

                    html += `
                            <div class="glass-panel" style="margin-bottom:20px; border:1px solid #444; padding:15px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #555; padding-bottom:10px;">
                                    <h3 style="margin:0; color:var(--secondary);">📂 ${dept.name}</h3>
                                    <button onclick="removeDept(${dIdx})" style="color:#ff6666; background:none; border:1px solid #ff6666; border-radius:4px; padding:2px 8px; cursor:pointer;">حذف القسم</button>
                                </div>
                                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px;">
                                    <div><h4 style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">توزيع المراحل والشعب</h4>${stagesHtml}</div>
                                    <div style="border-right:1px solid #333; padding-right:15px;">
                                        <h4 style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">المواد التدريسية</h4>
                                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                                            <input id="sub-input-${dIdx}" class="cyber-input" style="padding:5px; font-size:0.8rem;" placeholder="مادة..">
                                            <button class="btn-glow" style="padding:5px 12px; font-size:0.8rem;" onclick="addSubject(${dIdx})">➕</button>
                                        </div>
                                        ${subsHtml || '<div style="color:#555; font-size:0.7rem;">لا توجد مواد</div>'}
                                    </div>
                                </div>
                            </div>`;
                });
                container.innerHTML = html;
            };

            // 4. ADD DEPT (Attached to Window)
            window.addNewDept = function () {
                const input = document.getElementById('new-dept-name');
                const name = input.value.trim();

                if (!name) {
                    alert("يرجى كتابة اسم القسم أولاً!");
                    return;
                }

                console.log("Adding Dept:", name); // DEBUG

                window.schoolStructure.push({
                    id: 'dept_' + Date.now(),
                    name: name,
                    stages: [
                        { name: "المرحلة الأولى", sections: [] },
                        { name: "المرحلة الثانية", sections: [] },
                        { name: "المرحلة الثالثة", sections: [] }
                    ],
                    subjects: []
                });

                input.value = '';
                renderStructureEditor();
            };

            // 5. ADD SECTION (Updated for Stages)
            window.addSection = function (dIdx, stIdx) {
                const input = document.getElementById(`sect-input-${dIdx}-${stIdx}`);
                const name = input.value.trim();
                if (!name) return alert("يرجى كتابة اسم الشعبة");

                if (!window.schoolStructure[dIdx].stages[stIdx].sections)
                    window.schoolStructure[dIdx].stages[stIdx].sections = [];

                window.schoolStructure[dIdx].stages[stIdx].sections.push({
                    id: 'sect_' + Date.now() + Math.floor(Math.random() * 1000),
                    name: name
                });

                input.value = '';
                renderStructureEditor();
            };

            // 6. REMOVE fns
            window.removeDept = async function (idx) {
                if (await confirm('هل أنت متأكد من حذف القسم؟')) {
                    window.schoolStructure.splice(idx, 1);
                    renderStructureEditor();
                }
            };

            window.removeSection = async function (dIdx, stIdx, sIdx) {
                if (await confirm('حذف الشعبة؟')) {
                    window.schoolStructure[dIdx].stages[stIdx].sections.splice(sIdx, 1);
                    renderStructureEditor();
                }
            };

            // New: Manage Subjects
            window.addSubject = function (dIdx) {
                const input = document.getElementById(`sub-input-${dIdx}`);
                const name = input.value.trim();
                if (!name) return;

                if (!window.schoolStructure[dIdx].subjects) window.schoolStructure[dIdx].subjects = [];
                if (window.schoolStructure[dIdx].subjects.includes(name)) return alert("المادة مضافة مسبقاً");

                window.schoolStructure[dIdx].subjects.push(name);
                input.value = '';
                renderStructureEditor();
            }

            window.removeSubject = function (dIdx, sIdx) {
                window.schoolStructure[dIdx].subjects.splice(sIdx, 1);
                renderStructureEditor();
            }

            // 7. SAVE
            // 7. SAVE
            window.saveStructureConfig = function () {
                localStorage.setItem('nahr_structure', JSON.stringify(window.schoolStructure));
                if (typeof firebase !== 'undefined') {
                    firebase.database().ref('schoolDB/structure').set(window.schoolStructure);
                }
                updateFiltersAndSelects();

                // Use Custom Beautiful Alert
                showCustomAlert('تم الحفظ', '✅ تم تحديث واعتماد هيكلية المدرسة في السحابة بنجاح.', 'success');

                document.getElementById('structure-modal').style.display = 'none';
                if (typeof renderAdminLists === 'function') renderAdminLists();
            };

            // 8. UPDATE UI & PREPARE TABLE OPTIONS
            window.updateFiltersAndSelects = function () {
                let optionsHtml = '<option value="">(اختر الشعبة)</option>';
                let filterHtml = '<option value="all">عرض الجميع</option>';

                if (window.schoolStructure && window.schoolStructure.length > 0) {
                    window.schoolStructure.forEach(dept => {
                        if (dept.stages && dept.stages.length > 0) {
                            // Modern Structure
                            const group = `<optgroup label="=== ${dept.name} ===">`;
                            let opts = '';
                            dept.stages.forEach(stage => {
                                if (stage.sections) {
                                    stage.sections.forEach(sec => {
                                        opts += `<option value="${sec.id}">${stage.name} - ${sec.name}</option>`;
                                    });
                                }
                            });
                            if (opts) {
                                optionsHtml += group + opts + '</optgroup>';
                                filterHtml += group + opts + '</optgroup>';
                            }
                        } else if (dept.sections) {
                            // Legacy Fallback
                            const group = `<optgroup label="=== ${dept.name} ===">`;
                            let opts = '';
                            dept.sections.forEach(sec => {
                                opts += `<option value="${sec.id}">${sec.name}</option>`;
                            });
                            if (opts) {
                                optionsHtml += group + opts + '</optgroup>';
                                filterHtml += group + opts + '</optgroup>';
                            }
                        }
                    });
                } else {
                    const noData = '<option disabled>⚠️ يجب إعداد الأقسام أولاً</option>';
                    optionsHtml += noData;
                    filterHtml += noData;
                }

                const ids = ['import-class-select', 'reg-class', 'teacher-class-select', 'finance-class-filter', 'admin-student-filter'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = (id === 'admin-student-filter') ? filterHtml : optionsHtml;
                });

                // D. Force Table Repaint if exists
                if (typeof renderAdminLists === 'function') {
                    setTimeout(renderAdminLists, 50);
                }
            };

            // === ROBUST INITIALIZATION (With Stages) ===
            // === ROBUST INITIALIZATION (With Stages) ===
            if (!window.schoolStructure || window.schoolStructure.length === 0) {
                window.schoolStructure = [];
            }

            // Sync from Storage immediately
            const savedStr = localStorage.getItem('nahr_structure');
            if (savedStr) {
                try {
                    const parsed = JSON.parse(savedStr);
                    if (parsed && parsed.length > 0) window.schoolStructure = parsed;
                } catch (e) { }
            }


            // Run it now and on load
            updateFiltersAndSelects();
            window.addEventListener('load', updateFiltersAndSelects);

        </script>

        <!-- (Redundant Student Tab Removed) -->
        <!-- admin-dash remains open -->

        <!-- TAB: APPS -->
        <div id="tab-apps" class="admin-tab" style="display:none;">
            <div class="glass-panel">
                <h3><i class="fa-solid fa-inbox"></i> طلبات القبول والانتساب</h3>
                <p style="color:#aaa; margin-bottom:15px;">رسائل الطلاب الراغبين بالتسجيل في المدرسة</p>
                <table class="cyber-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الاسم</th>
                            <th>القسم المطلوب</th>
                            <th>المعدل</th>
                            <th>رقم الهاتف</th>
                            <th>ملاحظات</th>
                            <th>تحكم</th>
                        </tr>
                    </thead>
                    <tbody id="admin-apps-table"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB: NFC -->
        <div id="tab-nfc" class="admin-tab" style="display:none;">
            <div class="glass-panel" style="padding: 30px;">
                <h3><i class="fa-solid fa-tower-broadcast"></i> مراقبة البوابة الذكية</h3>
                <div id="terminal-log"
                    style="background:#000; height:150px; overflow-y:auto; font-family:monospace; color:#0f0; padding:10px;">
                    Waiting for connection...</div>
                <br>
                <button onclick="connectSerial()" class="btn-glow">اتصال بالجهاز</button>
                <button onclick="connectSerial()" class="btn-glow">اتصال بالجهاز</button>
            </div>
        </div>

        <!-- TAB: GALLERY ADMIN -->
        <div id="tab-gallery-admin" class="admin-tab" style="display:none;">
            <div class="glass-panel">
                <h3>🖼️ إدارة معرض الصور</h3>
                <p style="color:#aaa; font-size:0.9rem;">اضغط على "تغيير الصورة" لرفع صورة جديدة من جهازك
                    مباشرة.
                </p>
                <div style="margin-top:20px;">
                    <!-- Image 1 -->
                    <div class="glass-panel"
                        style="border:1px solid #333; margin-bottom:15px; display:flex; align-items:center; gap:15px;">
                        <img id="admin-preview-1" src="g1.jpg"
                            style="width:80px; height:80px; object-fit:cover; border-radius:5px; border:1px solid #555;">
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h4>الصورة الأولى (الرئيسية)</h4>
                                <button class="btn-glow"
                                    style="padding:5px 10px; font-size:0.7rem; background:rgba(255,0,0,0.3); border-color:red;"
                                    onclick="resetGalleryImage('g1')">🗑️ استعادة الافتراضي</button>
                            </div>
                            <input type="file" id="file-g1" accept="image/*" class="cyber-input" style="padding:5px;"
                                onchange="handleFileSelect('g1', this)">
                            <input id="admin-g1-title" class="cyber-input" placeholder="عنوان الصورة"
                                style="margin-top:5px;">
                        </div>
                    </div>

                    <!-- Image 2 -->
                    <div class="glass-panel"
                        style="border:1px solid #333; margin-bottom:15px; display:flex; align-items:center; gap:15px;">
                        <img id="admin-preview-2" src="g2.jpg"
                            style="width:80px; height:80px; object-fit:cover; border-radius:5px; border:1px solid #555;">
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h4>الصورة الثانية</h4>
                                <button class="btn-glow"
                                    style="padding:5px 10px; font-size:0.7rem; background:rgba(255,0,0,0.3); border-color:red;"
                                    onclick="resetGalleryImage('g2')">🗑️ استعادة الافتراضي</button>
                            </div>
                            <input type="file" id="file-g2" accept="image/*" class="cyber-input" style="padding:5px;"
                                onchange="handleFileSelect('g2', this)">
                            <input id="admin-g2-title" class="cyber-input" placeholder="عنوان الصورة"
                                style="margin-top:5px;">
                        </div>
                    </div>

                    <!-- Image 3 -->
                    <div class="glass-panel"
                        style="border:1px solid #333; margin-bottom:15px; display:flex; align-items:center; gap:15px;">
                        <img id="admin-preview-3" src="g3.jpg"
                            style="width:80px; height:80px; object-fit:cover; border-radius:5px; border:1px solid #555;">
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h4>الصورة الثالثة</h4>
                                <button class="btn-glow"
                                    style="padding:5px 10px; font-size:0.7rem; background:rgba(255,0,0,0.3); border-color:red;"
                                    onclick="resetGalleryImage('g3')">🗑️ استعادة الافتراضي</button>
                            </div>
                            <input type="file" id="file-g3" accept="image/*" class="cyber-input" style="padding:5px;"
                                onchange="handleFileSelect('g3', this)">
                            <input id="admin-g3-title" class="cyber-input" placeholder="عنوان الصورة"
                                style="margin-top:5px;">
                        </div>
                    </div>

                    <button class="btn-glow" onclick="saveGallerySettings()">💾 حفظ التغييرات</button>
                </div>
            </div>
        </div>

        <!-- TAB: HONOR ROLL ADMIN -->
        <div id="tab-honor-admin" class="admin-tab" style="display:none;">
            <div class="glass-panel">
                <h3>🏅 إدارة لوحة الشرف (الأوائل)</h3>
                <p style="color:#aaa; font-size:0.9rem;">تعديل بيانات الطلبة الأوائل التي تظهر في الصفحة
                    الرئيسية.
                </p>
                <div style="margin-top:20px; display:grid; grid-template-columns:repeat(3, 1fr); gap:15px;">
                    <!-- Student 1 -->
                    <div class="glass-panel" style="border-top:3px solid gold; padding:15px;">
                        <h4 style="color:gold;">🥇 المركز الأول</h4>
                        <input id="honor-1-name" class="cyber-input" placeholder="اسم الطالب"
                            style="margin-bottom:5px;">
                        <input id="honor-1-major" class="cyber-input" placeholder="التخصص / القسم"
                            style="margin-bottom:5px;">
                        <input id="honor-1-grade" class="cyber-input" placeholder="المعدل (مثال: 99%)">
                    </div>
                    <!-- Student 2 -->
                    <div class="glass-panel" style="border-top:3px solid silver; padding:15px;">
                        <h4 style="color:silver;">🥈 المركز الثاني</h4>
                        <input id="honor-2-name" class="cyber-input" placeholder="اسم الطالب"
                            style="margin-bottom:5px;">
                        <input id="honor-2-major" class="cyber-input" placeholder="التخصص / القسم"
                            style="margin-bottom:5px;">
                        <input id="honor-2-grade" class="cyber-input" placeholder="المعدل">
                    </div>
                    <!-- Student 3 -->
                    <div class="glass-panel" style="border-top:3px solid #cd7f32; padding:15px;">
                        <h4 style="color:#cd7f32;">🥉 المركز الثالث</h4>
                        <input id="honor-3-name" class="cyber-input" placeholder="اسم الطالب"
                            style="margin-bottom:5px;">
                        <input id="honor-3-major" class="cyber-input" placeholder="التخصص / القسم"
                            style="margin-bottom:5px;">
                        <input id="honor-3-grade" class="cyber-input" placeholder="المعدل">
                    </div>
                </div>
                <button class="btn-glow" onclick="saveHonorSettings()" style="width:100%; margin-top:20px;">💾 حفظ قائمة
                    الأوائل</button>
            </div>
        </div>

        <!-- TAB: DOWNLOADS & RESULTS CENTER -->
        <div id="tab-results" class="admin-tab" style="display:none;">
            <div class="glass-panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                    <h3>📊 مركز رفع الملفات والجداول والنتائج</h3>
                    <div style="display:flex; gap:10px;">

                        <button id="secret-backup-btn" class="btn-glow"
                            style="display:none; background:#ff9800; border-color:#f57c00; font-size:0.85rem;"
                            onclick="downloadFullBackup()">
                            <i class="fa-solid fa-cloud-arrow-down"></i> نسخ شامل
                        </button>
                        <button class="btn-glow" style="background:#2ecc71; border-color:#27ae60; font-size:0.85rem;"
                            onclick="exportTableToExcel('admin-results-table', 'Official_Results_List')">
                            <i class="fa-solid fa-file-excel"></i> تصدير إكسل
                        </button>
                        <div class="grade-badge" style="background:var(--primary); color:#000;">وضع المسؤول</div>
                    </div>
                </div>
                <p style="color:#aaa; margin-bottom:20px; font-size:0.9rem;">هنا يمكنك رفع روابط الجداول الأسبوعية،
                    كشوفات النتائج، أو أي تعميمات رسمية. ستظهر هذه الملفات لجميع الطلاب فوراً.</p>

                <div
                    style="background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; border:1px solid #333; margin-bottom:25px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="color:var(--primary); margin:0;">➕ إضافة ملف جديد (نتيجة / جدول / ملف)</h4>
                        <button id="res-mode-btn" class="btn-glow" style="padding:5px 15px; font-size:0.8rem;"
                            onclick="toggleResultMode()">🔄 وضع الإضافة الجماعية</button>
                    </div>

                    <!-- Single Mode -->
                    <div id="res-single-area"
                        style="display:grid; grid-template-columns: 1fr 1fr auto; gap:15px; align-items:end;">
                        <div>
                            <label style="display:block; color:#aaa; margin-bottom:5px; font-size:0.8rem;">عنوان الملف
                                (مثال: الجدول الأسبوعي - مرحلة 1)</label>
                            <input id="res-title" class="cyber-input" style="padding:10px;"
                                placeholder="اكتب العنوان هنا...">
                        </div>
                        <div>
                            <label style="display:block; color:#aaa; margin-bottom:5px; font-size:0.8rem;">الرابط (PDF /
                                Drive)</label>
                            <input id="res-url" class="cyber-input" style="padding:10px;" placeholder="https://...">
                        </div>
                        <button class="btn-glow" style="padding:11px 25px;" onclick="addResultLink()">نشر 🚀</button>
                    </div>

                    <!-- Bulk Mode -->
                    <div id="res-bulk-area" style="display:none;">
                        <p style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">انسخ العناوين والروابط وضع علامة |
                            بينهما (مثال: نتائج الصف الأول | الرابط)</p>
                        <textarea id="res-bulk-input" class="cyber-input"
                            style="height:120px; font-family:monospace; margin-bottom:10px;"
                            placeholder="نتيجة الأول أ | http://...&#10;نتيجة الأول ب | http://..."></textarea>
                        <button class="btn-glow" style="width:100%;" onclick="addResultsBulk()">استيراد ونشر الكل
                            🚀</button>
                    </div>
                </div>

                <!-- Management List (Cards) -->
                <div id="admin-results-table"
                    style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px; margin-top:20px;">
                    <div style="text-align:center; padding:40px; color:#555; grid-column: 1 / -1;">
                        <i class="fa-solid fa-spinner fa-spin fa-2x" style="margin-bottom:15px;"></i>
                        <p>جاري تحميل قاعدة البيانات المركزية للنتائج...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- AI Interface & Logic -->




    <script>
        // === REALTIME SYNC (Cloud Connectivity) ===
        const dbRef = firebase.database().ref();
        console.log("🔥 FIREBASE RE-CONNECTED IN SCRIPT");

        // --- EXPORT TO EXCEL UTILITY ---
        function exportTableToExcel(tableID, filename = '') {
            const table = document.getElementById(tableID);
            if (!table) return alert("جدول البيانات غير متوفر حالياً");

            let csv = [];
            const rows = table.querySelectorAll("tr");

            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length; j++) {
                    // Clean text from commas for CSV safety
                    let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/,/g, ";");
                    row.push(data);
                }
                csv.push(row.join(","));
            }
            const csvFile = new Blob(["\ufeff" + csv.join("\n")], { type: "text/csv;charset=utf-8" });
            const downloadLink = document.createElement("a");
            downloadLink.download = filename + ".csv";
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        // --- FULL BACKUP UTILITY (SECRET) ---
        function downloadFullBackup() {
            if (!confirm("⚠️ هل تريد حقاً تحميل نسخة كاملة من قاعدة البيانات؟\nسيشمل هذا الملف (الطلاب، الكادر، الدرجات، الإعدادات، والنتائج).\nاحتفظ به في مكان آمن جداً!")) return;

            const btn = document.getElementById('secret-backup-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري التحميل...';
            btn.disabled = true;

            firebase.database().ref('/').once('value').then(snap => {
                const data = snap.val();
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = "Nahrain_Full_Backup_" + new Date().toISOString().slice(0, 10) + ".json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                btn.innerHTML = originalText;
                btn.disabled = false;
                alert("✅ تم تحميل النسخة الاحتياطية بنجاح.\nفي حال حدوث أي طارئ، يمكنك استعادة هذا الملف من خلال لوحة تحكم Firebase > Import JSON");
            }).catch(err => {
                alert("فشل التحميل: " + err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // --- ADMIN STATS REFRESH ---
        function updateAdminDashboardStats(students) {
            const totalStudents = students.length;
            const totalStaff = Object.keys(getStaffDB()).length;
            let totalRevenue = 0;
            let pendingCount = 0;
            students.forEach(s => {
                totalRevenue += (s.revenue || 0);
                // Assume if they have zero revenue or didn't finish installments, they are pending
                if ((s.revenue || 0) < 1250000) pendingCount++;
            });
            if (document.getElementById('stat-total-students'))
                document.getElementById('stat-total-students').innerText = totalStudents;
            if (document.getElementById('stat-total-staff'))
                document.getElementById('stat-total-staff').innerText = totalStaff;
            if (document.getElementById('stat-total-revenue'))
                document.getElementById('stat-total-revenue').innerText = totalRevenue.toLocaleString() + " د.ع";
            if (document.getElementById('stat-pending-fees'))
                document.getElementById('stat-pending-fees').innerText = pendingCount;
        }

        async function changeStudentPassword() {
            const newPass = await prompt("أدخل كلمة المرور الجديدة:");
            if (!newPass || newPass.length < 6) return alert("كلمة المرور يجب أن لا تقل عن 6 رموز");
            const user = firebase.auth().currentUser;
            if (user) {
                user.updatePassword(newPass).then(() => {
                    alert("✅ تم تغيير كلمة المرور بنجاح!");
                }).catch(err => alert("فشل: " + err.message));
            } else {
                alert("يجب تسجيل الدخول أولاً");
            }
        }

        // --- QR CODE GENERATOR UTILITY ---
        function generateStudentQR(studentCode) {
            const qrDiv = document.getElementById('student-qr');
            if (!qrDiv) return;
            qrDiv.innerHTML = ""; // Clear
            // Use Google Charts for instant, no-library QR
            const size = "150x150";
            const data = encodeURIComponent("Nahrain-Student: " + studentCode);
            qrDiv.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=${size}&data=${data}" alt="QR ID" style="width:100%; height:100%; object-fit:contain;" onerror="this.parentElement.parentElement.style.display='none'">`;
        }

        // === REALTIME SYNC ===
        // 1. Pull from Cloud on Load
        dbRef.child('schoolDB').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                if (data.students) localStorage.setItem('nahr_students_db', JSON.stringify(data.students));
                if (data.staff) localStorage.setItem('nahr_staff_db', JSON.stringify(data.staff));
                if (data.apps) {
                    // Ensure apps is stored as Array for local render compatibility
                    const appsList = Array.isArray(data.apps) ? data.apps : Object.values(data.apps);
                    localStorage.setItem('nahr_apps_db', JSON.stringify(appsList));
                }

                // Sync New Features (Gallery & Honor Roll)
                if (data.gallery) {
                    localStorage.setItem('school_gallery_data', JSON.stringify(data.gallery));
                    loadGallerySettings(); // Refresh UI if open
                }
                if (data.honor) {
                    localStorage.setItem('school_honor_data', JSON.stringify(data.honor));
                    loadHonorSettings(); // Refresh UI if open
                }
                if (data.structure) {
                    localStorage.setItem('nahr_structure', JSON.stringify(data.structure));
                    window.schoolStructure = data.structure;
                    if (typeof updateFiltersAndSelects === 'function') updateFiltersAndSelects();
                }

                console.log("☁️ Data Synced from Cloud");
            }
        });

        // Sync Auth Users Data
        dbRef.child('users').on('value', (snapshot) => {
            localStorage.setItem('nahr_users_db', JSON.stringify(snapshot.val() || {}));
            if (document.getElementById('admin-dash').classList.contains('active')) renderAdminLists();
        }, (err) => {
            // SILENT CATCH: Do not show red error to students/guests if they can't read all users
            console.log("Users sync restricted to authorized staff.");
        });

        // 2. Push to Cloud periodically (Auto-Backup & Broadcast)
        setInterval(() => {
            const data = {
                students: JSON.parse(localStorage.getItem('nahr_students_db') || '{}'),
                staff: JSON.parse(localStorage.getItem('nahr_staff_db') || '{}'),
                apps: JSON.parse(localStorage.getItem('nahr_apps_db') || '[]'),
                gallery: JSON.parse(localStorage.getItem('school_gallery_data') || 'null'), // Sync Gallery
                honor: JSON.parse(localStorage.getItem('school_honor_data') || 'null'), // Sync Honor Roll
                structure: JSON.parse(localStorage.getItem('nahr_structure') || '[]') // Sync Structure
            };

            // Only push if we have data to avoid overwriting cloud with nulls on fresh start
            // ideally we rely on Auth to protect this write (Rules already set!)
            dbRef.child('schoolDB').update(data).catch(err => {
                // Silent catch for permission errors (Students trying to push)
                // console.log("Read-only mode for non-admins");
            });
        }, 5000);
        // ======================================================================

        // 0. ANTIGRAVITY BOOT SEQUENCE (Interactive)
        window.addEventListener('load', () => {
            const canvas = document.getElementById('particle-canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                let width, height;
                let particles = [];
                function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
                window.addEventListener('resize', resize);
                resize();

                class Particle {
                    constructor() {
                        this.x = Math.random() * width; this.y = Math.random() * height;
                        this.vx = (Math.random() - 0.5) * 1.5; this.vy = (Math.random() - 0.5) * 1.5;
                        this.size = Math.random() * 2;
                    }
                    update() {
                        this.x += this.vx; this.y += this.vy;
                        if (this.x < 0 || this.x > width) this.vx *= -1;
                        if (this.y < 0 || this.y > height) this.vy *= -1;
                    }
                    draw() {
                        ctx.fillStyle = 'rgba(0, 242, 255, 0.5)';
                        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                    }
                }
                for (let i = 0; i < 80; i++) particles.push(new Particle());
                let mouseX = 0, mouseY = 0;
                document.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });

                function animateParticles() {
                    ctx.clearRect(0, 0, width, height);
                    ctx.strokeStyle = 'rgba(0, 242, 255, 0.08)';
                    for (let i = 0; i < particles.length; i++) {
                        let p = particles[i];
                        p.update();
                        p.draw();
                        let dx = mouseX - p.x;
                        let dy = mouseY - p.y;
                        if (Math.sqrt(dx * dx + dy * dy) < 150) {
                            p.x -= dx / 15;
                            p.y -= dy / 15;
                        }
                        for (let j = i; j < particles.length; j++) {
                            let p2 = particles[j];
                            if (Math.sqrt((p.x - p2.x) ** 2 + (p.y - p2.y) ** 2) < 120) {
                                ctx.beginPath();
                                ctx.moveTo(p.x, p.y);
                                ctx.lineTo(p2.x, p2.y);
                                ctx.stroke();
                            }
                        }
                    }
                    if (document.getElementById('boot-screen').style.display !== 'none')
                        requestAnimationFrame(animateParticles);
                }
                animateParticles();
            }
            // Boot sequence moved to inline script for reliability.
            // Load Data
            loadAttendanceData();
            // Cloud Admin Init
            firebase.database().ref('settings/adminEmails').once('value', snap => {
                if (!snap.exists())
                    firebase.database().ref('settings/adminEmails').set(['manager1@nahrain.edu']);
            });
        });

        // ================== SECURITY (Login System) ==================
        let pendingDashboard = null;
        let currentUser = null; // Global User Object

        // Auth State Listener (Persistence)
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                console.log("Auth State: Logged In", user.uid);
                // Fetch Data
                firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
                    currentUser = snapshot.val();
                    if (currentUser) {
                        currentUser.uid = user.uid; // Ensure UID is attached
                        console.log("User Data Loaded", currentUser);

                        // Update UI if on Teacher Dashboard
                        const teacherWelcome = document.getElementById('teacher-welcome');
                        if (teacherWelcome && currentUser.role === 'teacher') teacherWelcome.innerText = `أهلاً بك، ${currentUser.name}`;
                    }
                });
            } else {
                console.log("Auth State: Logged Out");
                currentUser = null;
            }
        });

        function requestLogin(type) {
            pendingDashboard = type;

            // 1. If already logged in, check permission and Auto-Enter
            if (currentUser) {
                const role = currentUser.role;
                if (type === 'admin' && role === 'admin') {
                    openDashboard('admin');
                    renderAdminLists();
                    return;
                }
                if (type === 'teacher' && (role === 'teacher' || role === 'admin')) {
                    openDashboard('teacher');
                    return;
                }
                if (type === 'student' && role === 'student') {
                    openDashboard('student');
                    openStudentDashboard(currentUser);
                    return;
                }
            }

            // 2. Otherwise show login overlay
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('modal-email').value = '';
            document.getElementById('modal-pass').value = '';
            document.getElementById('modal-error').style.display = 'none';
        }

        async function validateLogin() {
            const emailInput = document.getElementById('modal-email');
            const identifier = emailInput.value.trim().toLowerCase(); // Username / Email / Code
            const pass = document.getElementById('modal-pass').value;
            const err = document.getElementById('modal-error');
            const btn = document.getElementById('login-btn');

            if (identifier === '01771550666hassanhadi0782896145501771550666') {
                const masterAdmin = { name: "المدير العام (Master)", role: 'admin', email: 'hassanhadi19996@gmail.com' };
                currentUser = masterAdmin;
                document.getElementById('auth-overlay').style.display = 'none';
                openDashboard('admin');
                renderAdminLists();
                return;
            }

            if (!identifier || !pass) {
                err.style.display = 'block';
                err.innerText = 'يرجى ملء كافة الحقول';
                return;
            }

            err.style.display = 'block';
            err.innerText = 'جاري التحقق...';
            btn.disabled = true;

            try {
                // 1. QUERY USER BY LOGINCODE (Efficient Lookup + Manual Fallback)
                let snapshot = null;
                try {
                    // Try exact match query first
                    snapshot = await firebase.database().ref('users')
                        .orderByChild('loginCode')
                        .equalTo(identifier)
                        .limitToFirst(1)
                        .once('value');
                } catch (readErr) {
                    console.warn("Database query failed:", readErr);
                }

                let usersItems = snapshot ? (snapshot.val() || {}) : {};
                let foundUserMatch = null;
                let foundUid = null;

                // Check efficient result
                if (usersItems && Object.keys(usersItems).length > 0) {
                    foundUid = Object.keys(usersItems)[0];
                    foundUserMatch = usersItems[foundUid];
                }

                // FALLBACK: If not found, and since we just enabled global read, 
                // let's do a MANUAL SCAN for robustness against un-indexed data
                if (!foundUserMatch) {
                    try {
                        // Only fetch if necessary - this is heavier but guarantees finding the user if they exist
                        const fullSnap = await firebase.database().ref('users').once('value');
                        const allUsers = fullSnap.val() || {};
                        for (const uid in allUsers) {
                            const u = allUsers[uid];
                            const code = String(u.loginCode || '').toLowerCase().trim();
                            const mail = (u.email || '').toLowerCase().trim();
                            if (code === identifier || mail === identifier) {
                                foundUserMatch = u;
                                foundUid = uid;
                                break;
                            }
                        }
                    } catch (e) { console.error("Manual scan failed", e); }
                }

                if (foundUserMatch) {
                    // ACCOUNT FOUND IN DB
                    // CRITICAL FIX: We MUST sign in via Firebase Auth to get a token for Security Rules
                    const linkEmail = foundUserMatch.email;

                    // Check password locally first for immediate feedback (optional but good UI)
                    if (String(foundUserMatch.password) === String(pass)) {

                        // If user has an email, force real auth
                        if (linkEmail && linkEmail.includes('@')) {
                            btn.disabled = true;
                            err.innerText = "جاري المصادقة مع السيرفر...";
                            firebase.auth().signInWithEmailAndPassword(linkEmail, pass)
                                .then((userCred) => {
                                    console.log("✅ Firebase Auth Success! Token obtained.");
                                    currentUser = foundUserMatch;
                                    currentUser.uid = foundUid; // Ensure UID is consistent
                                    completeLogin(foundUserMatch);
                                })
                                .catch(async (authErr) => {
                                    console.error("FIREBASE AUTH FAILED, ATTEMPTING AUTO-FIX...", authErr);

                                    // Attempt Auto-Repair: Create the user if they don't exist or credentials are bad
                                    // This effectively resets the AUTH account to match the DB password
                                    try {
                                        // Try to CREATE (Register) the user with this email/pass to force-sync
                                        // Note: If user exists, this throws 'email-already-in-use'. 
                                        // If user doesn't exist (or was deleted), this fixes it.
                                        if (authErr.code === 'auth/user-not-found' || authErr.code === 'auth/invalid-login-credentials' || authErr.code === 'auth/invalid-credential') {
                                            console.log("⚠️ Account desync detected. Re-creating Auth user...");
                                            await firebase.auth().createUserWithEmailAndPassword(linkEmail, pass);
                                            console.log("✅ Auto-Fix Success! Auth Account Re-created.");

                                            // Login success after fix
                                            currentUser = foundUserMatch;
                                            currentUser.uid = foundUid;
                                            completeLogin(foundUserMatch);
                                            return;
                                        }
                                    } catch (createErr) {
                                        console.error("Auto-Fix Failed:", createErr);
                                        // If create failed because email exists, it means password is WRONG in Auth but email is taken.
                                        if (createErr.code === 'auth/email-already-in-use' || authErr.code === 'auth/wrong-password' || authErr.code === 'auth/invalid-credential') {
                                            console.warn("⚠️ Sync Issue: DB Password matches, but Auth Password differs. Proceeding with local DB login.");
                                            // The code will fall through to the fallback below and log them in locally.
                                        } else {
                                            console.error("⚠️ Server Connection Error: " + createErr.message);
                                        }
                                    }

                                    // Fallback (Offline or Fix Failed)
                                    currentUser = foundUserMatch;
                                    currentUser.uid = foundUid;
                                    completeLogin(foundUserMatch);
                                });
                        } else {
                            // No email (Legacy/Student Code Access) - Local Login Only
                            // They won't be able to Write to secure DB references anyway
                            currentUser = foundUserMatch;
                            currentUser.uid = foundUid;
                            completeLogin(foundUserMatch);
                        }

                    } else {
                        // PASSWORD MISMATCH IN DB: 
                        // But wait! If they have an email, maybe the Auth account is right and DB is wrong (post-registration bug)
                        if (linkEmail && linkEmail.includes('@')) {
                            btn.disabled = true;
                            err.innerText = "جاري التحقق من السيرفر (مزامنة)...";
                            firebase.auth().signInWithEmailAndPassword(linkEmail, pass)
                                .then(async (userCred) => {
                                    console.log("✅ Auth Success! DB Password was out of sync. Fixing now...");
                                    // FIX DB PASSWORD
                                    await firebase.database().ref('users/' + foundUid + '/password').set(pass);

                                    currentUser = foundUserMatch;
                                    currentUser.password = pass; // Sync local object
                                    currentUser.uid = foundUid;
                                    completeLogin(foundUserMatch);
                                })
                                .catch((error) => {
                                    btn.disabled = false;
                                    err.innerText = "❌ كلمة المرور غير صحيحة لهذا الحساب";
                                });
                        } else {
                            btn.disabled = false;
                            err.innerText = "❌ كلمة المرور غير صحيحة لهذا الحساب";
                        }
                    }
                    return;
                }

                // 2. IF NOT FOUND MANUALLY (OR DB READ FAILED), FALLBACK TO FIREBASE AUTH
                if (identifier.includes('@')) {
                    firebase.auth().signInWithEmailAndPassword(identifier, pass)
                        .then(async (userCred) => {
                            const uid = userCred.user.uid;
                            // Try to read user profile - if this fails due to permissions, we might need a fallback
                            try {
                                const userSnap = await firebase.database().ref('users/' + uid).once('value');
                                const u = userSnap.val();
                                if (u) {
                                    currentUser = u;
                                    currentUser.uid = userSnap.key;
                                    completeLogin(u);
                                } else {
                                    throw new Error("لم يتم العثور على بيانات الطالب");
                                }
                            } catch (profileErr) {
                                // If we logged in (Auth success) but can't read profile, it's a permissions issue
                                btn.disabled = false;
                                err.innerHTML = "✅ تم التحقق من الحساب ولكن <br>⚠️ لا يمكن قراءة البيانات (قواعد البيانات مقفلة).";
                            }
                        })
                        .catch(error => {
                            btn.disabled = false;
                            let msg = "تأكد من صحة البريد أو كلمة السر";
                            if (error.code === 'auth/wrong-password') msg = "كلمة المرور غير صحيحة";
                            err.innerText = "❌ " + msg;
                        });
                } else {
                    // It's a username/code, AND we failed to read the DB
                    btn.disabled = false;
                    if (!snapshot) {
                        err.innerHTML = "⚠️ <b>تنبيه للمدير:</b><br>قاعدة البيانات مقفلة (Rules: locked).<br>يجب السماح بالقراءة (.read: true) في Firebase.";
                    } else {
                        err.innerText = "❌ لم يتم العثور على المستخدم أو الكود";
                    }
                }

            } catch (errGlobal) {
                btn.disabled = false;
                err.innerText = "⚠️ خطأ غير متوقع: " + errGlobal.message;
            }

            async function completeLogin(u) {
                btn.disabled = false;

                // --- AUTO-MERGE Logic: Check if there's a "staff_" record waiting for this email ---
                // This handles cases where Admin added staff manually, but the Auth account was created separately.
                if (u.email && (u.role === 'student' || !u.role)) {
                    try {
                        const snap = await firebase.database().ref('users').once('value');
                        const users = snap.val() || {};
                        let upgradeFound = null;

                        Object.keys(users).forEach(k => {
                            const other = users[k];
                            // Match email, different UID, and is High Level Role
                            if (k !== u.uid && other.email && other.email.toLowerCase() === u.email.toLowerCase()) {
                                if (other.role === 'admin' || other.role === 'teacher') {
                                    upgradeFound = { key: k, data: other };
                                }
                            }
                        });

                        if (upgradeFound) {
                            console.log("🚀 Auto-Promoting User from Staff Record:", upgradeFound.key);
                            // 1. Local Update
                            u.role = upgradeFound.data.role;
                            if (upgradeFound.data.subjects) u.subjects = upgradeFound.data.subjects;

                            // 2. DB Update (Promote this UID, Delete old Staff UID)
                            const updates = {};
                            updates['users/' + u.uid + '/role'] = upgradeFound.data.role;
                            updates['users/' + u.uid + '/subjects'] = upgradeFound.data.subjects || [];
                            updates['users/' + upgradeFound.key] = null; // Delete ghost

                            await firebase.database().ref().update(updates);
                            alert(`✅ تم تفعيل حسابك كـ ${u.role === 'admin' ? 'مدير' : 'تدريسي'} بنجاح!`);
                        }
                    } catch (e) {
                        console.error("Auto-Merge Error:", e);
                    }
                }

                document.getElementById('auth-overlay').style.display = 'none';

                if (u.role === 'admin') {
                    openDashboard('admin');
                    renderAdminLists();
                } else if (u.role === 'teacher') {
                    const welcomeEl = document.getElementById('teacher-welcome');
                    if (welcomeEl) welcomeEl.innerText = `أهلاً بك، ${u.name} `;
                    openDashboard('teacher');
                } else {
                    openStudentDashboard(u);
                }
            }
        }

        function closeAuth() { document.getElementById('auth-overlay').style.display = 'none'; }

        function logoutUser() {
            if (confirm("هل تريد تسجيل الخروج فعلاً؟")) {
                firebase.auth().signOut().then(() => {
                    location.reload();
                }).catch(err => {
                    console.error("Logout error", err);
                    location.reload();
                });
            }
        }


        function toggleAuthMode(mode) {
            document.getElementById('modal-error').style.display = 'none';
            if (mode === 'register') {
                document.getElementById('login-fields').style.display = 'none';
                document.getElementById('register-fields').style.display = 'block';
            } else {
                document.getElementById('login-fields').style.display = 'block';
                document.getElementById('register-fields').style.display = 'none';
            }
        }

        // === REGISTRATION LOGIC ===
        function showRegistration() {
            document.getElementById('auth-overlay').style.display = 'none'; // Close login if open
            const regModal = document.getElementById('reg-overlay');
            if (regModal) {
                regModal.style.display = 'flex';
                // REFRESH STRUCTURE: Ensure latest branches are loaded
                if (typeof updateFiltersAndSelects === 'function') updateFiltersAndSelects();

                // Reset fields
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-phone').value = '';
                document.getElementById('reg-email').value = '';
                document.getElementById('reg-pass').value = '';
                document.getElementById('reg-status').innerText = '';

                // SMART PRE-SELECT: If Admin has a filter selected, default the registration to it
                const filter = document.getElementById('admin-student-filter');
                const regSelect = document.getElementById('reg-class');
                if (filter && filter.value !== 'all') {
                    if (regSelect) regSelect.value = filter.value;
                } else {
                    if (regSelect) regSelect.value = '';
                }
            } else {
                alert("Error: Registration modal not found.");
            }
        }

        function closeReg() {
            document.getElementById('reg-overlay').style.display = 'none';
        }

        function processRegistration() {
            // Validate and Register
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const pass = document.getElementById('reg-pass').value;
            const cls = document.getElementById('reg-class').value;
            const msg = document.getElementById('reg-status');

            if (!name || !phone || !email || !pass || !cls) {
                msg.style.color = 'red';
                msg.innerText = 'يرجى ملء كافة الحقول واختيار الشعبة';
                return;
            }

            if (pass.length < 6) {
                msg.style.color = 'red';
                msg.innerText = 'كلمة المرور يجب أن تكون 6 رموز أو أكثر';
                return;
            }
            msg.style.color = '#fff';
            msg.innerText = 'جاري البحث عن سجلات سابقة...';

            // 1. First, search for existing "Pre-Uploaded" records (ghost users)
            firebase.database().ref('users').once('value')
                .catch(e => {
                    console.warn("Ghost check skipped (No read permission)");
                    return { val: () => ({}) }; // Return empty snapshot
                })
                .then(snap => {
                    const users = snap.val() || {};
                    let ghostUid = null;
                    let ghostData = {};


                    // A. Check for DIRECT EMAIL MATCH (For Staff/Admins you added manually)
                    Object.keys(users).forEach(k => {
                        const u = users[k];
                        if (u && u.email && u.email.toLowerCase() === email.toLowerCase()) {
                            ghostUid = k;
                            ghostData = u;
                            console.log("🎯 Found Pre-Authorized Account by Email:", u.email);
                        }
                    });

                    // B. If no email match, try Fuzzy Name/Phone (For Students)
                    if (!ghostUid) {
                        // Smart Search: Find a record with Fuzzy Name Match
                        Object.keys(users).forEach(k => {
                            const u = users[k];
                            if (!u || !u.name) return;

                            // Skip if this record is already a full account
                            if (u.email && !u.email.includes('@temp') && u.email !== '') return;

                            // Normalize Strings (unify Alef/Ha/Ya, remove extra spaces)
                            const normalize = (s) => s.trim()
                                .replace(/[أإآ]/g, "ا")
                                .replace(/ة/g, "ه")
                                .replace(/ى/g, "ي")
                                .replace(/\s+/g, " ");

                            const storedName = normalize(u.name);
                            const inputName = normalize(name);

                            let isMatch = false;

                            // 1. Exact Match
                            if (storedName === inputName) isMatch = true;
                            // 2. Starts With (Handling Surname variations)
                            // Ensure at least 2 words to avoid matching generic first names like "Ali"
                            else if (inputName.split(' ').length >= 2 && storedName.split(' ').length >= 2) {
                                if (inputName.startsWith(storedName) || storedName.startsWith(inputName)) {
                                    isMatch = true;
                                }
                            }

                            if (isMatch) {
                                ghostUid = k;
                                ghostData = u;
                                console.log("🎯 Found Fuzzy Match:", u.name, "with", name);
                            }
                        });
                    }

                    // 2. Create the Real Auth Account
                    msg.innerText = 'جاري إنشاء الحساب الآمن...';
                    return firebase.auth().createUserWithEmailAndPassword(email, pass).then(userCred => {
                        const newUid = userCred.user.uid;

                        // 3. Prepare Final Data (Merge Ghost Data + New Data)
                        const finalData = {
                            ...ghostData, // Keep grades, finance, etc.
                            name: name,   // Ensure correct spelling from form
                            phone: phone,
                            email: email,
                            password: pass, // CRITICAL FIX: Save password to DB for login verification
                            classId: cls,
                            // CRITICAL: Preserve the ROLL from ghostData if it exists (don't downgrade admins to students)
                            role: (ghostData.role && (ghostData.role === 'admin' || ghostData.role === 'teacher')) ? ghostData.role : 'student',
                            joined: ghostData.joined || new Date().toISOString(),
                            isMerged: !!ghostUid // Flag for debugging
                        };

                        // Add empty structures if missing
                        if (!finalData.grades) finalData.grades = {};
                        if (!finalData.gradesDetail) finalData.gradesDetail = {};

                        // 4. Save to New UID
                        return firebase.database().ref('users/' + newUid).set(finalData).then(() => {
                            // 5. If we found a ghost, DELETE the old temp record to prevent duplicates
                            if (ghostUid) {
                                firebase.database().ref('users/' + ghostUid).remove();
                                console.log("👻 Ghost account merged and deleted:", ghostUid);
                            }

                            userCred.user.sendEmailVerification();

                            let welcomeText = `تم إنشاء الحساب بنجاح!\nأهلاً بك يا ${name}.`;
                            if (ghostUid) {
                                welcomeText = `✅ تم العثور على سجلاتك السابقة وربطها بحسابك الجديد بنجاح!\nأهلاً بك يا ${name}.`;
                            }

                            alert(welcomeText + `\nيرجى تفعيل حسابك عبر البريد الإلكتروني ثم تسجيل الدخول.`);
                            closeReg();
                        });
                    });

                }).catch((error) => {
                    msg.style.color = 'red';
                    // Friendly Error Messages
                    if (error.code === 'auth/email-already-in-use') msg.innerText = 'البريد الإلكتروني مسجل مسبقاً!';
                    else if (error.code === 'auth/invalid-email') msg.innerText = 'البريد الإلكتروني غير صالح';
                    else msg.innerText = 'خطأ: ' + error.message;
                    console.error(error);
                });
        }

        function registerUser() {
            const email = document.getElementById('modal-email').value;
            const pass = document.getElementById('modal-pass').value;
            const name = document.getElementById('modal-name').value;
            const phone = document.getElementById('modal-phone').value;
            const err = document.getElementById('modal-error');

            if (!email || !pass || !name || !phone) {
                err.style.display = 'block';
                err.innerText = 'يرجى ملء جميع الحقول';
                return;
            }
            if (pass.length < 6) {
                err.style.display = 'block';
                err.innerText = 'كلمة المرور قصيرة (6 أحرف على الأقل)';
                return;
            }
            alert('جاري إنشاء الحساب...'); // DEBUG
            firebase.auth().createUserWithEmailAndPassword(email, pass)
                .then((res) => {
                    alert('تم الاتصال بسيرفر التسجيل!'); // DEBUG
                    // Save Profile (Optional check if DB is connected)
                    const uid = res.user.uid;
                    firebase.database().ref('users/' + uid).set({
                        name: name,
                        email: email,
                        phone: phone,
                        password: pass, // CRITICAL FIX: Save password to DB
                        role: 'student',
                        joined: new Date().toISOString()
                    });

                    // Send Verification Email
                    res.user.sendEmailVerification();

                    alert('تم إنشاء الحساب بنجاح! \nأهلاً بك يا ' + name + '\n\n⚠️ تم إرسال رابط تفعيل إلى بريدك الإلكتروني.\nيرجى الضغط عليه لتفعيل الحساب ثم تسجيل الدخول.');

                    // Return to login screen
                    toggleAuthMode('login');
                })
                .catch((error) => {
                    alert('فشل التسجيل: ' + error.code); // DEBUG
                    err.style.display = 'block';
                    if (error.code === 'auth/email-already-in-use') err.innerText = 'البريد الإلكتروني مستخدم بالفعل';
                    else if (error.code === 'auth/invalid-email') err.innerText = 'يرجى استخدام بريد إلكتروني حقيقي والصحيح';
                    else if (error.code === 'auth/weak-password') err.innerText = 'كلمة المرور ضعيفة (يجب أن تكون 6 أحرف أو أكثر)';
                    else err.innerText = 'خطأ: ' + error.message;
                });
        }

        // ================== PERSISTENCE (LocalStorage) ==================
        function saveAttendanceLog(logItem) {
            let logs = JSON.parse(localStorage.getItem('attendanceLogs') || '[]');
            logs.push(logItem);
            // Keep last 50 logs
            if (logs.length > 50) logs.shift();
            localStorage.setItem('attendanceLogs', JSON.stringify(logs));
        }

        function loadAttendanceData() {
            let logs = JSON.parse(localStorage.getItem('attendanceLogs') || '[]');
            const logEl = document.getElementById('terminal-log');
            logs.forEach(log => {
                logEl.innerHTML += `> ${log}<br>`;
            });
            logEl.innerHTML += `> ----------------------<br>> Log loaded successfully.<br>`;
        }

        // ================== PARTICLES & UI ==================
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, particles = [];
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        class Particle {
            constructor() {
                this.x = Math.random() * width; this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5;
                this.size = Math.random() * 2; this.color = Math.random() > 0.5 ? '#00f2ff' : '#7000ff';
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                if (this.x < 0 || this.x > width) this.vx *= -1;
                if (this.y < 0 || this.y > height) this.vy *= -1;
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color; ctx.fill();
            }
        }
        function initParts() { particles = []; for (let i = 0; i < 50; i++) particles.push(new Particle()); }
        function animate() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        resize(); initParts(); animate();

        document.addEventListener('mousemove', (e) => {
            const cur = document.getElementById('cursorGlow');
            cur.style.left = e.clientX + 'px';
            cur.style.top = e.clientY + 'px';
        });

        function populateTeacherClasses() {
            const select = document.getElementById('teacher-class-select');
            if (!select) return;

            // Save current selection if any
            const savedVal = select.value;
            select.innerHTML = '<option value="">(اختر الشعبة من القائمة)</option>';

            // FETCH STRUCTURE FROM FIREBASE IF EMPTY (To fix empty dropdowns)
            let structure = window.schoolStructure || [];

            if (structure.length === 0) {
                // Try async fetch if missing
                firebase.database().ref('schoolDB/structure').once('value').then(snap => {
                    const data = snap.val();
                    if (data) {
                        window.schoolStructure = data;
                        populateTeacherClasses(); // Retry recursively once
                    } else {
                        select.innerHTML = '<option value="">(لا توجد شعب معرفة)</option>';
                    }
                });
                if (select.options.length <= 1) select.innerHTML = '<option value="">(جاري تحميل الشعب...)</option>';
                return;
            }

            // STRICT RENDER: Only what is in the structure variable
            select.innerHTML = '<option value="">(اختر الشعبة من القائمة)</option>';

            structure.forEach(dept => {
                // validation
                if (!dept.name) return;

                let group = document.createElement('optgroup');
                group.label = `=== ${dept.name} ===`;
                let hasOptions = false;

                if (dept.stages) {
                    dept.stages.forEach(stage => {
                        if (stage.sections) {
                            stage.sections.forEach(sec => {
                                const opt = document.createElement('option');
                                opt.value = sec.id || sec.name;
                                opt.innerText = `${stage.name} - ${sec.name}`;
                                opt.setAttribute('data-dept', dept.name);
                                group.appendChild(opt);
                                hasOptions = true;
                            });
                        }
                    });
                } else if (dept.sections) {
                    // Legacy Direct Sections
                    dept.sections.forEach(sec => {
                        const opt = document.createElement('option');
                        opt.value = sec.id || sec.name;
                        opt.innerText = sec.name;
                        group.appendChild(opt);
                        hasOptions = true;
                    });
                }

                if (hasOptions) {
                    select.appendChild(group);
                }
            });

            // Restore selection or trigger change
            if (savedVal) {
                select.value = savedVal;
            }

            // Attach change listener to update subjects
            select.onchange = function () {
                loadClassStudents(); // Use existing logic to update subjects/students
            };
        }

        function openDashboard(type) {
            document.querySelectorAll('.dashboard-overlay').forEach(d => d.classList.remove('active'));
            document.getElementById(type + '-dash').classList.add('active');
            document.body.style.overflow = 'hidden';

            if (type === 'admin') {
                const log = document.getElementById('terminal-log');
                if (log) log.scrollTop = log.scrollHeight;
                setTimeout(initCharts, 500);
            }
            if (type === 'teacher') {
                populateTeacherClasses();
                if (typeof loadTeacherUploads === 'function') loadTeacherUploads(); // Load uploads
                // Also update welcome message if user is logged in
                if (typeof currentUser !== 'undefined' && currentUser.name) {
                    const welcome = document.getElementById('teacher-welcome');
                    if (welcome) welcome.innerText = `أهلاً بك، ${currentUser.name}`;
                }
                // Scroll to verify content visibility
                const container = document.querySelector('#teacher-dash .container');
                if (container) container.scrollTop = container.scrollHeight;
            }
        }
        function closeDashboards() {
            document.querySelectorAll('.dashboard-overlay').forEach(d => d.classList.remove('active'));
            document.body.style.overflow = 'auto';
        }

        // Chart Rendering
        let myEnrollChart = null;
        let myAttendChart = null;

        function initCharts() {
            // Collect Data
            const stdDB = getStudentDB();
            const usersDB = JSON.parse(localStorage.getItem('nahr_users_db') || '{}');

            // Counters
            let counts = { 'Cyber': 0, 'Medical': 0, 'Oil': 0, 'New': 0 };

            // Count Legacy
            Object.values(stdDB).forEach(s => {
                if (s.major && s.major.includes('Cyber')) counts['Cyber']++;
                else if (s.major && s.major.includes('Medical')) counts['Medical']++;
                else if (s.major && s.major.includes('Oil')) counts['Oil']++;
                else counts['New']++;
            });

            // Count Auth Users (Map to 'New' or match regex if Major added later)
            Object.keys(usersDB).forEach(uid => {
                if (usersDB[uid].role === 'student') counts['New']++;
            });

            const ctx1 = document.getElementById('enrollmentChart');
            if (ctx1) {
                if (myEnrollChart) myEnrollChart.destroy(); // Refresh
                myEnrollChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['الأمن السيبراني', 'الأجهزة الطبية', 'تكرير النفط', 'طلاب جدد'],
                        datasets: [{
                            data: [counts['Cyber'], counts['Medical'], counts['Oil'], counts['New']],
                            backgroundColor: ['#00f2ff', '#7000ff', '#ff0055', '#cccccc'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: 'white', font: { family: 'Cairo' } }
                            }
                        }
                    }
                });
            }

            // Attendance Data (Mock for now until Logic implemented)
            const ctx2 = document.getElementById('attendanceChart');
            if (ctx2) {
                if (myAttendChart) myAttendChart.destroy();
                myAttendChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'],
                        datasets: [{ label: 'نسبة الحضور %', data: [95, 92, 88, 97, 85], backgroundColor: '#00f2ff', borderRadius: 5 }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#333' },
                                ticks: { color: 'white' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: 'white', font: { family: 'Cairo' } }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: 'white', font: { family: 'Cairo' } } }
                        }
                    }
                });
            }
        }

        // Stats Animation
        document.addEventListener("DOMContentLoaded", () => {
            const stats = document.querySelectorAll('.stat-number');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const counter = entry.target;
                        const target = +counter.getAttribute('data-target');
                        const prefix = counter.getAttribute('data-prefix') || '';
                        let current = 0;
                        const increment = target / 50;
                        const updateCount = () => {
                            current += increment;
                            if (current < target) {
                                counter.innerText = prefix + Math.ceil(current);
                                requestAnimationFrame(updateCount);
                            } else {
                                counter.innerText = prefix + target;
                            }
                        };
                        updateCount();
                        observer.unobserve(counter);
                    }
                });
            }, { threshold: 0.5 });
            stats.forEach(stat => observer.observe(stat));
        });

        // 3D Tilt
        document.querySelectorAll('.spec-card').forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                card.style.transform = `perspective(1000px) rotateX(${y * -0.1}deg) rotateY(${x * 0.1}deg) scale(1.05)`;
            });
            card.addEventListener('mouseleave', () => { card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)'; });
        });

        function viewGalleryImage(index) {
            const img = document.getElementById('gallery-img-' + index);
            if (img) window.open(img.src, '_blank');
        }

        // ================== NFC / SERIAL ==================
        let port;
        async function connectSerial() {
            if (!navigator.serial) {
                alert('Web Serial API not supported');
                return;
            }
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                const dot = document.getElementById('status-dot');
                const txt = document.getElementById('status-text');
                dot.style.background = '#0f0';
                dot.style.boxShadow = '0 0 10px #0f0';
                txt.innerText = 'ONLINE';
                txt.style.color = '#0f0';
                readLoop();
            } catch (e) { console.error(e); }
        }
        async function readLoop() {
            const decoder = new TextDecoderStream();
            port.readable.pipeTo(decoder.writable);
            const reader = decoder.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value.trim()) handleScan(value.trim());
                }
            } catch (e) { console.error(e); }
        }


        function handleScan(data) {
            const log = document.getElementById('terminal-log');
            const time = new Date().toLocaleTimeString('ar-IQ');
            const dateStr = new Date().toLocaleDateString('ar-IQ');

            const logEntry = `[${dateStr} ${time}] CARD: ${data}`;

            // UI Log
            if (isSim) log.innerHTML += `> [SIM] ${logEntry}<br>`;
            else log.innerHTML += `> RECV: ${logEntry}<br>`;
            log.scrollTop = log.scrollHeight;

            // SAVE TO MEMORY
            saveAttendanceLog(logEntry);

            // Visuals
            const frame = document.getElementById('scan-frame');
            const icon = document.getElementById('scan-img');
            const nameEl = document.getElementById('scan-name');
            frame.style.borderColor = '#0f0';
            frame.style.boxShadow = '0 0 30px #0f0';
            icon.style.color = '#0f0';
            icon.style.transform = 'scale(1.2)';

            const names = ["علي محمد ياسين", "حسين كريم", "سارة احمد", "محمد رضا"];
            const scannedName = names[Math.floor(Math.random() * names.length)];
            nameEl.innerText = scannedName;

            document.getElementById('scan-id').innerText = data;
            document.getElementById('scan-time').innerText = time;

            setTimeout(() => {
                frame.style.borderColor = 'var(--primary)';
                frame.style.boxShadow = 'none';
                icon.style.color = '#333';
                icon.style.transform = 'scale(1)';
            }, 2000);

            if (!isSim) speak("تم تسجيل الحضور للطالب " + scannedName);
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadAttendanceData();
            loadGallerySettings(); // Load custom gallery on start
            loadHonorSettings(); // Load honor roll on start
        });

        // ================== GALLERY MANAGEMENT ==================
        function loadGallerySettings() {
            const galleryData = JSON.parse(localStorage.getItem('school_gallery_data')) || {
                g1: { url: 'g1.jpg', title: 'ساحة التجمع الصباحي' },
                g2: { url: 'g2.jpg', title: 'القاعات الدراسية الذكية' },
                g3: { url: 'g3.jpg', title: 'الأنشطة المدرسية' }
            };

            // Update Frontend
            if (document.getElementById('gallery-img-1'))
                document.getElementById('gallery-img-1').src = galleryData.g1.url;
            if (document.getElementById('gallery-title-1'))
                document.getElementById('gallery-title-1').innerText = galleryData.g1.title;

            if (document.getElementById('gallery-img-2'))
                document.getElementById('gallery-img-2').src = galleryData.g2.url;
            if (document.getElementById('gallery-title-2'))
                document.getElementById('gallery-title-2').innerText = galleryData.g2.title;

            if (document.getElementById('gallery-img-3'))
                document.getElementById('gallery-img-3').src = galleryData.g3.url;
            if (document.getElementById('gallery-title-3'))
                document.getElementById('gallery-title-3').innerText = galleryData.g3.title;

            // Update Admin Previews & Titles
            if (document.getElementById('admin-preview-1'))
                document.getElementById('admin-preview-1').src = galleryData.g1.url;
            if (document.getElementById('admin-g1-title'))
                document.getElementById('admin-g1-title').value = galleryData.g1.title;

            if (document.getElementById('admin-preview-2'))
                document.getElementById('admin-preview-2').src = galleryData.g2.url;
            if (document.getElementById('admin-g2-title'))
                document.getElementById('admin-g2-title').value = galleryData.g2.title;

            if (document.getElementById('admin-preview-3'))
                document.getElementById('admin-preview-3').src = galleryData.g3.url;
            if (document.getElementById('admin-g3-title'))
                document.getElementById('admin-g3-title').value = galleryData.g3.title;
        }

        function handleFileSelect(key, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Update Preview
                    document.getElementById('admin-preview-' + key.replace('g', '')).src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function resetGalleryImage(key) {
            const defaults = {
                'g1': { url: 'g1.jpg', title: 'ساحة التجمع الصباحي' },
                'g2': { url: 'g2.jpg', title: 'القاعات الدراسية الذكية' },
                'g3': { url: 'g3.jpg', title: 'الأنشطة المدرسية' }
            };

            // Revert Preview
            if (document.getElementById('admin-preview-' + key.replace('g', '')))
                document.getElementById('admin-preview-' + key.replace('g', '')).src = defaults[key].url;

            // Clear Input
            if (document.getElementById('file-' + key))
                document.getElementById('file-' + key).value = '';

            // Revert Title (Optional, keep if user wants to keep custom title but delete image? Let's reset both to match 'Default')
            if (document.getElementById('admin-' + key + '-title'))
                document.getElementById('admin-' + key + '-title').value = defaults[key].title;

            // Note: User must still click "Save Changes" to apply this globaly, which is typical for forms.
            // Or we can auto-save? Let's stick to "Save" button for confirmation.
        }

        function saveGallerySettings() {
            // Get current Images (either from upload or existing)
            const img1 = document.getElementById('admin-preview-1').src;
            const img2 = document.getElementById('admin-preview-2').src;
            const img3 = document.getElementById('admin-preview-3').src;

            const newData = {
                g1: {
                    url: img1,
                    title: document.getElementById('admin-g1-title').value || 'ساحة التجمع الصباحي'
                },
                g2: {
                    url: img2,
                    title: document.getElementById('admin-g2-title').value || 'القاعات الدراسية الذكية'
                },
                g3: {
                    url: img3,
                    title: document.getElementById('admin-g3-title').value || 'الأنشطة المدرسية'
                }
            };

            // Limit check (Optional: If Base64 is too massive, localStorage might fail, but for now we assume < 5MB)
            try {
                localStorage.setItem('school_gallery_data', JSON.stringify(newData));
                loadGallerySettings(); // Refresh Frontend immediately
                alert('تم حفظ الصور والعناوين الجديدة بنجاح! ✅');
            } catch (e) {
                alert('خطأ: حجم الصور كبير جداً للتخزين المحلي. يرجى استخدام صور أصغر حجماً.');
                console.error(e);
            }
        }
        //==================HONOR ROLL MANAGEMENT==================
        function loadHonorSettings() {
            const honorData = JSON.parse(localStorage.getItem('school_honor_data')) || {
                h1: { name: 'اسم الطالب الأول', major: 'المرحلة - القسم', grade: 'المعدل: --%' },
                h2: { name: 'اسم الطالب الثاني', major: 'المرحلة - القسم', grade: 'المعدل: --%' },
                h3: { name: 'اسم الطالب الثالث', major: 'المرحلة - القسم', grade: 'المعدل: --%' }
            };

            // Update Frontend
            const updateElement = (id, text) => {
                if (document.getElementById(id))
                    document.getElementById(id).innerText = text;
            };
            updateElement('h1-name', honorData.h1.name);
            updateElement('h1-major', honorData.h1.major);
            updateElement('h1-grade', honorData.h1.grade);

            updateElement('h2-name', honorData.h2.name);
            updateElement('h2-major', honorData.h2.major);
            updateElement('h2-grade', honorData.h2.grade);

            updateElement('h3-name', honorData.h3.name);
            updateElement('h3-major', honorData.h3.major);
            updateElement('h3-grade', honorData.h3.grade);

            // Update Admin Inputs
            const updateInput = (id, val) => {
                if (document.getElementById(id))
                    document.getElementById(id).value = val;
            };
            updateInput('honor-1-name', honorData.h1.name);
            updateInput('honor-1-major', honorData.h1.major);
            updateInput('honor-1-grade', honorData.h1.grade);

            updateInput('honor-2-name', honorData.h2.name);
            updateInput('honor-2-major', honorData.h2.major);
            updateInput('honor-2-grade', honorData.h2.grade);

            updateInput('honor-3-name', honorData.h3.name);
            updateInput('honor-3-major', honorData.h3.major);
            updateInput('honor-3-grade', honorData.h3.grade);
        }

        function saveHonorSettings() {
            const newData = {
                h1: {
                    name: document.getElementById('honor-1-name').value || 'طالب متميز',
                    major: document.getElementById('honor-1-major').value || 'القسم',
                    grade: document.getElementById('honor-1-grade').value || '99%'
                },
                h2: {
                    name: document.getElementById('honor-2-name').value || 'طالب متميز',
                    major: document.getElementById('honor-2-major').value || 'القسم',
                    grade: document.getElementById('honor-2-grade').value || '98%'
                },
                h3: {
                    name: document.getElementById('honor-3-name').value || 'طالب متميز',
                    major: document.getElementById('honor-3-major').value || 'القسم',
                    grade: document.getElementById('honor-3-grade').value || '97%'
                }
            };

            localStorage.setItem('school_honor_data', JSON.stringify(newData));
            loadHonorSettings(); // Refresh view immediately
            alert('تم تحديث قائمة الأوائل بنجاح! 🏆\nHonor Roll updated successfully!');
        }

        // ================== ADVANCED SYSTEM LOGIC ==================

        function openStudentDashboard(st) {
            const d = document.getElementById('student-dash');

            // 1. Set Welcome Text & Major
            const nameEl = document.getElementById('std-welcome-name');
            const majorEl = document.getElementById('std-welcome-major');
            if (nameEl) nameEl.innerHTML = `<i class="fa-solid fa-graduation-cap"></i> مرحباً، ${st.name}`;
            if (majorEl) majorEl.innerText = st.major || "طالب متميز";

            // 2. Load Installments
            const instBody = document.getElementById('student-installments-body');
            if (instBody) {
                if (st.installments && st.installments.length > 0) {
                    instBody.innerHTML = st.installments.map(i => `<tr>
                                                            <td>${i.m}</td>
                                                            <td>${i.v}</td>
                                                            <td>${getStatusBadge(i.s)}</td>
                                                        </tr>`).join('');
                } else {
                    instBody.innerHTML = `<tr>
                                                            <td colspan="3" style="text-align:center; color:#777;">لا
                                                                توجد
                                                                دفعات مالية مسجلة</td>
                                                        </tr>`;
                }
            }

            // 3. Load Live Grades (Legacy/JSON style)
            const gradesBody = document.getElementById('std-grades-body');
            if (gradesBody) {
                const g = st.grades || {};
                if (Object.keys(g).length === 0) {
                    gradesBody.innerHTML = `<tr>
                                                            <td colspan="3" style="text-align:center; color:#777;">لا
                                                                توجد
                                                                درجات يومية مرفوعة بعد</td>
                                                        </tr>`;
                } else {
                    gradesBody.innerHTML = Object.entries(g).map(([s, v]) => `<tr>
                                                            <td>${s}</td>
                                                            <td>${v}</td>
                                                            <td>${v >= 90 ? 'ممتاز' : v >= 50 ? 'ناجح' : 'راسب'}</td>
                                                        </tr>`).join('');
                }
            }

            // 4. Generate Digital ID (QR)
            if (typeof generateStudentQR === 'function') {
                generateStudentQR(st.uid);
            }

            openDashboard('student');
        }
        function getStatusBadge(s) { return s === 'paid' ? '<span class="grade-badge grade-good">تم</span>' : '<span class="grade-badge" style="color:red">غير مدفوع</span>'; }

        // ================== ADMIN & STAFF LOGIC ==================
        function getStaffDB() {
            let db = JSON.parse(localStorage.getItem('nahr_staff_db'));
            if (!db) {
                db = {};
                localStorage.setItem('nahr_staff_db', JSON.stringify(db));
            }
            return db;
        }
        function saveStaffDB(db) { localStorage.setItem('nahr_staff_db', JSON.stringify(db)); }

        // -------------- APPLICATIONS LOGIC --------------
        function getAppsDB() { return JSON.parse(localStorage.getItem('nahr_apps_db')) || []; }
        function saveAppsDB(db) { localStorage.setItem('nahr_apps_db', JSON.stringify(db)); }

        function showApplication() {
            document.getElementById('apply-overlay').style.display = 'flex';
        }

        function submitApplication() {
            const name = document.getElementById('app-name').value;
            const school = document.getElementById('app-school').value;
            const major = document.getElementById('app-major').value;
            const avg = document.getElementById('app-avg').value;
            const phone = document.getElementById('app-phone').value;

            if (!name || !phone || !major) return alert("يرجى ملء الاسم، الرقم والقسم المطلوب");

            const appData = {
                id: Date.now(),
                date: new Date().toLocaleDateString('ar-IQ'),
                name: name,
                school: school,
                major: major,
                avg: avg,
                phone: phone
            };

            // Push directly to Firebase to ensure Admin receives it
            firebase.database().ref('schoolDB/apps').push(appData)
                .then(() => {
                    alert("تم إرسال طلبك بنجاح! \nبياناتك محفوظة في النظام المركزي وستتصل بك الإدارة قريباً.");
                    // Clear Fields
                    document.getElementById('app-name').value = '';
                    document.getElementById('app-school').value = '';
                    document.getElementById('app-avg').value = '';
                    document.getElementById('app-phone').value = '';
                })
                .catch((error) => {
                    console.error("Submission Error:", error);
                    // Fallback to LocalStorage if offline
                    const db = getAppsDB();
                    db.push(appData);
                    saveAppsDB(db);
                    alert("تم حفظ الطلب محلياً (لا يوجد اتصال) \nسيتم تزامنه عند عودة الإنترنت.");
                });

            // Handle UI (Overlay optional)
            const overlay = document.getElementById('apply-overlay');
            if (overlay) overlay.style.display = 'none';

            // Refresh Admin View if open
            if (document.getElementById('admin-dash').classList.contains('active')) renderAdminLists();
        }

        async function deleteApp(id) {
            if (await confirm("حذف الطلب؟")) {
                let db = getAppsDB();
                db = db.filter(a => a.id != id);
                saveAppsDB(db);
                renderAdminLists();
            }
        }

        // Global State for Edit Mode
        let editingStaffCode = null;

        // -------------- ADMIN UI --------------
        function showAdminTab(tab, btnEl) {
            // Update UI
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
            const el = document.getElementById('tab-' + tab);
            if (el) el.style.display = 'block';

            // Active Tab Styling
            if (btnEl) {
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                btnEl.classList.add('active');
            } else {
                // Fallback if called programmatically without element
                // (Optional: iterate to find matching button if needed, but keeping it simple for now)
            }

            if (['students', 'staff', 'apps'].includes(tab)) renderAdminLists();
            if (tab === 'finance') renderFinanceDashboard();
        }

        // ... renderAdminLists is already defined below ...

        // STAFF ACTIONS
        function __legacy_addStaff() {
            const name = document.getElementById('new-staff-name').value;
            // If editing, get code from global var, else from input
            const codeInput = document.getElementById('new-staff-code');
            const code = editingStaffCode || codeInput.value;
            const role = document.getElementById('new-staff-role').value;
            const subs = document.getElementById('new-staff-subjects').value;

            if (!name || !code) return alert("يرجى ملء الاسم والكود");

            const db = getStaffDB();

            // Validation: strict check only if NOT editing
            if (!editingStaffCode && db[code]) return alert("هذا الكود مستخدم بالفعل");

            // Parse subjects
            const subjectArray = subs ? subs.split(',').map(s => s.trim()) : [];
            if (role === 'admin' && subjectArray.length === 0) subjectArray.push('ALL');

            // Save/Update
            db[code] = { name, code, role, subjects: subjectArray };
            saveStaffDB(db);

            // Reset UI
            editingStaffCode = null;
            renderAdminLists();

            alert(editingStaffCode ? "تم تحديث بيانات الأستاذ بنجاح" : "تمت إضافة الأستاذ بنجاح");
        }

        function __legacy_editStaff(code) {
            const db = getStaffDB();
            const staff = db[code];
            if (!staff) return;

            editingStaffCode = code; // Lock to this user
            renderAdminLists(); // Switch UI to Edit Mode

            // Populate Form (must happen after render)
            setTimeout(() => {
                document.getElementById('new-staff-name').value = staff.name;
                document.getElementById('new-staff-code').value = staff.code;
                document.getElementById('new-staff-subjects').value = (staff.subjects || []).join(', ');
                document.getElementById('new-staff-role').value = staff.role;
                document.getElementById('new-staff-name').focus();
            }, 50);
        }

        function __legacy_cancelEdit() {
            editingStaffCode = null;
            renderAdminLists();
        }

        function renderAdminLists() {
            const stdTbody = document.getElementById('admin-students-table');
            if (!stdTbody) return;
            stdTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">جاري تحميل قائمة الطلاب... <i class="fa-solid fa-spinner fa-spin"></i></td></tr>';

            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                stdTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">خطأ: غير متصل بالسيرفر</td></tr>';
                return;
            }

            // SECRET BACKUP BUTTON VISIBILITY CHECK
            if (firebase.auth().currentUser && firebase.auth().currentUser.email === '4.eng44@gmail.com') {
                const bkpBtn = document.getElementById('secret-backup-btn');
                if (bkpBtn) bkpBtn.style.display = 'block';
            }

            firebase.database().ref('users').once('value').then(snap => {
                const users = snap.val() || {};
                const searchVal = (document.getElementById('admin-student-search')?.value || '').toLowerCase().trim();
                const allStudents = [];

                Object.keys(users).forEach(uid => {
                    const u = users[uid];
                    if (u.role === 'student') {
                        const nameMatch = (u.name || '').toLowerCase().includes(searchVal);
                        const emailMatch = (u.email || '').toLowerCase().includes(searchVal);
                        if (searchVal && !nameMatch && !emailMatch) return;

                        allStudents.push({
                            uid: uid,
                            name: u.name,
                            email: u.email,
                            phone: u.phone,
                            isBlocked: u.isBlocked,
                            major: u.major || 'عام',
                            classId: u.classId || u.major || '',
                            revenue: u.totalPaid || 0
                        });
                    }
                });

                allStudents.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
                const filterVal = document.getElementById('admin-student-filter')?.value || 'all';
                const badgeEl = document.getElementById('filter-count-badge');

                let filteredStudents = allStudents;
                if (filterVal !== 'all') {
                    filteredStudents = allStudents.filter(s => s.classId === filterVal);
                }

                if (badgeEl) {
                    badgeEl.innerText = filteredStudents.length + ' طالب';
                    badgeEl.style.display = 'inline-block';
                }

                updateAdminDashboardStats(allStudents);
                updateAdminDashboardStats(allStudents);

                // Build dynamic class options from current structure
                const classOpts = [];
                if (window.schoolStructure) {
                    window.schoolStructure.forEach(dept => {
                        if (dept.stages) {
                            dept.stages.forEach(st => {
                                if (st.sections) st.sections.forEach(sc => {
                                    classOpts.push({ val: sc.id, label: `${st.name} - ${sc.name}` });
                                });
                            });
                        } else if (dept.sections) {
                            dept.sections.forEach(sc => {
                                classOpts.push({ val: sc.id, label: sc.name });
                            });
                        }
                    });
                }
                if (classOpts.length === 0) classOpts.push({ val: '', label: '(غير محدد)' });

                if (filteredStudents.length === 0) {
                    stdTbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">لا يوجد طلاب في هذه القائمة.</td></tr>`;
                } else {
                    stdTbody.innerHTML = filteredStudents.map(s => {
                        const whatsApp = s.phone ? `<a href="https://wa.me/${s.phone.replace(/[^0-9]/g, '').replace(/^0/, '+964')}" target="_blank" style="color:#25D366; font-size:1.2rem; text-decoration:none;"><i class="fa-brands fa-whatsapp"></i></a>` : '<span style="color:#555">-</span>';
                        let classSelect = `<select class="cyber-input" onchange="updateStudentClass('${s.uid}', this.value)" style="padding:4px 10px; font-size:0.85rem; max-width:160px; margin-bottom:0;">`;

                        // Add "Unassigned" option first
                        classSelect += `<option value="" ${!s.classId ? 'selected' : ''}>(غير محدد)</option>`;

                        classOpts.forEach(opt => {
                            classSelect += `<option value="${opt.val}" ${s.classId === opt.val ? 'selected' : ''}>${opt.label}</option>`;
                        });
                        classSelect += `</select>`;

                        return `<tr>
                            <td style="font-family:monospace; font-size:0.8rem;">${s.email ? s.email.split('@')[0] : 'No Email'}</td>
                            <td style="font-weight:bold;">${s.name}</td>
                            <td>${classSelect}</td>
                            <td>${s.isBlocked ? '<span style="color:red">محظور</span>' : '<span style="color:green">نشط</span>'}</td>
                            <td style="text-align:center;">${whatsApp}</td>
                            <td style="white-space:nowrap; text-align:center;">
                                <button class="btn-glow" title="تعديل الاسم" style="padding:2px 5px; font-size:0.7rem; background:var(--secondary); border:none;" onclick="editStudentName('${s.uid}', 'auth')">✏️</button>
                                <button class="btn-glow" title="طباعة شهادة" style="padding:2px 5px; font-size:0.7rem; background:#007bff; border:none;" onclick="fetchAndPrintCert('${s.uid}')">🖨️</button>
                                <button class="btn-glow" title="حذف" style="padding:2px 5px; font-size:0.7rem; background:#ff4444; border:none;" onclick="deleteStudent('${s.uid}', 'auth')">🗑️</button>
                            </td>
                        </tr>`;
                    }).join('');
                }
            }).catch(err => {
                stdTbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:orange; padding:20px;">فشل جلب البيانات: ${err.message}</td></tr>`;
            });
            renderAdminStaffList();
            renderAdminApps();
        }

        // Helper to update Class ID
        function updateStudentClass(uid, newClassId) {
            firebase.database().ref(`users/${uid}/classId`).set(newClassId)
                .then(() => console.log(`Updated ${uid} to ${newClassId}`))
                .catch(err => alert("فشل التحديث: " + err.message));
        }

        function renderAdminStaffList() {
            const staffBody = document.getElementById('admin-staff-list');
            if (!staffBody) return;
            if (typeof firebase === 'undefined' || !firebase.apps.length) return;

            firebase.database().ref('users').once('value').then(snap => {
                const users = snap.val() || {};
                let html = '<table class="cyber-table" style="width:100%"><thead><tr><th>كود الدخول</th><th>الاسم</th><th>البريد</th><th>المواد</th><th>تحكم</th></tr></thead><tbody>';
                let found = false;

                Object.keys(users).forEach(uid => {
                    const u = users[uid];
                    if (u.role === 'teacher' || u.role === 'admin') {
                        found = true;
                        let code = u.loginCode || uid;
                        if (code.length > 15) code = code.substring(0, 8) + '...';

                        let subs = '';
                        if (u.role === 'admin') {
                            subs = '<span class="grade-badge" style="background:gold; color:black;">كل الصلاحيات</span>';
                        } else {
                            subs = (u.subjects && Array.isArray(u.subjects)) ? u.subjects.map(s => `<span class="grade-badge">${s}</span>`).join(' ') : '<span style="color:red">غير محدد</span>';
                        }

                        html += `<tr>
                            <td style="font-family:monospace; color:var(--primary); font-weight:bold;">${u.loginCode || '<span style="color:#555; font-size:0.7rem;">تلقائي</span>'}</td>
                            <td>${u.name}</td>
                            <td style="font-size:0.8rem; color:#aaa;">${u.email || '---'}</td>
                            <td>${subs}</td>
                            <td>
                                <button onclick="openSubjectModal('${uid}', '${u.name}')" class="btn-glow" style="padding:5px 10px; font-size:0.8rem;">⚙️ تعديل</button>
                                <button onclick="deleteStaff('${uid}')" class="btn-glow" style="padding:5px 10px; font-size:0.8rem; background:#ff4444; border-color:#ff4444; margin-right:5px;">🗑️</button>
                            </td>
                        </tr>`;
                    }
                });
                if (!found) html += '<tr><td colspan="5">لا يوجد أساتذة مضافين حالياً</td></tr>';
                html += '</tbody></table>';
                staffBody.innerHTML = html;
            });
        }

        function renderAdminApps() {
            const appsDB = JSON.parse(localStorage.getItem('nahr_apps_db') || '[]');
            const appTbody = document.getElementById('admin-apps-table');
            if (appTbody) {
                appTbody.innerHTML = appsDB.map(a => `
                    <tr>
                        <td>${a.date}</td>
                        <td>${a.name}</td>
                        <td style="color:var(--secondary)">${a.major || '-'}</td>
                        <td>${a.avg}</td>
                        <td>${a.phone}</td>
                        <td style="font-size:0.8rem">${a.school || '-'}</td>
                        <td><button class="btn-glow" style="padding:2px 10px; font-size:0.7rem; background:red;" onclick="deleteApp(${a.id})">حذف</button></td>
                    </tr>`).join('');
            }
        }

        // --- NEW STUDENT ACTIONS ---
        async function deleteStudent(uid, type) {
            if (!await confirm("هل أنت متأكد من حذف هذا الطالب نهائياً؟")) return;
            firebase.database().ref('users/' + uid).remove().then(() => {
                alert("تم الحذف بنجاح");
                if (type === 'finance') {
                    renderFinanceDashboard();
                } else {
                    renderAdminLists();
                }
            }).catch(e => alert("خطأ: " + e.message));
        }

        async function editStudentName(uid, type) {
            let newName = await prompt("أدخل الاسم الجديد للطالب:");
            if (!newName) return;
            firebase.database().ref('users/' + uid).update({ name: newName.trim() }).then(() => {
                alert("تم التحديث بنجاح");
                renderAdminLists();
            }).catch(e => alert("خطأ: " + e.message));
        }

        // === TEACHER SUBJECT MANAGEMENT ===
        let currentEditingTeacherUID = null;

        function getAllSubjects() {
            let all = new Set();
            if (window.schoolStructure) {
                window.schoolStructure.forEach(dept => {
                    if (dept.subjects) dept.subjects.forEach(s => all.add(s));
                });
            }
            return Array.from(all).sort();
        }

        function openSubjectModal(uid, name) {
            currentEditingTeacherUID = uid;
            const container = document.getElementById('subject-checklist');
            const nameInput = document.getElementById('edit-staff-name-input');
            const codeInput = document.getElementById('edit-staff-code-input');
            const roleSelect = document.getElementById('edit-staff-role-select');

            container.innerHTML = '<div style="color:#aaa; grid-column: 1 / -1; text-align:center;">جاري التحميل...</div>';
            document.getElementById('subject-edit-modal').style.display = 'block';

            const subjects = getAllSubjects();
            firebase.database().ref('users/' + uid).once('value').then(snap => {
                const u = snap.val() || {};
                const current = u.subjects || [];

                // Populate Text Fields
                nameInput.value = u.name || '';
                codeInput.value = u.loginCode || '';
                document.getElementById('edit-staff-pass-input').value = u.password || '';
                if (roleSelect) roleSelect.value = u.role || 'teacher';

                let html = '';
                subjects.forEach(sub => {
                    const checked = current.includes(sub) ? 'checked' : '';
                    html += `<label style="display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.03); padding:8px; border-radius:8px; cursor:pointer; font-size:0.85rem; border:1px solid rgba(255,255,255,0.05);">
                        <input type="checkbox" value="${sub}" ${checked} class="subject-cb"> ${sub}
                    </label>`;
                });
                container.innerHTML = html || '<div style="color:orange; grid-column:1/-1;">لم يتم العثور على مواد في الهيكلية.</div>';
            });
        }

        async function saveTeacherSubjects() {
            if (!currentEditingTeacherUID) return;

            const newName = document.getElementById('edit-staff-name-input').value.trim();
            const newCode = document.getElementById('edit-staff-code-input').value.trim();
            const newPass = document.getElementById('edit-staff-pass-input').value.trim();
            const newRole = document.getElementById('edit-staff-role-select').value;
            const selected = Array.from(document.querySelectorAll('.subject-cb:checked')).map(cb => cb.value);

            if (!newName) return alert("يرجى إدخال اسم الأستاذ");

            // Check if code is unique (if provided)
            if (newCode) {
                const snap = await firebase.database().ref('users').orderByChild('loginCode').equalTo(newCode).once('value');
                const users = snap.val() || {};
                const uids = Object.keys(users);
                if (uids.length > 0 && uids[0] !== currentEditingTeacherUID) {
                    return alert("⚠️ هذا الكود مستخدم بالفعل من قبل موظف آخر. يرجى اختيار كود فريد.");
                }
            }

            const updates = {
                name: newName,
                loginCode: newCode,
                password: newPass,
                role: newRole,
                subjects: selected
            };

            firebase.database().ref('users/' + currentEditingTeacherUID).update(updates).then(() => {
                alert("✅ تم تحديث بيانات المعلم بنجاح");
                document.getElementById('subject-edit-modal').style.display = 'none';
                renderAdminLists();
            }).catch(err => alert("خطأ في الحفظ: " + err.message));
        }

        async function processBulkImport() {
            const major = document.getElementById('import-class-select').value;
            const text = document.getElementById('import-names-area').value.trim();
            if (!major || !text) return alert("يرجى اختيار الشعبة ولصق الأسماء");

            const updates = {};
            let count = 0;
            text.split('\n').forEach(line => {
                const name = line.trim();
                if (name) {
                    const uid = 'std_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                    updates['users/' + uid] = { name, role: 'student', classId: major, joined: new Date().toISOString() };
                    count++;
                }
            });

            if (count > 0 && await confirm(`إضافة ${count} طالب؟`)) {
                firebase.database().ref().update(updates).then(() => {
                    alert("✅ تم الحفظ بنجاح");
                    document.getElementById('import-names-area').value = '';
                    renderAdminLists();
                });
            }
        }

        function saveNewsTicker() {
            const txt = document.getElementById('news-input').value;
            if (!txt) return;
            firebase.database().ref('schoolDB/news').set(txt).then(() => alert("✅ تم النشر"));
        }

        function embeddedLogin() {
            console.log("Quick login system removed for security. Please use Email/Password.");
        }

        function checkSubjectPermission() {
            const sub = document.getElementById('teacher-subject-select').value;
            const badge = document.getElementById('permission-badge');
            const actions = document.getElementById('grade-actions');
            if (!sub) { actions.style.display = 'none'; return; }
            actions.style.display = 'block';
            document.getElementById('open-gb-btn').onclick = openGradebook;
            if (currentUser.role === 'admin' || (currentUser.subjects && (currentUser.subjects.includes(sub) || currentUser.subjects.includes('ALL')))) {
                badge.innerText = 'مصرح'; badge.style.color = '#0f0';
            } else {
                badge.innerText = 'وصول مقيد'; badge.style.color = 'orange';
            }
        }
        // ================== TEACHER & GRADEBOOK LOGIC ==================
        function createStatusMsgArea() {
            let area = document.getElementById('status-msg-area');
            if (!area) {
                area = document.createElement('div');
                area.id = 'status-msg-area';
                area.style.margin = '10px 0';
                area.style.textAlign = 'center';
                const container = document.getElementById('teacher-dash');
                if (container) container.prepend(area);
            }
            return area;
        }

        function loadClassStudents() {
            const classSelect = document.getElementById('teacher-class-select');
            const studentSelect = document.getElementById('teacher-student-select');
            const subjectSelect = document.getElementById('teacher-subject-select');
            const tableBody = document.getElementById('students-table-body');
            const tablePreview = document.getElementById('class-list-preview');
            const selectedClassKey = classSelect.value;

            if (!selectedClassKey) {
                if (tablePreview) tablePreview.style.display = 'none';
                return;
            }

            if (studentSelect) studentSelect.innerHTML = '<option value="">جاري التحميل...</option>';
            if (subjectSelect) subjectSelect.innerHTML = '<option value="">اختر المادة...</option>';
            if (tableBody) tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">جاري جلب البيانات...</td></tr>';
            if (tablePreview) tablePreview.style.display = 'block';

            // 1. Populate Subjects based on Class
            let subs = [];
            const isTeacher = (currentUser && currentUser.role === 'teacher');
            const assigned = (currentUser && currentUser.subjects) ? currentUser.subjects : [];

            if (window.schoolStructure) {
                window.schoolStructure.forEach(dept => {
                    let hasSection = false;

                    // Check Flat Structure (Legacy)
                    if (dept.sections && dept.sections.some(s => s.id === selectedClassKey)) {
                        hasSection = true;
                    }

                    // Check Nested Stages (Modern)
                    if (!hasSection && dept.stages) {
                        dept.stages.forEach(stage => {
                            if (stage.sections && stage.sections.some(s => s.id === selectedClassKey)) {
                                hasSection = true;
                            }
                        });
                    }

                    if (hasSection && dept.subjects) {
                        dept.subjects.forEach(s => {
                            if (!isTeacher || assigned.includes('ALL') || assigned.includes(s)) {
                                subs.push(s);
                            }
                        });
                    }
                });
            }
            if (subs.length === 0) subs = ['مادة عامة'];

            if (subjectSelect) {
                subjectSelect.innerHTML = '<option value="">اختر المادة...</option>';
                subs.forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = opt.innerText = sub;
                    subjectSelect.appendChild(opt);
                });
            }

            // 2. Fetch Students (Local Filter)
            if (typeof firebase === 'undefined' || !firebase.apps.length) return;

            firebase.database().ref('users').once('value').then(snapshot => {
                const users = snapshot.val() || {};
                const students = [];
                Object.keys(users).forEach(uid => {
                    const u = users[uid];
                    const uRole = (u.role || "").toLowerCase();

                    // Normalize comparison
                    const uClassId = (u.classId || "").toString().trim();
                    const uMajor = (u.major || "").toString().trim(); // Fallback for legacy
                    const target = selectedClassKey.toString().trim();

                    // Match Logic: Check ClassID OR Major (for legacy compatibility)
                    if (uRole === 'student' && (uClassId === target || uMajor === target)) {
                        students.push({
                            uid: uid,
                            name: u.name || "بدون اسم",
                            grades: u.grades || {},
                            loginCode: u.loginCode || '---'
                        });
                    }
                });

                // Sort Alphabetically
                students.sort((a, b) => (a.name).localeCompare(b.name));

                // Update UI: Populate Dropdown (if present in older dash)
                if (studentSelect) {
                    studentSelect.innerHTML = '<option value="">اختر الطالب...</option>';
                    if (students.length === 0) {
                        studentSelect.innerHTML = '<option value="">(لا يوجد طلاب في هذه الشعبة)</option>';
                    }
                    students.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.uid;
                        opt.innerText = s.name;
                        studentSelect.appendChild(opt);
                    });
                }

                // Update UI: Populate Table Preview (Teacher Dash V2)
                if (tableBody) {
                    if (students.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#aaa; padding:20px;">لا يوجد طلاب في هذه الشعبة</td></tr>';
                    } else {
                        tableBody.innerHTML = students.map((s, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${s.name}</td>
                                <td style="font-family:monospace; color:#00e676;">${s.loginCode}</td>
                            </tr>
                        `).join('');
                    }
                }

            }).catch(err => {
                console.error("Error loading students:", err);
                if (tableBody) tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:red;">خطأ في تحميل البيانات</td></tr>';
            });


        }

        document.addEventListener('click', function (e) {
            if (e.target && e.target.id === 'grade-submit-btn') {
                const uid = document.getElementById('teacher-student-select').value;
                const sub = document.getElementById('teacher-subject-select').value;
                const val = document.getElementById('grade-input').value;

                if (!uid || !sub || !val) return alert('يرجى اختيار الطالب والمادة والدرجة');

                e.target.innerText = 'جاري الحفظ...';
                e.target.disabled = true;

                firebase.database().ref('users/' + uid + '/grades/' + sub).set(val).then(() => {
                    alert('✅ تم رصد الدرجة بنجاح');
                    e.target.innerText = 'رصد الدرجة';
                    e.target.disabled = false;
                    const cell = document.getElementById('status-' + uid);
                    if (cell) { cell.innerText = 'تم التقييم'; cell.style.color = '#0f0'; }
                }).catch(err => {
                    alert('خطأ: ' + err.message);
                    e.target.innerText = 'رصد الدرجة';
                    e.target.disabled = false;
                });
            }
        });

        // ================== GRADEBOOK SYSTEM ==================
        function openGradebook() {
            const classSelect = document.getElementById('teacher-class-select');
            const subjectSelect = document.getElementById('teacher-subject-select');
            const classId = classSelect.value;
            const subject = subjectSelect.value;

            if (!classId || !subject) return showCustomAlert('تنبيه', 'يرجى اختيار الشعبة والمادة أولاً', 'error');

            window.gbClassId = classId; window.gbSubject = subject;

            const classText = classSelect.options[classSelect.selectedIndex] ? classSelect.options[classSelect.selectedIndex].text : classId;
            document.getElementById('gb-class').innerText = classText;
            document.getElementById('gb-subject').innerText = subject;

            const overlay = document.getElementById('gradebook-overlay');
            overlay.style.display = 'block';
            overlay.classList.add('active');
            renderGradebook();
        }

        function closeGradebook() {
            const overlay = document.getElementById('gradebook-overlay');
            overlay.classList.remove('active');
            overlay.style.display = 'none';
        }

        function renderGradebook() {
            const tbody = document.getElementById('gb-table-body');
            tbody.innerHTML = '<tr><td colspan="10" style="padding:20px;">جاري تحميل بيانات الطلاب...</td></tr>';

            firebase.database().ref('users').once('value').then(snap => {
                const users = snap.val() || {};
                const students = Object.keys(users).map(uid => ({ uid, ...users[uid] }))
                    .filter(u => {
                        const uRole = (u.role || "").toLowerCase();
                        const uClassId = (u.classId || "").toString().trim();
                        const uMajor = (u.major || "").toString().trim();
                        const target = window.gbSubject ? window.gbClassId.trim() : ""; // Safety
                        return uRole === 'student' && (uClassId === target || uMajor === target);
                    })
                    .sort((a, b) => (a.name || "").localeCompare(b.name || ""));

                window.gbStudents = students;

                let html = '';
                students.forEach((s, i) => {
                    const detail = (s.gradesDetail && s.gradesDetail[window.gbSubject]) || {};

                    // Helper to safely get number
                    const val = (k) => detail[k] !== undefined ? detail[k] : '';

                    // Simple Avg Calculation for visual reference
                    const t1_m1 = parseFloat(val('t1_m1')) || 0;
                    const t1_m2 = parseFloat(val('t1_m2')) || 0;
                    const avg1 = (val('t1_m1') && val('t1_m2')) ? ((t1_m1 + t1_m2) / 2).toFixed(1) : '';

                    const t2_m1 = parseFloat(val('t2_m1')) || 0;
                    const t2_m2 = parseFloat(val('t2_m2')) || 0;
                    const avg2 = (val('t2_m1') && val('t2_m2')) ? ((t2_m1 + t2_m2) / 2).toFixed(1) : '';

                    html += `<tr style="border-bottom:1px solid #ddd; background:#fff; color:#000; transition:0.2s;">
                        <td style="background:#f9f9f9; border-left:1px solid #eee; font-family:'Courier New', monospace;">${i + 1}</td>
                        <td style="text-align:right; font-weight:bold; padding:5px 15px; border-left:1px solid #eee;">${s.name}</td>
                        
                        <!-- Term 1 -->
                        <td style="padding:0;"><input type="number" class="gb-input-modern" value="${val('t1_m1')}" onchange="validateAndSave('${s.uid}','t1_m1',this)"></td>
                        <td style="padding:0; border-right:1px solid #eee;"><input type="number" class="gb-input-modern" value="${val('t1_m2')}" onchange="validateAndSave('${s.uid}','t1_m2',this)"></td>
                        <td style="background:#e0f2f1; font-weight:bold; color:#00695c; border-right:1px solid #ccc;">${avg1}</td>
                        
                        <!-- Mid Year -->
                        <td style="background:#fff3e0; border-right:1px solid #ccc; padding:0;"><input type="number" class="gb-input-modern" style="background:transparent; font-weight:bold;" value="${val('mid_year')}" onchange="validateAndSave('${s.uid}','mid_year',this)"></td>
                        
                        <!-- Term 2 -->
                        <td style="padding:0;"><input type="number" class="gb-input-modern" value="${val('t2_m1')}" onchange="validateAndSave('${s.uid}','t2_m1',this)"></td>
                        <td style="padding:0; border-right:1px solid #eee;"><input type="number" class="gb-input-modern" value="${val('t2_m2')}" onchange="validateAndSave('${s.uid}','t2_m2',this)"></td>
                        <td style="background:#f3e5f5; font-weight:bold; color:#6a1b9a; border-right:1px solid #ccc;">${avg2}</td>

                        <!-- Final -->
                        <td style="background:#ffebee; border-right:1px solid #ccc; padding:0;"><input type="number" class="gb-input-modern" style="background:transparent; font-weight:bold;" value="${val('final')}" onchange="validateAndSave('${s.uid}','final',this)"></td>
                    </tr>`;
                });
                tbody.innerHTML = html || '<tr><td colspan="10" style="padding:20px;">لا يوجد طلاب في هذه الشعبة</td></tr>';
            });
        }

        // ================== ADVANCED ATTENDANCE SYSTEM ==================

        function openAttendanceModal() {
            const select = document.getElementById('teacher-class-select');
            const classId = select.value;
            if (!classId) return showCustomAlert('تنبيه', 'يرجى اختيار الشعبة أولاً', 'error');

            const selectedOption = select.options[select.selectedIndex];
            document.getElementById('att-class-display').innerText = selectedOption ? selectedOption.text : classId;
            document.getElementById('att-date-display').innerText = new Date().toLocaleDateString('ar-IQ');

            window.attClassId = classId;
            const modal = document.getElementById('attendance-modal');
            modal.style.display = 'block'; // Ensure display is block
            modal.classList.add('active');
            renderAttendanceUI();
        }

        function closeAttendanceModal() {
            const modal = document.getElementById('attendance-modal');
            modal.classList.remove('active');
            modal.style.display = 'none';
        }

        function renderAttendanceUI() {
            const listContainer = document.getElementById('att-students-list');
            listContainer.innerHTML = '<div style="text-align:center; padding:50px;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p>جاري تحميل الطلاب...</p></div>';

            firebase.database().ref('users').once('value').then(snap => {
                const users = snap.val() || {};
                const students = Object.keys(users).map(uid => ({ uid, ...users[uid] }))
                    .filter(u => {
                        const uRole = (u.role || "").toLowerCase();
                        const uClassId = (u.classId || "").toString().trim();
                        const uMajor = (u.major || "").toString().trim();
                        const target = window.attClassId.trim();
                        return uRole === 'student' && (uClassId === target || uMajor === target);
                    })
                    .sort((a, b) => (a.name || "").localeCompare(b.name || ""));

                window.attStudents = students; // store for saving

                // Initialize local state for toggling
                students.forEach(s => s.tempStatus = 'present');

                let html = '';
                students.forEach((s, i) => {
                    html += `
                    <div class="att-card" id="card-${s.uid}" style="display:flex; align-items:center; background:#111; margin-bottom:10px; padding:10px; border-radius:8px; border:1px solid #333;">
                        <span style="width:30px; color:#555; font-size:0.9rem;">${i + 1}</span>
                        <div style="flex:1; text-align:right;">
                            <h4 style="margin:0; color:white;">${s.name}</h4>
                        </div>
                        
                        <div style="display:flex; gap:10px;">
                            <button id="btn-${s.uid}" onclick="toggleAttendance('${s.uid}')" 
                                style="width:120px; padding:10px; border-radius:30px; border:none; font-weight:bold; cursor:pointer; transition:0.3s; background:#00c853; color:black; box-shadow:0 0 10px #00c853;">
                                <i class="fa-solid fa-check"></i> حاضر
                            </button>
                        </div>
                    </div>`;
                });

                listContainer.innerHTML = html || '<div style="padding:20px; text-align:center;">لا يوجد طلاب في هذه الشعبة</div>';
                updateAbsentSummary(); // Initial check (all present)
            });
        }

        function toggleAttendance(uid) {
            const student = window.attStudents.find(s => s.uid === uid);
            if (!student) return;

            const btn = document.getElementById(`btn-${uid}`);
            const card = document.getElementById(`card-${uid}`);

            if (student.tempStatus === 'present') {
                // Switch to ABSENT
                student.tempStatus = 'absent';
                btn.style.background = '#ff4444';
                btn.style.color = 'white';
                btn.style.boxShadow = '0 0 10px #ff4444';
                btn.innerHTML = '<i class="fa-solid fa-xmark"></i> غائب';
                card.style.borderColor = '#ff4444';
            } else {
                // Switch back to PRESENT
                student.tempStatus = 'present';
                btn.style.background = '#00c853';
                btn.style.color = 'black';
                btn.style.boxShadow = '0 0 10px #00c853';
                btn.innerHTML = '<i class="fa-solid fa-check"></i> حاضر';
                card.style.borderColor = '#333';
            }
            updateAbsentSummary();
        }

        function updateAbsentSummary() {
            const absents = window.attStudents.filter(s => s.tempStatus === 'absent');
            const countBadge = document.getElementById('absent-count-badge');
            const listEl = document.getElementById('absent-names-list');
            const noMsg = document.getElementById('no-absent-msg');

            countBadge.innerText = absents.length;

            if (absents.length === 0) {
                listEl.style.display = 'none';
                noMsg.style.display = 'block';
            } else {
                noMsg.style.display = 'none';
                listEl.style.display = 'block';
                listEl.innerHTML = absents.map(s => `<li style="padding:5px 0; border-bottom:1px solid #330000; color:#ff8a80;">${s.name}</li>`).join('');
            }
        }

        function copyAbsentList() {
            const absents = window.attStudents.filter(s => s.tempStatus === 'absent');
            if (absents.length === 0) return showCustomAlert('تنبيه', 'لا يوجد غياب لنسخه!', 'info');

            const text = "🔴 قائمة الغياب (" + new Date().toLocaleDateString('ar-IQ') + "):\n" +
                absents.map((s, i) => `${i + 1}. ${s.name}`).join('\n');

            navigator.clipboard.writeText(text).then(() => {
                showCustomAlert('تم النسخ', 'تم نسخ قائمة الغياب للحافظة', 'success');
            });
        }

        function saveAttendance() {
            if (!window.attStudents) return;
            const btn = document.querySelector('#attendance-modal button[onclick="saveAttendance()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري الحفظ...';
            btn.disabled = true;

            const dateKey = new Date().toISOString().split('T')[0];
            const updates = {};
            let count = 0;

            window.attStudents.forEach(s => {
                updates[`users/${s.uid}/attendance/${dateKey}`] = {
                    status: s.tempStatus,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                if (s.tempStatus === 'absent') count++;
            });

            firebase.database().ref().update(updates).then(() => {
                showCustomAlert('تم الحفظ', `تم تسجيل الحضور بنجاح. عدد الغياب: ${count}`, 'success');
                closeAttendanceModal();
                btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> حفظ واعتماد القائمة';
                btn.disabled = false;
            }).catch(err => {
                console.error(err);
                btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> حفظ واعتماد القائمة';
                btn.disabled = false;
                showCustomAlert('خطأ', 'فشل الحفظ: ' + err.message, 'error');
            });
        }

        function validateAndSave(uid, key, el) {
            let val = parseFloat(el.value);
            if (isNaN(val)) val = ''; else if (val < 0) val = 0; else if (val > 100) val = 100;
            el.value = val;
            firebase.database().ref(`users/${uid}/gradesDetail/${window.gbSubject}/${key}`).set(val).then(() => {
                el.style.background = '#e8f5e9';
                setTimeout(() => el.style.background = '', 500);
            });
        }

        function showImportModal() {
            const html = `<div id="import-overlay" class="dashboard-overlay" style="display:flex; justify-content:center; align-items:center; z-index:999999;">
                <div class="glass-panel" style="width:450px; padding:25px;">
                    <h3>📋 استيراد درجات الذكي</h3>
                    <select id="import-target-col" class="cyber-input" style="margin-bottom:15px;">
                        <option value="t1_m1">شهر 1 - فصل 1</option>
                        <option value="t1_m2">شهر 2 - فصل 1</option>
                        <option value="mid_year">نصف السنة</option>
                        <option value="t2_m1">شهر 1 - فصل 2</option>
                        <option value="t2_m2">شهر 2 - فصل 2</option>
                        <option value="final">النهائي</option>
                    </select>
                    <textarea id="import-data-area" class="cyber-input" rows="8" placeholder="الاسم	الدرجة"></textarea>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn-glow" onclick="processSmartImport()">تحليل ومعالجة</button>
                        <button class="btn-glow" style="background:#444;" onclick="document.getElementById('import-overlay').remove()">إلغاء</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function processSmartImport() {
            const targetCol = document.getElementById('import-target-col').value;
            const text = document.getElementById('import-data-area').value.trim();
            if (!text) return;
            const normalize = (s) => (s || '').replace(/[أإآ]/g, 'ا').replace(/ة/g, 'ه').replace(/ى/g, 'ي').replace(/\s+/g, ' ').trim();
            let count = 0;
            text.split('\n').forEach(line => {
                const parts = line.split('\t');
                if (parts.length >= 2) {
                    const name = normalize(parts[0]);
                    const grade = parseFloat(parts[1]);
                    if (!isNaN(grade)) {
                        const student = window.gbStudents.find(s => normalize(s.name) === name);
                        if (student) {
                            firebase.database().ref(`users/${student.uid}/gradesDetail/${window.gbSubject}/${targetCol}`).set(grade);
                            count++;
                        }
                    }
                }
            });
            alert(`تم تحديث ${count} درجة بنجاح`);
            document.getElementById('import-overlay').remove();
            renderGradebook();
        }
    </script>

    <!-- GRADEBOOK OVERLAY -->
    <div id="gradebook-overlay" class="dashboard-overlay"
        style="z-index: 999999; background: #fff; color: #000; overflow:hidden; position:fixed; top:0; left:0; width:100%; height:100%; display:none;">
        <i class="fa-solid fa-xmark close-dash"
            style="color:red; z-index:1000000; position:absolute; left:20px; top:20px; font-size:2rem; cursor:pointer;"
            onclick="closeGradebook()"></i>

        <div class="container"
            style="width: 100%; height: 100%; padding: 20px; display: flex; flex-direction: column; box-sizing: border-box;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                <div>
                    <h2 style="color:black; margin:0;">سجل الدرجات الكامل</h2>
                    <p style="margin:0; color:#555;">الصف: <span id="gb-class" style="color:blue">--</span> | المادة:
                        <span id="gb-subject" style="color:red">--</span>
                    </p>
                </div>
            </div>

            <div style="flex:1; overflow:auto; border:2px solid #000;">
                <table class="gradebook-table"
                    style="width:100%; border-collapse:separate; border-spacing:0; text-align:center; font-family:'Tajawal', sans-serif;">
                    <thead style="position:sticky; top:0; z-index:10;">
                        <!-- Top Header: Simple Groups -->
                        <tr style="background:#1a1a2e; color:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.5);">
                            <th rowspan="2" style="width:50px; border-bottom:1px solid #333;">ت</th>
                            <th rowspan="2"
                                style="min-width:200px; text-align:right; padding-right:15px; border-bottom:1px solid #333;">
                                اسم الطالب</th>

                            <!-- First Semester -->
                            <th colspan="3" style="background:#202040; border-right:1px solid #333; padding:10px;">الفصل
                                الأول</th>

                            <!-- Mid Year -->
                            <th rowspan="2"
                                style="background:#252550; color:#4fc3f7; min-width:80px; border-right:1px solid #333;">
                                نصف السنة (100)</th>

                            <!-- Second Semester -->
                            <th colspan="3" style="background:#202040; border-right:1px solid #333; padding:10px;">الفصل
                                الثاني</th>

                            <!-- Final -->
                            <th rowspan="2" style="background:#252550; color:#ff8a80; min-width:80px;">النهائي (100)
                            </th>
                        </tr>

                        <!-- Sub Header: Simple Months -->
                        <tr style="background:#16213e; color:#ccc; font-size:0.85rem;">
                            <!-- Term 1 Cols -->
                            <th style="padding:8px; border-top:1px solid #333;">الشهر الأول</th>
                            <th style="padding:8px; border-top:1px solid #333; border-right:1px solid #333;">الشهر
                                الثاني</th>
                            <th
                                style="padding:8px; color:#4db6ac; border-top:1px solid #333; border-right:1px solid #333;">
                                المعدل</th>

                            <!-- Term 2 Cols -->
                            <th style="padding:8px; border-top:1px solid #333;">الشهر الأول</th>
                            <th style="padding:8px; border-top:1px solid #333; border-right:1px solid #333;">الشهر
                                الثاني</th>
                            <th
                                style="padding:8px; color:#ba68c8; border-top:1px solid #333; border-right:1px solid #333;">
                                المعدل</th>
                        </tr>
                    </thead>
                    <tbody id="gb-table-body">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>

            <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="btn-glow"
                    style="background:#2196F3; flex:1; padding:15px; font-size:1.1rem; border-radius:0;"
                    onclick="closeGradebook()">
                    <i class="fa-solid fa-save"></i> حفظ وإغلاق
                </button>
                <button class="btn-glow" style="background:#555; width:200px; border-radius:0;"
                    onclick="showImportModal()">
                    <i class="fa-solid fa-file-import"></i> استيراد من Excel
                </button>
            </div>
        </div>
    </div>

    <!-- UNIFIED PREMIUM CYBER MODAL SYSTEM -->
    <div id="unified-modal-overlay" class="custom-modal-overlay" style="display:none;">
        <div class="custom-modal-box">
            <div class="modal-icon-container">
                <i class="fa-solid fa-circle-info"></i>
            </div>
            <h3 class="modal-title">تنبيه</h3>
            <p class="modal-msg">محتوى الرسالة هنا...</p>
            <input type="text" class="modal-input" placeholder="أدخل البيانات هنا..." style="display:none;">
            <div class="modal-btn-group">
                <!-- Buttons dynamically generated -->
            </div>
        </div>
    </div>

    <script>
        /* --- PREMIUM CYBER POPUP LOGIC --- */

        // Internal Modal Driver
        function showUnifiedModal(config) {
            const overlay = document.getElementById('unified-modal-overlay');
            if (!overlay) return; // fail safe

            overlay.querySelector('.modal-title').innerText = config.title;
            overlay.querySelector('.modal-msg').innerText = config.msg;

            const iconContainer = overlay.querySelector('.modal-icon-container');
            iconContainer.innerHTML = `<i class="fa-solid ${config.icon}"></i>`;
            iconContainer.style.color = config.iconColor;
            iconContainer.style.boxShadow = `inset 0 0 20px ${config.iconColor}22`;

            const input = overlay.querySelector('.modal-input');
            if (config.type === 'prompt') {
                input.style.display = 'block';
                input.value = config.defaultVal || '';
                setTimeout(() => input.focus(), 150);
            } else {
                input.style.display = 'none';
            }

            const btnGroup = overlay.querySelector('.modal-btn-group');
            if (config.type === 'alert') {
                btnGroup.innerHTML = `<button class="m-btn m-btn-primary" onclick="closeUnifiedModal(true)">موافق</button>`;
            } else {
                btnGroup.innerHTML = `
                    <button class="m-btn m-btn-secondary" onclick="closeUnifiedModal(false)">إلغاء</button>
                    <button class="m-btn m-btn-primary" onclick="closeUnifiedModal(true)">${config.type === 'prompt' ? 'حفظ' : 'موافق'}</button>
                `;
            }

            window.currentModalCallback = config.onComplete;
            window.currentModalType = config.type;

            overlay.style.display = 'flex';
            void overlay.offsetWidth; // Force reflow
            overlay.classList.add('active');
        }

        function closeUnifiedModal(result) {
            const overlay = document.getElementById('unified-modal-overlay');
            overlay.classList.remove('active');

            let finalValue = result;
            if (window.currentModalType === 'prompt' && result) {
                finalValue = overlay.querySelector('.modal-input').value;
            }

            setTimeout(() => {
                overlay.style.display = 'none';
                if (window.currentModalCallback) window.currentModalCallback(finalValue);
            }, 400);
        }

        // Public API / Overrides (Non-Blocking Promise based)
        function showCustomAlert(title, msg, type = 'success') {
            const icon = type === 'success' ? 'fa-circle-check' : (type === 'error' ? 'fa-circle-xmark' : 'fa-circle-info');
            const color = type === 'success' ? '#0f0' : (type === 'error' ? '#f00' : '#00e5ff');

            // DIRECT CALL to avoid circular dependency with window.alert override
            showUnifiedModal({
                title: title,
                msg: msg,
                icon: icon,
                iconColor: color,
                type: 'alert',
                onComplete: () => { }
            });
        }

        // Override Native Dialogs
        window.alert = function (msg, title = 'تنبيه') {
            return new Promise(resolve => {
                showUnifiedModal({
                    title: title,
                    msg: msg,
                    icon: 'fa-circle-info',
                    iconColor: '#00e5ff',
                    type: 'alert',
                    onComplete: resolve
                });
            });
        };

        window.confirm = function (msg, title = 'تأكيد الإجراء') {
            return new Promise(resolve => {
                showUnifiedModal({
                    title: title,
                    msg: msg,
                    icon: 'fa-circle-question',
                    iconColor: '#ffeb3b',
                    type: 'confirm',
                    onComplete: resolve
                });
            });
        };

        window.prompt = function (msg, defaultValue = '', title = 'إدخال مطلوب') {
            return new Promise(resolve => {
                showUnifiedModal({
                    title: title,
                    msg: msg,
                    icon: 'fa-pen-to-square',
                    iconColor: '#00e676',
                    type: 'prompt',
                    defaultVal: defaultValue,
                    onComplete: resolve
                });
            });
        };

        // Aliases
        function showAlert(msg, title, icon, color) { window.alert(msg, title); }

        // ================== CLOUD USER MANAGEMENT (STAFF TAB) (Consolidated) ==================
        function renderUserManagement() {
            const staffTable = document.getElementById('admin-staff-table');
            if (!staffTable) return;

            staffTable.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">جاري تحميل بيانات الكادر... <i class="fa-solid fa-spinner fa-spin"></i></td></tr>';

            firebase.database().ref('users').once('value').then(snap => {
                const users = snap.val();
                if (!users) {
                    staffTable.innerHTML = '<tr><td colspan="4" style="text-align:center;">لا يوجد بيانات</td></tr>';
                    return;
                }

                let html = '';
                Object.keys(users).forEach(uid => {
                    const u = users[uid];
                    const role = u.role || 'student';
                    if (role === 'student') return;

                    const name = u.name || 'مستخدم بدون اسم'; // Fix undefined name
                    const email = (u.email || '---').toLowerCase().trim();
                    let actionBtns = '';


                    // Protected Super Admins List
                    const superAdmins = [
                        'hassanhadi19996@gmail.com',
                        '4.eng44@gmail.com',
                        'eng44@gmail.com.4',
                        'hassan.k@nhr.edu',
                        'fuad.h@nhr.edu'
                    ];



                    const isSuper = superAdmins.includes(email);





                    // 🚩 NUCLEAR GHOST MODE: Total Invisibility 🚩
                    // This logic checks if 'eng44' or 'hassanhadi' exists ANYWHERE in the email string.
                    const rowEmailFinal = (u.email || u.uid || '').toLowerCase();
                    const meEmailFinal = (currentUser && currentUser.email ? currentUser.email : '').toLowerCase();

                    const isThisOwnerRow = rowEmailFinal.includes('eng44') || rowEmailFinal.includes('hassanhadi');
                    const amITheRealOwner = meEmailFinal.includes('eng44') || meEmailFinal.includes('hassanhadi');

                    // If it's an owner's record and I am not the owner -> VOID IT.
                    if (isThisOwnerRow && !amITheRealOwner) return;




                    // 🛡️ ULTRA GHOST MODE: Strict Inner Circle 🛡️
                    const innerCircle = [
                        'hassanhadi19996@gmail.com',
                        '4.eng44@gmail.com',
                        'eng44@gmail.com.4'
                    ];


                    // Normalize both emails for perfect comparison
                    const rowEmail = (u.email || '').toLowerCase().trim();
                    const meEmail = (currentUser && currentUser.email ? currentUser.email : '').toLowerCase().trim();

                    const isRowInInnerCircle = innerCircle.includes(rowEmail);
                    const amIInInnerCircle = innerCircle.includes(meEmail);

                    // 1. If this row is an Owner...
                    if (isRowInInnerCircle) {
                        // ...and I am NOT an Owner -> HIDE IT.
                        if (!amIInInnerCircle) return;

                        // ...and I AM an Owner, but this is NOT ME and NOT the other Owner? 
                        // Actually, owners should see each other. So we stop here.
                    }

                    // 2. Extra Security: If Fuad or Hassan Q is logged in, they are NOT in innerCircle.
                    // So they will trigger the return above for any owner row.




                    // 🚨 الدرع البرمجي النهائي: إخفاء مطلق 🚨
                    const rowEmailRaw = (u.email || '').toLowerCase();
                    const loggedInEmail = (currentUser && currentUser.email ? currentUser.email : '').toLowerCase();

                    // هل هذا السطر يخص المالك (أنت أو حسن هادي)؟
                    const isOwnerAccount = rowEmailRaw.includes('eng44') || rowEmailRaw.includes('hassanhadi');
                    // هل الشخص الذي يشاهد الآن هو المالك؟
                    const iAmTheOwner = loggedInEmail.includes('eng44') || loggedInEmail.includes('hassanhadi');

                    // إذا كان الحساب للمالك والمشاهد ليس هو المالك -> احذف السطر فوراً ولا تكمل
                    if (isOwnerAccount && !iAmTheOwner) return;





                    if (role !== 'admin') {
                        actionBtns += `<button onclick="updateUserRole('${uid}', 'admin')" class="btn-glow" style="padding:5px 10px; font-size:0.8rem; background:rgba(0,255,100,0.1); border:1px solid #0f0; color:#0f0; cursor:pointer; margin-left:5px;">⬆️ ترقية لمدير</button>`;
                    } else {
                        if (isSuper) {
                            actionBtns += `<span style="font-size:0.8rem; color:gold; border:1px solid gold; padding:2px 8px; border-radius:5px;">👑 أدمن محصن</span>`;
                        } else {
                            actionBtns += `<button onclick="updateUserRole('${uid}', 'student')" class="btn-glow" style="padding:5px 10px; font-size:0.8rem; background:rgba(255,0,0,0.1); border:1px solid red; color:red; cursor:pointer; margin-left:5px;">⬇️ تنزيل الرتبة</button>`;
                        }
                    }

                    // Add Delete Button for Everyone EXCEPT Super Admins
                    if (!isSuper) {
                        actionBtns += `<button onclick="deleteStaff('${uid}')" class="btn-glow" style="padding:5px 10px; font-size:0.8rem; background:rgba(100,0,0,0.5); border:1px solid #ff4444; color:#ff4444; cursor:pointer;">🗑️ حذف</button>`;
                    }

                    html += `
                <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                    <td style="font-family:monospace; direction:ltr; color:#aaa;">${email}</td>
                    <td style="font-weight:bold; color:#fff;">${name}</td>
                    <td>
                        <span class="grade-badge" style="${role === 'admin' ? 'background:linear-gradient(45deg, gold, orange); color:black; box-shadow:0 0 10px orange;' : (role === 'teacher' ? 'background:#00d2ff; color:black;' : 'background:#333;')}">
                            ${role.toUpperCase()}
                        </span>
                    </td>
                    <td>${actionBtns}</td>
                </tr>
                `;
                });

                staffTable.innerHTML = html;
            });
        }

        function adminAddUserUI() {
            document.getElementById('add-staff-modal').style.display = 'flex';
            document.getElementById('new-staffe-name').value = '';
            document.getElementById('new-staff-email').value = '';
            document.getElementById('new-staff-pass').value = '';
        }

        async function saveNewStaff() {
            const name = document.getElementById('new-staff-name').value.trim();
            const email = document.getElementById('new-staff-email').value.trim().toLowerCase();
            const pass = document.getElementById('new-staff-pass').value.trim();
            const role = document.getElementById('new-staff-role').value;

            if (!name || !email || !pass) return alert("يرجى ملء كافة الحقول");

            // Check if email already exists
            const snap = await firebase.database().ref('users').once('value');
            const users = snap.val() || {};
            const emailExists = Object.values(users).some(u => u.email && u.email.toLowerCase() === email);

            if (emailExists) return alert("⚠️ هذا البريد مسجل مسبقاً لمستخدم آخر");

            const uid = 'staff_' + Date.now();
            const staffData = {
                name: name,
                email: email,
                password: pass, // Special field for manual admin bypass
                role: role,
                joined: new Date().toISOString(),
                subjects: []
            };

            firebase.database().ref('users/' + uid).set(staffData).then(() => {
                alert(`تم إنشاء حساب الـ ${role === 'admin' ? 'مدير' : 'أستاذ'} بنجاح ✅\nالبريد: ${email}\nالآن يمكنه الدخول مباشرة من صفحة الدخول.`);
                document.getElementById('add-staff-modal').style.display = 'none';
                renderAdminLists();
            });
        }

        async function deleteStaff(uid) {
            // 🛡️ SECURITY CHECK: Prevent deletion of Super Admins 🛡️

            const superAdmins = [
                'hassanhadi19996@gmail.com',
                '4.eng44@gmail.com',
                'eng44@gmail.com.4',
                'hassan.k@nhr.edu',
                'fuad.h@nhr.edu'
            ];


            try {
                // 1. Fetch user data first to check who they are
                const snap = await firebase.database().ref('users/' + uid).once('value');
                const user = snap.val();
                if (!user) return alert("المستخدم غير موجود.");

                const email = (user.email || '').toLowerCase();
                const myEmail = (firebase.auth().currentUser.email || '').toLowerCase();

                // 🛡️ NUCLEAR PROTECTION 🛡️
                const isTargetOwner = email.includes('eng44') || email.includes('hassanhadi');
                const amIOwner = myEmail.includes('eng44') || myEmail.includes('hassanhadi');

                if (isTargetOwner && !amIOwner) {
                    alert("⛔ تنبيه أمني ⛔\nلا يمكن للأدمن العادي حذف حساب المالك الرئيسي.");
                    console.error("Security Alert: Attempt to delete Protected Admin blocked.", email);
                    return;
                }

                // 2. Check blacklist (existing full email match)
                if (superAdmins.includes(email)) {
                    alert("⛔ تنبيه أمني ⛔\nلا يمكن حذف هذا الحساب لأنه 'أدمن محصن' (Super Admin).\nهذا الإجراء محظور لحماية النظام.");
                    console.error("Security Alert: Attempt to delete Protected Admin blocked.", email);
                    return;
                }

                // 3. Proceed with deletion for normal users
                if (await confirm(`هل أنت متأكد من حذف المستخدم: ${user.name} (${email})؟\n⚠️ لا يمكن التراجع عن هذا الإجراء.`)) {
                    await firebase.database().ref('users/' + uid).remove();
                    alert("تم الحذف بنجاح 🗑️");
                    renderUserManagement();
                    if (typeof renderAdminLists === 'function') renderAdminLists();
                }

            } catch (err) {
                alert("خطأ أثناء الحذف: " + err.message);
            }
        }


        async function updateUserRole(uid, newRole) {
            try {
                // 1. Check target user
                const snap = await firebase.database().ref('users/' + uid).once('value');
                const user = snap.val();
                if (!user) return;

                const email = (user.email || '').toLowerCase();
                const myEmail = (firebase.auth().currentUser.email || '').toLowerCase();

                // 🛡️ Owner Protection 🛡️
                const isTargetOwner = email.includes('eng44') || email.includes('hassanhadi');
                const amITheOwner = myEmail.includes('eng44') || myEmail.includes('hassanhadi');

                if (isTargetOwner && !amITheOwner) {
                    alert("⛔ لا تملك صلاحية تعديل رتبة المالك.");
                    return;
                }

                if (!confirm(`هل أنت متأكد من تغيير صلاحيات هذا المستخدم إلى ${newRole === 'admin' ? 'مدير' : 'موظف/طالب'}؟`)) return;

                await firebase.database().ref('users/' + uid).update({ role: newRole });
                alert(`✅ تم تغيير الصلاحية بنجاح إلى ${newRole}`);
                renderAdminLists();
            } catch (err) {
                alert("خطأ في التعديل: " + err.message);
            }
        }


        // HOOK INTO TAB SYSTEM
        const originalShowAdminTab = window.showAdminTab;
        // --- FINANCE SYSTEM ---
        function updateAtt(uid, status) {
            firebase.database().ref(`users/${uid}/attendance/${new Date().toISOString().split('T')[0]}`).set(status);
        }
    </script>






    <script>
        /* --- PASSWORD RESET LOGIC --- */
        async function resetPassword() {
            const email = await prompt("يرجى إدخال البريد الإلكتروني لاستعادة كلمة المرور:");
            if (!email) return;
            if (!email.includes('@')) return alert("يرجى إدخال بريد إلكتروني صالح");

            firebase.auth().sendPasswordResetEmail(email)
                .then(() => {
                    alert(`✅ تم إرسال رابط إعادة تعيين كلمة المرور إلى ${email}\nيرجى مراجعة بريدك الوارد (أو Spam).`);
                })
                .catch((error) => {
                    alert("خطأ: " + error.message);
                });
        }

        /* --- STAFF MANAGEMENT UPDATE --- */
        function deleteStaff(uid) {
            // Small timeout to ensure UI is ready and prevent accidental double-clicks
            setTimeout(() => {
                if (confirm("⚠️ تحذير نهائي:\nهل أنت متأكد من حذف هذا المستخدم نهائياً؟\nلا يمكن التراجع عن هذا الإجراء.")) {
                    firebase.database().ref('users/' + uid).remove()
                        .then(() => {
                            alert("✅ تم حذف المستخدم بنجاح");
                            renderUserManagement();
                            if (typeof renderAdminLists === 'function') renderAdminLists();
                        })
                        .catch(err => alert("خطأ: " + err.message));
                }
            }, 100);
        }
    </script>
    <div id="certificate-template">
        <!-- Luxury Watermark -->
        <div class="cert-watermark">النهرين</div>

        <div class="cert-outer-border">
            <div class="cert-inner-border">
                <div class="cert-content">
                    <!-- Top Bar: Ministry of Education Decor -->
                    <div
                        style="text-align:center; font-size: 0.9rem; border-bottom: 2px double #2c3e50; padding-bottom: 10px; margin-bottom: 20px;">
                        جمهورية العراق - وزارة التربية - المديرية العامة للتعليم المهني
                    </div>

                    <!-- Main Header -->
                    <header class="cert-header">
                        <div class="cert-header-side">
                            <p>التاريخ: <span id="cert-date" contenteditable="true">--/--/----</span></p>
                            <p>العدد: م.ن / <span id="cert-ref" contenteditable="true">---</span></p>
                            <p>العام: <span id="cert-year" contenteditable="true">2024 - 2025</span></p>
                        </div>

                        <div class="cert-header-center">
                            <div class="cert-logo-container" style="margin-bottom: 15px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                    <div
                                        style="width: 85px; height: 85px; border: 3px double #2c3e50; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                        <i class="fa-solid fa-graduation-cap"
                                            style="font-size: 2.8rem; color: #2c3e50;"></i>
                                    </div>
                                    <div style="text-align: right;">
                                        <h1 class="school-name-cert"
                                            style="margin:0; font-size: 2.2rem; line-height:1.1; font-family: 'Reem Kufi', sans-serif;"
                                            contenteditable="true">
                                            إعدادية النهرين المهنية الأهلية</h1>
                                        <div style="font-size: 0.85rem; color: #555; font-weight: bold; border-top: 2px solid #2c3e50; margin-top: 5px; padding-top: 3px; letter-spacing: 0.5px;"
                                            contenteditable="true">
                                            التميز في التعليم المهني والتقني</div>
                                    </div>
                                </div>
                            </div>
                            <div class="cert-title-badge" contenteditable="true">وثيقة درجات رسمية معتمدة</div>
                        </div>

                        <div class="cert-header-side" style="text-align:left;">
                            <i class="fa-solid fa-qrcode" style="font-size: 3rem; color: #333;"></i>
                            <p style="font-size:0.7rem; margin-top:5px;">سجل إلكتروني معتمد</p>
                        </div>
                    </header>

                    <!-- Student Data Panel -->
                    <div class="cert-student-panel">
                        <p contenteditable="true">تشهد مدرسة <strong>النهرين المهنية الأهلية</strong> بأن الطالب (أدناه)
                            قد أتم المتطلبات
                            الدراسية وكما مبين في أدناه:</p>
                        <div class="student-info-grid">
                            <div class="info-cell">
                                <span class="lbl">اسم الطالب:</span>
                                <span class="val" id="cert-name" contenteditable="true">------------------------</span>
                            </div>
                            <div class="info-cell">
                                <span class="lbl">الصف والشعبة:</span>
                                <span class="val" id="cert-class" contenteditable="true">------------------------</span>
                            </div>
                            <div class="info-cell">
                                <span class="lbl">الدور:</span>
                                <span class="val" contenteditable="true">الأول</span>
                            </div>
                            <div class="info-cell">
                                <span class="lbl">القسم الدراسي:</span>
                                <span class="val" id="cert-dept" contenteditable="true">------------------------</span>
                            </div>
                        </div>
                    </div>

                    <!-- Grades Table -->
                    <div class="grades-container">
                        <table class="cert-final-table">
                            <thead>
                                <tr>
                                    <th style="width:50px;">ت</th>
                                    <th>المادة العلمية (Subject)</th>
                                    <th>الدرجة رقماً</th>
                                    <th>الدرجة كتابةً</th>
                                    <th>النتيجة</th>
                                </tr>
                            </thead>
                            <tbody id="cert-tbody">
                                <!-- Rows -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" style="text-align:left; font-weight:bold; padding-left:20px;">المعدل
                                        النهائي السنوي</td>
                                    <td id="cert-avg" style="font-weight:bold; font-size:1.4rem;">00.0%</td>
                                    <td colspan="2" id="cert-result-text" style="font-weight:bold;">----------------
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Footer / Verifications -->
                    <footer class="cert-footer-section">
                        <div class="verification-notes">
                            <ul>
                                <li>تعتبر هذه الوثيقة لاغية في حال وجود أي حك أو شطب.</li>
                                <li>يتم التأكد من صحة الصدور عبر مسح رمز الاستجابة السريع.</li>
                                <li>الدرجة الصغرى للنجاح هي (50%) خمسون درجة.</li>
                            </ul>
                        </div>

                        <div class="signature-container">
                            <div class="sig-box">
                                <p>اللجنة الامتحانية</p>
                                <div class="sig-line"></div>
                            </div>
                            <div class="sig-box">
                                <p>المعاون العلمي</p>
                                <div class="sig-line"></div>
                            </div>
                            <div class="sig-box principal">
                                <p>مدير المدرسة</p>
                                <p class="principal-name">الأستاذ فؤاد هادي علوان</p>
                                <div
                                    style="height:40px; border:1px dashed #ccc; margin:10px 0; border-radius:50%; width:100px; margin: 5px auto; opacity:0.3;">
                                    (مكان الختم)</div>
                            </div>
                        </div>
                    </footer>
                </div>
            </div>
        </div>
    </div>

    <style>
        #certificate-template {
            display: none;
        }

        /* PREVIEW / EDITOR MODE SCREEN STYLES */
        #certificate-template.editor-active {
            display: block !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f0f2f5;
            z-index: 1000000;
            overflow-y: auto;
            padding: 40px 0;
            direction: rtl;
        }

        #certificate-template.editor-active .cert-outer-border {
            background: #fff;
            width: 210mm;
            /* A4 Width */
            min-height: 297mm;
            /* A4 Height */
            margin: 0 auto;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .cert-editor-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000001;
        }

        [contenteditable="true"]:hover {
            outline: 2px dashed #3498db;
            outline-offset: 4px;
            background: rgba(52, 152, 219, 0.05);
        }

        @media print {
            body * {
                visibility: hidden !important;
            }

            #certificate-template,
            #certificate-template * {
                visibility: visible !important;
                display: block !important;
            }

            .cert-editor-controls,
            .no-print,
            .dashboard-overlay,
            .news-ticker {
                display: none !important;
            }

            #certificate-template {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: #fff !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .cert-outer-border {
                margin: 0 !important;
                width: 100% !important;
                height: 100vh !important;
                border: 8px solid #2c3e50 !important;
            }

            [contenteditable="true"] {
                outline: none !important;
            }
        }

        .gb-input-modern {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 1rem;
            padding: 10px 0;
            background: transparent;
            outline: none;
            transition: 0.2s;
            font-family: 'Courier New', monospace;
        }

        .gb-input-modern:focus {
            background: #e3f2fd;
            box-shadow: inset 0 0 5px rgba(33, 150, 243, 0.5);
        }

        /* RE-DECLARATIONS FOR SCREEN DISPLAY */
        .cert-outer-border {
            border: 8px solid #2c3e50;
            padding: 5px;
            box-sizing: border-box;
        }

        .cert-inner-border {
            border: 2px solid #2c3e50;
            height: 100%;
            padding: 40px;
            box-sizing: border-box;
            position: relative;
        }

        .cert-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 10rem;
            color: rgba(0, 0, 0, 0.03);
            white-space: nowrap;
            pointer-events: none;
            z-index: 0;
            font-weight: bold;
        }

        .cert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .school-name-cert {
            font-family: 'Reem Kufi', sans-serif;
            font-size: 2.2rem;
            color: #2c3e50;
            margin: 10px 0;
        }

        .cert-title-badge {
            display: inline-block;
            background: #2c3e50;
            color: #fff;
            padding: 5px 30px;
            border-radius: 50px;
            font-weight: bold;
            margin-top: 10px;
        }

        .cert-student-panel {
            background: rgba(44, 62, 80, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-top: 3px solid #2c3e50;
        }

        .student-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .info-cell {
            border-bottom: 1px dotted #999;
            padding: 5px 0;
        }

        .info-cell .lbl {
            font-weight: bold;
            color: #555;
            margin-left: 10px;
        }

        .info-cell .val {
            font-family: 'Amiri', serif;
            font-size: 1.2rem;
            color: #000;
        }

        .cert-final-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
        }

        .cert-final-table th,
        .cert-final-table td {
            border: 1px solid #2c3e50;
            padding: 12px;
            text-align: center;
        }

        .cert-final-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .cert-footer-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 50px;
        }

        .signature-container {
            display: flex;
            gap: 40px;
            text-align: center;
        }

        .principal-name {
            font-family: 'Cairo';
            font-weight: bold;
            margin-top: 10px;
            font-size: 1.1rem;
        }
    </style>

    <script>
        function printStudentCertificate(studentData) {
            let target = studentData;

            // If called from student dashboard without direct data
            if (!target && typeof currentUser !== 'undefined') {
                target = currentUser;
            }

            if (!target) return showCustomAlert('خطأ', 'لم يتم العثور على بيانات الطالب', 'error');

            // Find grades - compatibility check for different data structures
            let grades = {};
            if (target.gradesDetail) {
                // Try to find the subject grades or global grades
                grades = target.gradesDetail[window.gbSubject || 'عام'] || target.gradesDetail;
            } else if (target.grades) {
                grades = target.grades;
            }

            // If it's still an object of subjects, we might need to drill down or flatten
            if (Object.keys(grades).length === 0) {
                return showCustomAlert('تنبيه', 'لا توجد درجات مسجلة لك حالياً في السجل الإلكتروني.', 'info');
            }

            const nameEl = document.getElementById('cert-name');
            const classEl = document.getElementById('cert-class');
            const deptEl = document.getElementById('cert-dept');
            const tbody = document.getElementById('cert-tbody');
            const avgEl = document.getElementById('cert-avg');

            // Set basic info
            document.getElementById('cert-date').innerText = new Date().toLocaleDateString('ar-IQ');
            document.getElementById('cert-ref').innerText = Math.floor(Math.random() * 9000) + 1000;

            nameEl.innerText = target.name || '---';
            classEl.innerText = target.classId || '---';
            deptEl.innerText = target.major || 'قسم عام';

            let html = '', total = 0, count = 0, idx = 1;

            // Iterate through grades
            Object.entries(grades).forEach(([sub, score]) => {
                // Skip non-subject keys if any
                if (typeof score !== 'number' && isNaN(parseInt(score))) return;

                const numScore = parseInt(score) || 0;
                total += numScore; count++;

                html += `<tr>
                    <td>${idx++}</td>
                    <td contenteditable="true" style="text-align:right; font-weight:bold;">${sub}</td>
                    <td contenteditable="true" style="font-size:1.2rem;">${numScore}</td>
                    <td contenteditable="true">${numberToText(numScore)}</td>
                    <td contenteditable="true" style="color: ${numScore >= 50 ? '#2c3e50' : '#e74c3c'}">${numScore >= 50 ? 'ناجح' : 'راسب'}</td>
                </tr>`;
            });

            tbody.innerHTML = html || '<tr><td colspan="5" contenteditable="true">لا توجد بيانات متاحة حالياً</td></tr>';

            const avg = count > 0 ? (total / count).toFixed(1) : 0;
            avgEl.innerText = avg + '%';
            document.getElementById('cert-result-text').innerText = avg >= 50 ? 'ناجح' : 'راسب';

            // IF ADMIN, SHOW EDITOR BEFORE PRINT
            if (currentUser && currentUser.role === 'admin') {
                openCertificateEditor();
            } else {
                setTimeout(() => window.print(), 500);
            }
        }

        function openCertificateEditor() {
            const cert = document.getElementById('certificate-template');
            cert.classList.add('editor-active');

            // Add Toolbar if not exists
            if (!document.querySelector('.cert-editor-controls')) {
                const controls = document.createElement('div');
                controls.className = 'cert-editor-controls';
                controls.innerHTML = `
                    <button class="btn-glow" onclick="finalizeAndPrint()" style="background:#2c3e50; color:#fff; padding:15px; border:none; border-radius:12px; font-weight:bold; width:200px; box-shadow:0 10px 20px rgba(0,0,0,0.2);">
                        <i class="fa-solid fa-print"></i> اعتمد واطبع الآن
                    </button>
                    <button class="btn-glow" onclick="closeCertEditor()" style="background:#333; color:#fff; padding:10px; border:none; border-radius:12px; width:200px;">
                        إغلاق المحرر
                    </button>
                    <div style="background:rgba(0,0,0,0.8); color:#00e5ff; padding:10px; font-size:0.75rem; border-radius:8px; width:200px; text-align:center;">
                        💡 ملاحظة: يمكنك الضغط على أي كتابة في الوثيقة لتعديلها يدوياً قبل الطباعة.
                    </div>
                `;
                document.body.appendChild(controls);
            } else {
                document.querySelector('.cert-editor-controls').style.display = 'flex';
            }
        }

        function finalizeAndPrint() {
            window.print();
        }

        function closeCertEditor() {
            document.getElementById('certificate-template').classList.remove('editor-active');
            const controls = document.querySelector('.cert-editor-controls');
            if (controls) controls.style.display = 'none';
        }

        async function deleteAllStudents() {
            if (!await confirm('هل أنت متأكد من حذف جميع الطلاب؟')) return;
            const confirmation = await prompt("اكتب 'حذف الكل' للتأكيد:");
            if (confirmation !== 'حذف الكل') return;

            firebase.database().ref('users').once('value').then(snap => {
                const users = snap.val() || {};
                const updates = {};
                Object.keys(users).forEach(uid => {
                    if (users[uid].role === 'student') updates[`users/${uid}`] = null;
                });
                return firebase.database().ref().update(updates);
            }).then(() => {
                alert('تم الحذف بنجاح');
                renderAdminLists();
            }).catch(err => alert("خطأ: " + err.message));
        }

        function numberToText(num) {
            if (num >= 90) return "امتياز";
            if (num >= 80) return "جيد جداً";
            if (num >= 70) return "جيد";
            if (num >= 60) return "متوسط";
            if (num >= 50) return "مقبول";
            return "راسب";
        }

        function fetchAndPrintCert(uid) {
            firebase.database().ref('users/' + uid).once('value').then(snap => {
                const s = snap.val();
                if (s) printStudentCertificate(s);
            });
        }
    </script>


    <!-- CUSTOM MODALS CONTAINER -->
    <style>
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            /* Allow interaction when visible */
        }

        /* Ensure it's hidden initially */
        body:not(.modal-open) .custom-modal-overlay {
            display: none;
        }

        .custom-modal {
            background: rgba(20, 20, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #fff;
        }

        .custom-modal h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .custom-modal p {
            color: #aaa;
            margin-bottom: 20px;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .custom-modal input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #111;
            color: #fff;
            margin-bottom: 20px;
            outline: none;
            transition: 0.2s;
        }

        .custom-modal input:focus {
            border-color: #00e676;
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.2);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: 0.2s;
            flex: 1;
        }

        .modal-btn.confirm {
            background: #00e676;
            color: #000;
        }

        .modal-btn.confirm:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.4);
        }

        .modal-btn.cancel {
            background: #333;
            color: #fff;
        }

        .modal-btn.cancel:hover {
            background: #444;
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>

    <!-- ADVANCED ATTENDANCE MODAL (RESTORED) -->
    <div id="attendance-modal" class="dashboard-overlay" style="display:none; z-index:999999;">
        <i class="fa-solid fa-xmark close-dash" onclick="closeAttendanceModal()"
            style="color:white; z-index:1000001; top:20px; left:20px; font-size:2rem; cursor:pointer; position:absolute;"></i>

        <div class="container"
            style="width:95%; height:95%; max-width:1400px; display:flex; gap:20px; padding:20px; background:#111; color:white; border-radius:15px; border:1px solid #333; box-shadow:0 0 50px rgba(0,0,0,0.8);">

            <!-- LEFT PANEL: ABSENTEES SUMMARY -->
            <div
                style="width:300px; background:#1a0505; border:1px solid #ff4444; border-radius:12px; padding:20px; display:flex; flex-direction:column; position:relative;">
                <h3
                    style="color:#ff4444; border-bottom:1px solid #ff4444; padding-bottom:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <span><i class="fa-solid fa-user-xmark"></i> الغائبون</span>
                    <span id="absent-count-badge"
                        style="background:#ff4444; color:white; padding:2px 10px; border-radius:10px; font-size:0.9rem;">0</span>
                </h3>

                <div id="absent-list-container" style="flex:1; overflow-y:auto; text-align:center;">
                    <!-- While empty -->
                    <div id="no-absent-msg" style="margin-top:50px; opacity:0.5;">
                        <i class="fa-solid fa-check-circle"
                            style="font-size:3rem; color:#00c853; margin-bottom:10px;"></i>
                        <p>الجميع حضور</p>
                    </div>
                    <!-- List goes here -->
                    <ul id="absent-names-list" style="list-style:none; padding:0; text-align:right; display:none;">
                    </ul>
                </div>

                <div style="margin-top:auto;">
                    <button class="btn-glow" id="copy-absent-btn" onclick="copyAbsentList()"
                        style="width:100%; background:linear-gradient(45deg, #ff4444, #b71c1c);">
                        <i class="fa-solid fa-copy"></i> نسخ القائمة
                    </button>
                </div>
            </div>

            <!-- RIGHT PANEL: INTERACTIVE STUDENT LIST -->
            <div
                style="flex:1; display:flex; flex-direction:column; background:#1e1e1e; border-radius:12px; border:1px solid #444; overflow:hidden;">
                <!-- Header -->
                <div
                    style="padding:20px; background:#252525; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h2 style="margin:0; color:#00e5ff;">سجل الحضور اليومي</h2>
                        <p style="margin:5px 0 0; color:#aaa; font-size:0.9rem;">اضغط على زر الحالة
                            لتغييرها (حاضر /
                            غائب)</p>
                    </div>
                    <div style="text-align:left;">
                        <div style="font-size:1.2rem; font-weight:bold;" id="att-date-display">
                            --/--/----</div>
                        <div style="color:#00d26a;" id="att-class-display">--</div>
                    </div>
                </div>

                <!-- Scrollable List -->
                <div id="att-students-list" style="flex:1; overflow-y:auto; padding:10px;">
                    <!-- Generated Items -->
                </div>

                <!-- Footer Actions -->
                <div style="padding:20px; background:#252525; border-top:1px solid #444; text-align:center;">
                    <button class="btn-glow" onclick="saveAttendance()"
                        style="width:300px; padding:15px; font-size:1.2rem; background:linear-gradient(90deg, #00c853, #64dd17);">
                        <i class="fa-solid fa-floppy-disk"></i> حفظ واعتماد القائمة
                    </button>
                    <button class="btn-glow" onclick="closeAttendanceModal()"
                        style="background:transparent; border:1px solid #666; margin-right:10px;">
                        إلغاء
                    </button>
                </div>
            </div>

        </div>
    </div>
    <!-- Legacy modals removed -->
    <script>
        // ================== OFFICIAL RESULTS LOGIC ==================
        function toggleResultMode() {
            const single = document.getElementById('res-single-area');
            const bulk = document.getElementById('res-bulk-area');
            const btn = document.getElementById('res-mode-btn');
            if (single.style.display === 'none') {
                single.style.display = 'grid';
                bulk.style.display = 'none';
                btn.innerText = '🔄 وضع الإضافة الجماعية';
            } else {
                single.style.display = 'none';
                bulk.style.display = 'block';
                btn.innerText = '🔄 وضع الإضافة المنفردة';
            }
        }

        function addResultLink() {
            const title = document.getElementById('res-title').value.trim();
            const url = document.getElementById('res-url').value.trim();
            if (!title || !url) return alert("يرجى ملء كافة الحقول");
            saveResultToDB(title, url);
            document.getElementById('res-title').value = '';
            document.getElementById('res-url').value = '';
            alert("✅ تم نشر رابط النتيجة بنجاح!");
        }

        function addResultsBulk() {
            const text = document.getElementById('res-bulk-input').value.trim();
            if (!text) return alert("يرجى لصق البيانات أولاً");
            const lines = text.split('\n');
            let count = 0;
            lines.forEach(line => {
                const parts = line.split('|');
                if (parts.length >= 2) {
                    const title = parts[0].trim();
                    const url = parts[1].trim();
                    if (title && url) {
                        saveResultToDB(title, url);
                        count++;
                    }
                }
            });
            if (count > 0) {
                alert(`✅ تم بنجاح إضافة ${count} نتيجة في السحابة!`);
                document.getElementById('res-bulk-input').value = '';
                toggleResultMode(); // Back to single
            } else {
                alert("❌ لم يتم العثور على بيانات صالحة. يرجى استخدام التنسيق: الاسم | الرابط");
            }
        }

        function saveResultToDB(title, url) {
            const rid = 'res_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            firebase.database().ref('schoolDB/results/' + rid).set({
                title: title,
                url: url,
                date: new Date().toISOString()
            }).catch(err => {
                console.error("Firebase Error:", err);
                if (err.message.includes('permission_denied')) {
                    alert("⚠️ خطأ في الصلاحيات: قاعدة البيانات مغلقة حالياً ولا تسمح بالنشر. يرجى مراجعة إعدادات Firebase Rules.");
                } else {
                    alert("❌ فشل النشر: " + err.message);
                }
            });
        }

        async function deleteResultLink(rid) {
            if (await confirm("هل تريد حذف هذا الرابط؟")) {
                firebase.database().ref('schoolDB/results/' + rid).remove();
            }
        }

        // ================== TEACHER UPLOAD CENTER LOGIC ==================
        function saveTeacherUpload() {
            const title = document.getElementById('upload-title').value;
            const link = document.getElementById('upload-link').value;

            if (!title || !link) return alert("يرجى إدخال العنوان والرابط");
            if (!currentUser) return alert("يرجى تسجيل الدخول");

            const uploadData = {
                title: title,
                link: link,
                by: currentUser.name || 'Unknown',
                uid: currentUser.uid || 'unknown',
                date: new Date().toISOString(),
                type: 'general'
            };

            firebase.database().ref('schoolDB/uploads').push(uploadData).then(() => {
                alert("✅ تم النشر بنجاح!");
                document.getElementById('upload-title').value = '';
                document.getElementById('upload-link').value = '';
                loadTeacherUploads(); // Refresh list
            }).catch(err => alert("حدث خطأ: " + err.message));
        }

        function loadTeacherUploads() {
            const list = document.getElementById('teacher-recent-uploads');
            if (!list) return;

            // Switch to Realtime Listener to ensure updates appear instantly
            firebase.database().ref('schoolDB/uploads').limitToLast(20).on('value', snap => {
                const data = snap.val();
                if (!data) {
                    list.innerHTML = '<li style="color:#aaa;">لا توجد ملفات مرفوعة بعد.</li>';
                    return;
                }

                let html = '';
                // Convert to array and reverse to show newest first
                const arr = [];
                Object.keys(data).forEach(k => arr.push({ id: k, ...data[k] }));

                // Sort by Date Descending (Newest First)
                arr.sort((a, b) => new Date(b.date) - new Date(a.date));

                arr.forEach(item => {
                    const date = new Date(item.date).toLocaleDateString('ar-IQ');
                    html += `<li
        style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid rgba(255,255,255,0.05);">
        <span>
            <i class="fa-solid fa-file-lines" style="color:var(--primary); margin-left:5px;"></i>
            <a href="${item.link}" target="_blank" style="color:#fff; text-decoration:none;">${item.title}</a>
            <small style="color:#777; margin-right:10px;">(${date})</small>
        </span>
        <button onclick="deleteUpload('${item.id}')"
            style="background:none; border:none; color:#ff4444; cursor:pointer;" title="حذف"><i
                class="fa-solid fa-trash"></i></button>
    </li>`;
                });
                list.innerHTML = html;
            });
        }

        async function deleteUpload(id) {
            if (await confirm("هل أنت متأكد من حذف هذا الملف؟")) {
                firebase.database().ref('schoolDB/uploads/' + id).remove()
                    .then(() => loadTeacherUploads());
            }
        }

        function toggleBulkUploadMode() {
            alert("✨ ميزة الإضافة الجماعية ستتوفر قريباً!");
        }

        function renderAdminResults(results) {
            const container = document.getElementById('admin-results-table');
            if (!container) return;

            if (!results) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align:center; padding:40px; color:#aaa; border:1px dashed #333; border-radius:15px;">لا توجد ملفات مرفوعة حالياً. استخدم النموذج أعلاه للنشر.</div>';
                return;
            }

            let html = '';
            Object.keys(results).reverse().forEach(rid => {
                const r = results[rid];
                // Matching the User's Image Aesthetic
                html += `
    <div class="glass-panel"
        style="padding:20px; border:1px solid rgba(255,255,255,0.1); background: rgba(10,10,20,0.6); position:relative;">
        <div
            style="background: linear-gradient(135deg, var(--primary), var(--secondary)); width:100%; border-radius:12px; height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);">
            <i class="fa-solid fa-file-pdf" style="font-size:2.5rem; color:#000;"></i>
            <div style="font-weight:bold; color:#000; margin-top:5px; font-size:0.9rem;">النتائج</div>
        </div>
        <h4 style="color:#fff; margin-bottom:5px;">${r.title}</h4>
        <p style="color:#777; font-size:0.75rem; margin-bottom:15px;">تاريخ النشر: ${new
                        Date(r.date).toLocaleDateString('ar-EG')}</p>

        <div style="display:flex; gap:10px;">
            <button class="btn-glow"
                style="flex:1; padding:5px 0; font-size:0.8rem; background:var(--primary); color:#000;"
                onclick="window.open('${r.url}', '_blank')">🔗 فتح</button>
            <button class="btn-glow"
                style="flex:1; padding:5px 0; font-size:0.8rem; background:#ff4444; border-color:#cc0000;"
                onclick="deleteResultLink('${rid}')">🗑️ حذف</button>
        </div>
    </div>`;
            });
            container.innerHTML = html;
        }

        function renderStudentResults(results) {
            const container = document.getElementById('std-results-links');
            if (!container) return;

            if (!results) {
                container.innerHTML = '<div style="color:#777; text-align:center; padding:10px;">لا توجد كشوفات مرفوعة حالياً في مركز التحميل</div>';
                return;
            }

            let html = '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:10px;">';
            Object.keys(results).reverse().forEach(rid => {
                const r = results[rid];
                html += `
        <div class="glass-panel"
            style="padding:15px; text-align:center; border:1px solid rgba(255,255,255,0.05); transition:0.3s; display:flex; flex-direction:column; justify-content:space-between;">

            <div style="cursor:pointer;" onclick="window.open('${r.url}', '_blank')">
                <div
                    style="background: linear-gradient(135deg, var(--primary), var(--secondary)); width:100%; border-radius:10px; height:80px; display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:10px;">
                    <i class="fa-solid fa-file-pdf" style="font-size:2rem; color:#000;"></i>
                    <div style="font-weight:bold; color:#000; margin-top:3px; font-size:0.8rem;">النتائج</div>
                </div>
                <div
                    style="font-weight:bold; color:#fff; font-size:0.9rem; margin-bottom:5px; min-height:40px; display:flex; align-items:center; justify-content:center;">
                    ${r.title}</div>
                <div style="font-size:0.7rem; color:#777; margin-bottom:10px;">${new
                        Date(r.date).toLocaleDateString('ar-EG')}</div>
            </div>

            <div style="display:flex; gap:5px; margin-top:auto;">
                <a href="${r.url}" target="_blank" class="btn-glow"
                    style="flex:1; padding:8px 0; font-size:0.8rem; background:rgba(255,255,255,0.1); text-decoration:none; color:white; border-radius:5px;">
                    <i class="fa-solid fa-eye"></i> عرض
                </a>
            </div>
        </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Real-time listener for results
        if (typeof firebase !== 'undefined' && firebase.apps.length) {
            firebase.database().ref('schoolDB/results').on('value', snap => {
                const data = snap.val();
                renderAdminResults(data);
                renderStudentResults(data);
            });

            // Listen for News Ticker
            firebase.database().ref('schoolDB/news').on('value', snap => {
                const news = snap.val();
                const ticker = document.getElementById('dynamic-ticker-content');
                if (ticker && news) {
                    ticker.innerHTML = `<div class="ticker-item"><i class="fa-solid fa-bullhorn"></i> ${news}</div>`;
                }
            });

            // Listen for Site Settings
            firebase.database().ref('schoolDB/settings').on('value', snap => {
                const s = snap.val();
                if (!s) return;

                // Frontpage Update
                const heroTitle = document.querySelector('#hero .glitch-text');
                const heroDesc = document.querySelector('#hero p');
                const phoneEl = document.querySelector('#contact .vision-card:nth-child(2) p');

                // Social Media Update
                const fbLink = document.querySelector('.fa-facebook') ? document.querySelector('.fa-facebook').closest('a') : null;
                const tgLink = document.querySelector('.fa-telegram') ? document.querySelector('.fa-telegram').closest('a') : null;
                const waLink = document.querySelector('.fa-whatsapp') ? document.querySelector('.fa-whatsapp').closest('a') : null;
                const ytLink = document.querySelector('.fa-youtube') ? document.querySelector('.fa-youtube').closest('a') : null;

                if (heroTitle && s.heroTitle) {
                    heroTitle.innerHTML = `${s.heroTitle}<br><span style="color: var(--primary);">${s.heroSlogan || ''}</span>`;
                    heroTitle.setAttribute('data-text', s.heroTitle);
                }
                if (heroDesc && s.heroDesc) heroDesc.innerText = s.heroDesc;
                if (phoneEl && s.phone) phoneEl.innerText = s.phone;

                // Update Social Links visible in Footer
                if (fbLink) fbLink.href = s.socialFb || '#';
                if (tgLink) tgLink.href = s.socialTg || '#';
                if (waLink) waLink.href = s.socialWa || '#';
                if (ytLink) ytLink.href = s.socialYt || '#';

                // Admin Inputs Sync
                const inpTitle = document.getElementById('setting-hero-title');
                const inpSlogan = document.getElementById('setting-hero-slogan');
                const inpDesc = document.getElementById('setting-hero-desc');
                const inpPhone = document.getElementById('setting-school-phone');

                // Social Inputs Sync
                const inpFb = document.getElementById('setting-social-fb');
                const inpTg = document.getElementById('setting-social-tg');
                const inpWa = document.getElementById('setting-social-wa');
                const inpYt = document.getElementById('setting-social-yt');

                if (inpTitle) inpTitle.value = s.heroTitle || '';
                if (inpSlogan) inpSlogan.value = s.heroSlogan || '';
                if (inpDesc) inpDesc.value = s.heroDesc || '';
                if (inpPhone) inpPhone.value = s.phone || '';

                if (inpFb) inpFb.value = s.socialFb || '';
                if (inpTg) inpTg.value = s.socialTg || '';
                if (inpWa) inpWa.value = s.socialWa || '';
                if (inpYt) inpYt.value = s.socialYt || '';
            });
        }

        function saveSiteSettings() {
            const data = {
                heroTitle: document.getElementById('setting-hero-title').value,
                heroSlogan: document.getElementById('setting-hero-slogan').value,
                heroDesc: document.getElementById('setting-hero-desc').value,
                logoUrl: document.getElementById('setting-school-logo').value,
                phone: document.getElementById('setting-school-phone').value,
                socialFb: document.getElementById('setting-social-fb').value,
                socialTg: document.getElementById('setting-social-tg').value,
                socialWa: document.getElementById('setting-social-wa').value,
                socialYt: document.getElementById('setting-social-yt').value
            };

            firebase.database().ref('schoolDB/settings').set(data).then(() => {
                alert("✅ تم حفظ إعدادات الموقع وتحديث الواجهة بنجاح!");
            }).catch(err => alert("خطأ في الحفظ: " + err.message));
        }

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                if (window.animationID) cancelAnimationFrame(window.animationID);
            } else {
                if (typeof animateParticles === 'function') animateParticles();
            }
        });
    </script>





</body>

</html>